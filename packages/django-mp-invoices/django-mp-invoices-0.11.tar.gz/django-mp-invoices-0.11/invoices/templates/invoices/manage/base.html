
{% extends 'accounting.html' %}

{% load i18n static notify categories widget_tweaks %}


{% block bodyclass %}{{ block.super }} hidden-breadcrumbs{% endblock %}


{% block title %}
    {{ invoice.model_name }} #{{ invoice.id }}
{% endblock %}


{% block content %}
    {{ block.super }}

    <h4>
        {{ invoice.model_name }} #{{ invoice.id }}
        <small>({{ invoice.get_type_display }})</small>
        <span class="pull-right">
            <i class="fa fa-clock-o"></i> {{ invoice.created|date:'d.m.Y' }}
        </span>
    </h4>

    <div class="row">
        <div class="col-md-3">
            {{ customer_select_form.customer|add_class:'invoice-customer-select' }}
        </div>
        <div class="col-md-9">
            <a href="{{ invoice.print_url }}"
               target="blank"
               class="btn btn-primary btn-sm pull-right">
                <i class="fa fa-print"></i> {% trans 'Print' %}
            </a>
        </div>
    </div>

    <hr />

    <div data-role="products-section">
        {% include 'invoices/product-select-list.html' %}

        <table class="table table-bordered table-sm m-t-20" data-role="product-invoice-list">
            <thead>
                <tr>
                    <th>
                        {% trans 'Code' %}
                    </th>
                    <th>
                        {% trans 'Product' %}
                        [
                            <a href="javascript:void(0)"
                               data-role="add-product"
                               data-url="{% url 'invoices:add-product' %}">
                                {% trans 'Add' %}
                            </a>
                        ]
                    </th>
                    <th class="text-center" width="100">
                        {% trans 'Quantity' %}
                    </th>
                    <th class="text-center" width="150">
                        {% trans 'Price' %}
                    </th>
                    <th width="50"></th>
                </tr>
            </thead>
            <tbody data-role="list-items">
                {% for item in invoice.get_items %}
                    {{ item.render }}
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" class="text-right">
                        <b>{% trans 'Total without discount' %}:</b>
                    </td>
                    <td colspan="2" data-role="grand_total" class="text-right">
                        {{ invoice.total }}
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="text-right">
                        <b>{% trans 'Discount' %}:</b>
                    </td>
                    <td>
                        <span data-role="discount_percentage">
                            <input data-role="discount-input"
                                   style="width: 50px"
                                   type="text"
                                   data-url="{{ invoice.set_discount_url }}"
                                   value="{{ invoice.discount }}">
                        </span>%
                    </td>
                    <td class="text-right" data-role="discounted_total" >
                        {{ invoice.discounted_total }}
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="2" class="text-right">
                        <b>{% trans 'Total' %}:</b>
                    </td>
                    <td colspan="2" data-role="total_with_discount" class="text-right">
                        {{ invoice.total_with_discount }}
                    </td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
{% endblock %}


{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'invoices/invoices.css' %}" />
    <link rel="stylesheet" href="{% static 'invoices/select2/select2.css' %}" />
{% endblock %}


{% block js %}

    {{ block.super }}

    {% notify_js %}

    <script src="{% static 'deleteaction.js' %}"></script>
    <script src="{% static 'cellinput.js' %}"></script>
    <script src="{% static 'list.js' %}"></script>
    <script src="{% static 'modal.js' %}"></script>

    <script src="{% static 'invoices/select2/select2.js' %}"></script>
    <script src="{% static 'invoices/select2/i18n/uk.js' %}"></script>

    <script src="{% static 'invoices/jquery.scannerdetection.js' %}"></script>
    <script src="{% static 'invoices/SelectProductList.js' %}"></script>
    <script src="{% static 'invoices/InvoiceList.js' %}"></script>
    <script src="{% static 'invoices/InvoiceTotal.js' %}"></script>
    <script src="{% static 'invoices/CategoryTree.js' %}"></script>
    <script src="{% static 'invoices/CustomerSelect.js' %}"></script>

    <script src="{% static 'invoices/SelectServiceItemList.js' %}"></script>

    <script>
        (function ($) {

            {% get_categories as product_categories %}

            var $productList = $('[data-role=product-list]');

            new CategoryTree({
                $container: $('[data-role=products-section]'),
                data: [
                    {% for c in product_categories %}
                        {
                            text: "{{ c.name|escapejs }}",
                            id: {{ c.id }}
                        },
                    {% endfor %}
                ]
            });

            new List({
                $container: $productList,
                url: '{% url 'invoices:products' %}'
            });

            new SelectProductList({
                $container: $productList
            });

            new InvoiceList({
                $container: $('[data-role=product-invoice-list]'),
                addItemUrl: '{{ invoice.add_item_url }}',
                target: 'product'
            });

            new CustomerSelect({
                $field: $('#{{ customer_select_form.customer.auto_id }}'),
                url: '{{ invoice.set_customer_url }}'
            });

            new Modal({
                $target: $('[data-role=add-product]'),
                focusOn: '[name=category]',
                onSuccess: function (response) {
                    $(window).trigger('product-selected', [response.product_id]);
                }
            });

            $('body').scannerDetection({
                onComplete: function () {
                    console.log(arguments);
                }
            });
        })(jQuery);
    </script>
{% endblock %}
