import e from"rete";import t from"rete-vue-render-plugin";import o from"rete-connection-plugin";import s from"rete-comment-plugin";import n from"rete-area-plugin";import i from"rete-history-plugin";import a from"rete-connection-mastery-plugin";import r from"rete-keyboard-plugin";import l from"rete-minimap-plugin";import d from"rete-auto-arrange-plugin";import c from"rete-vue-render-plugin/src/mixin";import{getObjectValueByPath as u}from"vuetify/lib/util/helpers";import{PerfectScrollbar as h}from"vue2-perfect-scrollbar";import p from"vuedraggable";import m from"vue";import v from"@koumoul/vjsf";import"@koumoul/vjsf/dist/main.css";var g={props:["readonly","emitter","ikey","getData","putData","possibleValues","selectedValues"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{ikey}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-select \n            solo \n            flat\n            v-model="selectedValues" \n            :items="possibleValues" \n            @input="change($event)" \n            @dblclick.stop="" \n            @pointermove.stop=""></v-select>\n        </v-col>\n      </v-layout>',data:()=>({value:0,model:""}),methods:{change(e){this.update()},update(){this.ikey&&this.putData(this.ikey,this.model),this.emitter.trigger("process")}},mounted(){this.model=this.selectedValues,void 0!==this.getData(this.ikey)&&(this.model=this.getData(this.ikey)),this.update()}};class f extends e.Control{constructor(e,t,o,s,n){super(t),this.component=g,this.props={emitter:e,ikey:t,readonly:n,possibleValues:s,selectedValues:o}}setValue(e){this.vueContext.value=e}}const _=new e.Socket("timeseries"),y=new e.Socket("dataframe"),b=new e.Socket("Integer value"),k=new e.Socket("Number value"),w=new e.Socket("Timeseries"),C=new e.Socket("Any");_.combineWith(C),y.combineWith(C),b.combineWith(C),k.combineWith(C),w.combineWith(C),C.combineWith(C);var x={props:["emitter","ikey","getData","putData","default","node"],template:'\n    <v-layout row wrap style="width:700px; height:50px">\n        <v-col cols=3>\n        <v-combobox\n          @change=\'change\'\n          v-model="itemsChosen"\n          :items="items"\n          label="Aggregation method"\n          multiple\n          solo\n          flat\n          width="auto"\n        ></v-combobox>\n        </v-col>\n        <v-col cols=2>\n            <v-text-field \n            @change=\'change\'\n            v-model="periodLength"\n            solo \n            flat/>\n        </v-col>\n        <v-col cols=3>\n        <v-combobox\n          @change=\'change\'\n          width="auto"\n          v-model="periodChosen"\n          :items="period"\n          label="Time resolution"\n          solo \n          flat\n        ></v-combobox>\n        </v-col>\n        <v-col>\n        <v-btn small color="green" @click="add($event)" @dblclick.stop="">Add</v-btn>\n        <v-btn small color="red" @click="remove($event)" @dblclick.stop="">Delete</v-btn>\n        </v-col>\n    </v-layout>\n    ',data:()=>({value:"",title:"",items:["count","sum","mean","median","var","std","min","max","skew","kurt"],itemsChosen:[],period:["seconds","minutes","hours","days"],periodChosen:void 0,controls:[],periodLength:0}),methods:{change(e){this.update()},update(){console.log("change"),this.ikey&&this.putData(this.ikey,{itemsChosen:this.itemsChosen,periodChosen:this.periodChosen,periodLength:this.periodLength}),this.emitter.editor.trigger("process")},add(){this.emitter.add()},remove(){this.emitter.remove(this.ikey)}},mounted(){this.value=this.default,this.title=this.caption,this.update()}};class S extends e.Control{constructor(e,t){super(t),this.component=x,this.props={emitter:e,ikey:t,caption:t}}setValue(e){this.vueContext.value=e}}class N extends e.Component{constructor(){super("RollingAggregation"),this.className="RollingAggregation",this.humanModule="fathom_lib.transformers.rolling_aggregation",this.pyModule="fathom_lib.transformers.rolling_aggregation",this.controls={},this.node=void 0}builder(t){return this.node=t,t.addControl(new f(this.editor,"timestamp",null,[],!1)),t.addControl(new f(this.editor,"id",null,[],!1)),t.addInput(new e.Input("default","",C,!0)),t.addOutput(new e.Output("default","",C,!0)),this.add(),t.className=this.className,t.humanModule=this.humanModule,t.pyModule=this.pyModule,t.is_dataframe=!1,this.node}add(){var e=Object.keys(this.controls).length,t=new S(this,"aggregation"+e);this.controls[e]=t,this.node.addControl(t),this.editor.trigger("process"),this.node.update()}remove(e){this.node.controls.delete(e),this.node.update(),this.editor.trigger("process")}}var E={props:["readonly","emitter","ikey","getData","putData","default","caption"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{title}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-text-field solo flat :title="title" :value="value" @input="change($event)" :readonly="readonly" @dblclick.stop="" @pointerdown.stop="" @pointermove.stop="" ></v-text-field>\n        </v-col>\n    </v-layout>',data:()=>({value:"",title:""}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.value=this.default,this.title=this.caption,this.update()}};class D extends e.Control{constructor(e,t,o,s){super(t),this.component=E,this.props={emitter:e,ikey:t,readonly:s,default:o,caption:t}}setValue(e){this.vueContext.value=e}}class O extends e.Component{constructor(e){super("DynamicDataFrame"),this.className="DataFrame",this.humanModule="fathom_lib.datasources",this.pyModule="fathom_lib.datasources",this.name=e.name,this.schema=JSON.parse(e.schema_json)}builder(t){let o=this.schema.fields.map((e=>e.name));return t.addControl(new f(this.editor,"X_columns",o,o,!1)),t.addControl(new f(this.editor,"y_columns",[],o,!1)),t.addControl(new f(this.editor,"additional_columns",[],o,!1)),t.addOutput(new e.Output("default","",C)),t.className=this.className,t.humanModule=this.humanModule,t.pyModule=this.pyModule,t.schema_json=this.schema.fields,t.is_dataframe=!0,t}}var M={props:["readonly","emitter","ikey","getData","putData","default","caption"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{title}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-checkbox dense shaped dark  v-model="value" @input="change($event)" @dblclick.stop="" @pointermove.stop=""></v-checkbox>\n        </v-col>\n       </v-layout>',data:()=>({value:"",title:""}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.value=this.default,this.title=this.caption,this.update()}};class j extends e.Control{constructor(e,t,o,s){super(t),this.component=M,this.props={emitter:e,ikey:t,readonly:s,default:o,caption:t}}setValue(e){this.vueContext.value=e}}var $={props:["readonly","emitter","ikey","getData","putData","value"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{ikey}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-text-field type="number" step="any" solo flat :value="value" @input="change($event)" @dblclick.stop="" @pointermove.stop=""></v-text-field>\n        </v-col>\n      </v-layout>',data:()=>({}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.update()}};class R extends e.Control{constructor(e,t,o,s){super(t),this.component=$,this.props={emitter:e,ikey:t,readonly:s,value:o}}setValue(e){this.vueContext.value=e}}var A={props:["readonly","emitter","ikey","getData","putData","value"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{ikey}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-text-field type="number" pattern="[0-9]" step="1" solo flat :value="value" @input="change($event)" @dblclick.stop="" @pointermove.stop=""></v-text-field>\n        </v-col>\n      </v-layout>',data:()=>({}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.update()}};class P extends e.Control{constructor(e,t,o,s){super(t),this.component=A,this.props={emitter:e,ikey:t,readonly:s,value:o}}setValue(e){this.vueContext.value=e}}class X extends e.Component{constructor(e){super("DynamicComponent"),this.className=e.name,this.name=e.js_name,this.humanModule=e.human_module,this.pyModule=e.py_module,this.params=e.params,this.input_list=e.input_list,this.output_list=e.output_list}builder(t){return Object.keys(this.params).forEach((e=>{let o=this.params[e],s="float"==(n=null!=o.types[0]?o.types[0]:null)?R:"bool"==n?j:"int"==n?P:"string"==n?D:null==n?f:D;var n;s==f?t.addControl(new s(this.editor,o.name,o.default,o.choices,!1)):t.addControl(new s(this.editor,o.name,o.default,!1))})),t.addInput(new e.Input("default","",C,!0)),t.addOutput(new e.Output("default","",C,!0)),t.className=this.className,t.humanModule=this.humanModule,t.pyModule=this.pyModule,t.is_dataframe=!1,t}}function F(e,t,o,s,n,i,a,r,l,d){"boolean"!=typeof a&&(l=r,r=a,a=!1);const c="function"==typeof o?o.options:o;let u;if(e&&e.render&&(c.render=e.render,c.staticRenderFns=e.staticRenderFns,c._compiled=!0,n&&(c.functional=!0)),s&&(c._scopeId=s),i?(u=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,l(e)),e&&e._registeredComponents&&e._registeredComponents.add(i)},c._ssrRegister=u):t&&(u=a?function(e){t.call(this,d(e,this.$root.$options.shadowRoot))}:function(e){t.call(this,r(e))}),u)if(c.functional){const e=c.render;c.render=function(t,o){return u.call(o),e(t,o)}}else{const e=c.beforeCreate;c.beforeCreate=e?[].concat(e,u):[u]}return o}const G="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());function V(e){return(e,t)=>function(e,t){const o=G?t.media||"default":e,s=T[o]||(T[o]={ids:new Set,styles:[]});if(!s.ids.has(e)){s.ids.add(e);let o=t.source;if(t.map&&(o+="\n/*# sourceURL="+t.map.sources[0]+" */",o+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t.map))))+" */"),s.element||(s.element=document.createElement("style"),s.element.type="text/css",t.media&&s.element.setAttribute("media",t.media),void 0===J&&(J=document.head||document.getElementsByTagName("head")[0]),J.appendChild(s.element)),"styleSheet"in s.element)s.styles.push(o),s.element.styleSheet.cssText=s.styles.filter(Boolean).join("\n");else{const e=s.ids.size-1,t=document.createTextNode(o),n=s.element.childNodes;n[e]&&s.element.removeChild(n[e]),n.length?s.element.insertBefore(t,n[e]):s.element.appendChild(t)}}}(e,t)}let J;const T={};const L=F({render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"node",class:e._f("kebab")([e.selected(),e.node.name,e.getNodeClass()]),attrs:{id:e.node.id}},[o("v-sheet",{staticClass:"pa-4",attrs:{color:"rgba(36, 184, 208, 0)"}},[o("div",{attrs:{id:"title-wrapper"}},[o("div",{staticClass:"left"},[o("div",{staticClass:"title"},[e._v(e._s(e.node.name)+" "),o("span",{staticClass:"progress"})])]),e._v(" "),o("div",{staticClass:"right"},["start"===e.status?o("div",[o("v-progress-circular",{attrs:{color:"white",indeterminate:""}})],1):o("div",{staticClass:"right"},[o("v-icon",{attrs:{color:e.statusColor}},[e._v("mdi-checkbox-blank-circle")])],1)])]),e._v(" "),""!==e.errorMessage?o("v-alert",{staticClass:"alertmessage",attrs:{"max-width":"300px",type:"error"}},[e._v(e._s(e.errorMessage))]):e._e()],1),e._v(" "),e._l(e.outputs(),(function(t){return o("div",{staticClass:"output"},[o("div",{staticClass:"output-title"},[e._v(e._s(t.name))]),e._v(" "),o("Socket",{directives:[{name:"socket",rawName:"v-socket:output",value:t,expression:"output",arg:"output"}],attrs:{type:"output",socket:t.socket}})],1)})),e._v(" "),e._l(e.controls(),(function(e){return o("div",{directives:[{name:"control",rawName:"v-control",value:e,expression:"control"}],staticClass:"control",staticStyle:{display:"none"}})})),e._v(" "),e._l(e.inputs(),(function(t){return o("div",{staticClass:"input"},[o("Socket",{directives:[{name:"socket",rawName:"v-socket:input",value:t,expression:"input",arg:"input"}],attrs:{type:"input",socket:t.socket}}),e._v(" "),o("div",{directives:[{name:"show",rawName:"v-show",value:!t.showControl(),expression:"!input.showControl()"}],staticClass:"input-title"},[e._v(e._s(t.name))]),e._v(" "),o("div",{directives:[{name:"show",rawName:"v-show",value:t.showControl(),expression:"input.showControl()"},{name:"control",rawName:"v-control",value:t.control,expression:"input.control"}],staticClass:"input-control"})],1)}))],2)},staticRenderFns:[]},undefined,{mixins:[c],props:[status],components:{Socket:F({render:function(){var e=this,t=e.$createElement;return(e._self._c||t)("div",{staticClass:"socket",class:e._f("kebab")([e.type,e.socket.name]),attrs:{title:e.socket.name}})},staticRenderFns:[]},(function(e){e&&e("data-v-0dd0170d_0",{source:".socket[data-v-0dd0170d]{display:inline-block;cursor:pointer;border:1px solid #fff;border-radius:12px;width:24px;height:24px;margin:6px;vertical-align:middle;background:#96b38a;z-index:2;box-sizing:border-box}.socket[data-v-0dd0170d]:hover{border-width:4px}.socket.multiple[data-v-0dd0170d]{border-color:#ff0}.socket.output[data-v-0dd0170d]{margin-right:-12px}.socket.input[data-v-0dd0170d]{margin-left:-12px}",map:void 0,media:void 0})}),{props:["type","socket"]},"data-v-0dd0170d",false,undefined,!1,V,void 0,void 0)},data:function(){return{status:"waiting",errorMessage:""}},computed:{statusColor:function(){return"end"===this.status?"green":"error"===this.status||"failed"==this.status?"red":"grey"}},methods:{getNodeClass:()=>"default-node-color",setStatus(e){this.status=e},setMessage(e){this.errorMessage=e}}},"data-v-fc06b154",false,undefined,!1,void 0,void 0,void 0);const I=F({render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",[o("v-text-field",{attrs:{label:"Search",flat:"","hide-details":"",clearable:"","clear-icon":"mdi-close-circle-outline"},on:{"click:clear":function(t){return e.componentsInputClear()}},model:{value:e.search,callback:function(t){e.search=t},expression:"search"}}),e._v(" "),o("v-checkbox",{staticClass:"mb-5",attrs:{"hide-details":"",label:"Case sensitive"},model:{value:e.caseSensitive,callback:function(t){e.caseSensitive=t},expression:"caseSensitive"}}),e._v(" "),o("perfect-scrollbar",[o("v-treeview",{ref:"treeview",staticClass:"components-tree-view",attrs:{"item-key":"name","open-on-click":!0,items:e.items,search:e.search,filter:e.filter,open:e.open,active:e.active,activatable:"","return-object":""},on:{"update:open":function(t){e.open=t},"update:active":function(t){e.active=t}},scopedSlots:e._u([{key:"prepend",fn:function(t){return[t.item.children?o("v-icon",{domProps:{textContent:e._s("mdi-folder-network")}}):e._e()]}}])})],1)],1)},staticRenderFns:[]},(function(e){e&&e("data-v-16681e6a_0",{source:".ps{overflow:hidden!important;overflow-anchor:none;-ms-overflow-style:none;touch-action:auto;-ms-touch-action:auto}.ps__rail-x{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;height:15px;bottom:0;position:absolute}.ps__rail-y{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;width:15px;right:0;position:absolute}.ps--active-x>.ps__rail-x,.ps--active-y>.ps__rail-y{display:block;background-color:transparent}.ps--focus>.ps__rail-x,.ps--focus>.ps__rail-y,.ps--scrolling-x>.ps__rail-x,.ps--scrolling-y>.ps__rail-y,.ps:hover>.ps__rail-x,.ps:hover>.ps__rail-y{opacity:.6}.ps .ps__rail-x.ps--clicking,.ps .ps__rail-x:focus,.ps .ps__rail-x:hover,.ps .ps__rail-y.ps--clicking,.ps .ps__rail-y:focus,.ps .ps__rail-y:hover{background-color:#eee;opacity:.9}.ps__thumb-x{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,height .2s ease-in-out;-webkit-transition:background-color .2s linear,height .2s ease-in-out;height:6px;bottom:2px;position:absolute}.ps__thumb-y{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,width .2s ease-in-out;-webkit-transition:background-color .2s linear,width .2s ease-in-out;width:6px;right:2px;position:absolute}.ps__rail-x.ps--clicking .ps__thumb-x,.ps__rail-x:focus>.ps__thumb-x,.ps__rail-x:hover>.ps__thumb-x{background-color:#999;height:11px}.ps__rail-y.ps--clicking .ps__thumb-y,.ps__rail-y:focus>.ps__thumb-y,.ps__rail-y:hover>.ps__thumb-y{background-color:#999;width:11px}@supports (-ms-overflow-style:none){.ps{overflow:auto!important}}@media screen and (-ms-high-contrast:active),(-ms-high-contrast:none){.ps{overflow:auto!important}}.ps{position:relative}",map:void 0,media:void 0})}),{props:["items"],components:{PerfectScrollbar:h},methods:{componentsInputClear:function(){this.$refs.treeview.updateAll(!1)},onItemClick(e){this.$emit("itemClicked",e)}},watch:{active:function(){this.active.length>0&&(this.onItemClick(this.active[0]),this.active=[])},search:function(){this.search&&this.search.length>3?this.$refs.treeview.updateFoundNodes(!0):this.$refs.treeview.updateFoundNodes(!1)}},computed:{filter(){return this.caseSensitive?(e,t,o)=>e[o].indexOf(t)>-1:void 0}},mounted:function(){this.$refs.treeview.updateFoundNodes=e=>{let t=this.$refs.treeview.nodes,o=Object.keys(t);o=o.filter((e=>!this.$refs.treeview.excludedItems.has(e))),o.forEach((o=>this.$refs.treeview.updateOpen(u(t[o].item,this.$refs.treeview.itemKey),e))),this.$refs.treeview.emitOpen()}},data:function(){return{search:null,caseSensitive:!1,active:[],open:[]}}},undefined,false,undefined,!1,V,void 0,void 0);var W={props:["node"],components:{NodeControlPanelForm:F({render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("v-card",{staticClass:"pa-3"},[o("v-form",{ref:"form",model:{value:e.valid,callback:function(t){e.valid=t},expression:"valid"}},[o("v-jsf",{attrs:{schema:e.vjsfSchema,options:e.options},on:{change:e.changeForm},model:{value:e.controls,callback:function(t){e.controls=t},expression:"controls"}},[e._l(e.errorMessagesDict,(function(t,s){return o("template",{slot:s+"-after"},[o("span",{key:s,style:{color:e.$vuetify.theme.themes.light.fathomRed}},[e._v(e._s(e.errorMessagesDict[s]))])])}))],2)],1)],1)},staticRenderFns:[]},undefined,{extends:F({render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("v-card",[o("v-card-title",[e._v(e._s(e.formName))]),e._v(" "),o("v-card-text",[o("v-container",{attrs:{fluid:""}},[e.errorMessages?o("v-card",{staticClass:"errors",style:{color:e.$vuetify.theme.themes.light.fathomWhite},attrs:{color:"fathomRed",type:"error"}},[o("v-card-title",[e._v("\n          Validation errors\n        ")]),e._v(" "),o("v-card-subtitle",{style:{color:e.$vuetify.theme.themes.light.fathomWhite}},[e._v("\n          See details below\n        ")])],1):e._e(),e._v(" "),o("v-form",{ref:"form",model:{value:e.valid,callback:function(t){e.valid=t},expression:"valid"}},[o("v-jsf",{attrs:{schema:e.vjsfSchema,options:e.options},model:{value:e.model,callback:function(t){e.model=t},expression:"model"}},[e._l(e.errorMessagesDict,(function(t,s){return o("template",{slot:s+"-after"},[o("span",{key:s,style:{color:e.$vuetify.theme.themes.light.fathomRed}},[e._v(e._s(e.errorMessagesDict[s]))])])}))],2)],1)],1)],1),e._v(" "),o("v-card-actions",[o("v-spacer"),e._v(" "),o("v-btn",{attrs:{color:"primary",text:""},on:{click:e.cancel}},[e._v("Close")]),e._v(" "),o("v-btn",{attrs:{color:"primary",text:""},on:{click:e.save}},[e._v("Save")])],1)],1)},staticRenderFns:[]},undefined,m.extend({props:["id","formName","schema","url","order"],created:function(){this.initData()},mounted:function(){},data:()=>({model:{},valid:!1,dialog:!1,errorMessages:"",errorMessagesDict:{},options:{}}),watch:{id:function(e){this.initData()}},computed:{vjsfSchema(){return this.orderedSchema(this.schema.vuetify_json_schema)},properties(){return this.schema.vuetify_json_schema.properties},retrieveUrl(){return this.schema.retrieve_url.replace("%(pk)s",this.id)},orderedProperties(){return function(e,t){if(!Array.isArray(t))return e;const o=e=>e.reduce(((e,t)=>(e[t]=!0,e)),{}),s=o(e),n=t.filter((e=>"*"===e||s[e])),i=o(n),a=e.filter((e=>!i[e])),r=n.indexOf("*");if(-1===r){if(a.length)throw new Error("uiSchema order list does not contain "+((l=a).length>1?`properties '${l.join("', '")}'`:`property '${l[0]}'`));return n}var l;if(r!==n.lastIndexOf("*"))throw new Error("uiSchema order list contains more than one wildcard item");const d=[...n];return d.splice(r,1,...a),d}(Object.keys(this.properties),this.order)}},methods:{orderedSchema:function(e){if(!this.order)return e;let t=this.orderedProperties;const o=JSON.parse(JSON.stringify(e));return o.properties={},t.map((t=>{o.properties[t]={},Object.assign(o.properties[t],e.properties[t])})),o},initData:function(){this.model={}},cancel:function(){this.$emit("closeDialog")},save:function(){this.errorMessagesDict={},this.$refs.form.validate(),this.valid}},components:{VJsf:v}}),undefined,false,undefined,!1,void 0,void 0,void 0),components:{draggable:p},props:["node","controls"],methods:{changeForm:function(){this.$emit("controlDataChange",this.controls)}},computed:{vjsfSchema(){return this.orderedSchema(this.schema)},properties(){return this.schema.properties}}},undefined,false,undefined,!1,void 0,void 0,void 0),PerfectScrollbar:h},data:function(){return{showPreview:!1,dataset:null,tab:null,items:[],headers:[],datasets:[]}},computed:{show(){return null!=this.node},name(){return this.node?.name},schema(){return this.node?.schema},doc(){return this.node?.doc},controls(){return this.prepareControlData(this.node?.node)},order(){return this.node?.order}},watch:{isDataframe:function(e,t){},dataset:function(e,t){}},methods:{closeClick:function(){this.$emit("closePanel"),this.tab=null},onControlDataChange:function(e){let t=t=>!e.hasOwnProperty(t)&&("RollingAggregation"!=this.node.name||["timestamp","id"].includes(t));Object.keys(this.node.node.data).forEach((o=>{t(o)&&(e[o]=null)}));for(let t in e)Array.isArray(e[t])&&t.startsWith("aggregation")?Array.from(e[t]).forEach(((e,o)=>{o+=1,this.node.node.data[t+o]=e})):this.node.node.data[t]=e[t];this.node.node.update()},prepareControlData:function(e){let t={};return e.controls.forEach((function(o,s,n){s.startsWith("aggregation")?t.aggregation=Array.isArray(t.aggregation)?t.aggregation.concat([e.data[s]]):[e.data[s]]:t[s]=e.data[s]})),t},prepareHeaders:function(){0!=this.items.length&&(this.headers=[...new Set(this.items.flatMap((e=>Object.keys(e))))].map((e=>({text:e,value:e}))))},clearPreview:function(){this.showPreview=!1,this.dataset=null,["items","headers"].forEach((e=>{this[e]=[]}))}}};const B=F({render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("v-container",{staticStyle:{padding:"0"},attrs:{"no-gutters":""}},[o("link",{attrs:{href:"https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900",rel:"stylesheet"}}),e._v(" "),o("link",{attrs:{href:"https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css",rel:"stylesheet"}}),e._v(" "),o("v-row",{attrs:{"no-gutters":""}},[o("v-col",{attrs:{cols:"12"}},[o("v-snackbar",{attrs:{color:e.snackbarData.color,top:"",timeout:"3000",absolute:""},scopedSlots:e._u([{key:"action",fn:function(t){var s=t.attrs;return[o("v-btn",e._b({attrs:{dark:"",text:""},on:{click:function(t){e.snackbarData.show=!1}}},"v-btn",s,!1),[e._v("\n            Close\n          ")])]}}]),model:{value:e.snackbarData.show,callback:function(t){e.$set(e.snackbarData,"show",t)},expression:"snackbarData.show"}},[e._v("\n        "+e._s(e.snackbarData.message)+"\n        ")]),e._v(" "),o("v-toolbar",{attrs:{dark:""}},[e.componentsOnGraph?o("v-btn",{staticClass:"primary mr-3",attrs:{disabled:e.saving,loading:e.saving,small:""},on:{click:function(t){return e.saveWorkflowClick()}}},[e._v("\n          Save\n          "),o("v-icon",{attrs:{right:""}},[e._v("mdi-copy")])],1):e._e(),e._v(" "),e.componentsOnGraph?o("v-btn",{staticClass:"primary mr-3",attrs:{disabled:e.validating,loading:e.validating,small:""},on:{click:function(t){return e.validateGraph()}}},[e._v("\n          Validate\n          "),o("v-icon",{attrs:{right:""}},[e._v("mdi-list-status")])],1):e._e(),e._v(" "),e.validationSuccess?o("v-btn",{staticClass:"primary mr-3",attrs:{disabled:e.running,loading:e.running,small:""},on:{click:function(t){return e.runWorkflowClick()}}},[e._v("\n          Run\n          "),o("v-icon",{attrs:{right:""}},[e._v("mdi-run-fast")])],1):e._e(),e._v(" "),e.componentsOnGraph?o("v-btn",{staticClass:"primary mr-3",attrs:{small:""},on:{click:function(t){return e.fitGraphToScreen()}}},[e._v("\n          Fit to screen\n          "),o("v-icon",{attrs:{right:""}},[e._v("mdi-arrow-all")])],1):e._e(),e._v(" "),e.componentsOnGraph?o("v-btn",{staticClass:"primary mr-3",attrs:{small:""},on:{click:function(t){return e.autoArrangeGraph()}}},[e._v("\n          Autoarrange\n          "),o("v-icon",{attrs:{right:""}},[e._v("mdi-collage")])],1):e._e(),e._v(" "),e.componentsOnGraph?o("v-btn",{staticClass:"primary mr-3",attrs:{small:""},on:{click:function(t){return e.clearGraph()}}},[e._v("\n          Clear\n          "),o("v-icon",{attrs:{right:""}},[e._v("mdi-close")])],1):e._e()],1)],1)],1),e._v(" "),o("v-row",{staticStyle:{"margin-top":"0"},attrs:{"no-gutters":""}},[o("v-col",{staticClass:"left-control-panel-wrapper",attrs:{cols:"3"}},[o("v-expansion-panels",{attrs:{accordion:"",focusable:""},model:{value:e.leftPanel,callback:function(t){e.leftPanel=t},expression:"leftPanel"}},[o("v-expansion-panel",[o("v-expansion-panel-header",[e._v("\n            Datasets\n          ")]),e._v(" "),o("v-expansion-panel-content",[o("NodeComponents",{attrs:{items:e.dataframeComponents},on:{itemClicked:e.onTreeViewComponentClicked}})],1)],1),e._v(" "),o("v-expansion-panel",[o("v-expansion-panel-header",[e._v("\n            Components\n          ")]),e._v(" "),o("v-expansion-panel-content",[o("NodeComponents",{attrs:{items:e.nodeComponents},on:{itemClicked:e.onTreeViewComponentClicked}})],1)],1)],1)],1),e._v(" "),o("v-col",{staticClass:"node-editor-wrapper",attrs:{cols:"9"}},[o("div",{staticClass:"node-editor",attrs:{id:"rete"}}),e._v(" "),o("NodeControlPanel",{attrs:{node:e.selectedNode},on:{closePanel:e.onClosePanel}})],1)],1)],1)},staticRenderFns:[]},undefined,{name:"app",props:{datasets:Array,componentSchemas:Array,widget_:Object,workflow:String,vuetify:Object},components:{NodeComponents:I,NodeControlPanel:F({render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("v-col",{directives:[{name:"show",rawName:"v-show",value:e.show,expression:"show"}],staticClass:"node-control-panel",attrs:{cols:"4"}},[o("v-card",{staticClass:"card"},[o("perfect-scrollbar",[o("v-sheet",{staticClass:"pa-4 grey",class:{"lighten-2":!e.$vuetify.theme.dark,"darken-2":e.$vuetify.theme.dark}},[o("div",[e._v("\n          "+e._s(e.name)+"\n          "),o("v-icon",{staticClass:"float-right",on:{click:function(t){return e.closeClick()}}},[e._v("\n            mdi-close-circle-outline\n          ")])],1)]),e._v(" "),o("v-card-text",[o("v-tabs",{attrs:{"background-color":"accent-4",centered:""},model:{value:e.tab,callback:function(t){e.tab=t},expression:"tab"}},[o("v-tab",{attrs:{href:"#node-controls"}},[e._v("\n            Controls\n          ")]),e._v(" "),e.doc?o("v-tab",{attrs:{href:"#node-docs"}},[e._v("\n            Documentation\n          ")]):e._e(),e._v(" "),o("v-tab-item",{attrs:{value:"node-controls"}},[e.schema?o("NodeControlPanelForm",{attrs:{controls:e.controls,schema:e.schema,order:e.order},on:{controlDataChange:e.onControlDataChange}}):e._e()],1),e._v(" "),e.doc?o("v-tab-item",{attrs:{value:"node-docs"}},[o("div",{domProps:{innerHTML:e._s(e.doc)}})]):e._e()],1)],1)],1)],1)],1)},staticRenderFns:[]},(function(e){e&&e("data-v-ef216116_0",{source:".ps{overflow:hidden!important;overflow-anchor:none;-ms-overflow-style:none;touch-action:auto;-ms-touch-action:auto}.ps__rail-x{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;height:15px;bottom:0;position:absolute}.ps__rail-y{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;width:15px;right:0;position:absolute}.ps--active-x>.ps__rail-x,.ps--active-y>.ps__rail-y{display:block;background-color:transparent}.ps--focus>.ps__rail-x,.ps--focus>.ps__rail-y,.ps--scrolling-x>.ps__rail-x,.ps--scrolling-y>.ps__rail-y,.ps:hover>.ps__rail-x,.ps:hover>.ps__rail-y{opacity:.6}.ps .ps__rail-x.ps--clicking,.ps .ps__rail-x:focus,.ps .ps__rail-x:hover,.ps .ps__rail-y.ps--clicking,.ps .ps__rail-y:focus,.ps .ps__rail-y:hover{background-color:#eee;opacity:.9}.ps__thumb-x{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,height .2s ease-in-out;-webkit-transition:background-color .2s linear,height .2s ease-in-out;height:6px;bottom:2px;position:absolute}.ps__thumb-y{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,width .2s ease-in-out;-webkit-transition:background-color .2s linear,width .2s ease-in-out;width:6px;right:2px;position:absolute}.ps__rail-x.ps--clicking .ps__thumb-x,.ps__rail-x:focus>.ps__thumb-x,.ps__rail-x:hover>.ps__thumb-x{background-color:#999;height:11px}.ps__rail-y.ps--clicking .ps__thumb-y,.ps__rail-y:focus>.ps__thumb-y,.ps__rail-y:hover>.ps__thumb-y{background-color:#999;width:11px}@supports (-ms-overflow-style:none){.ps{overflow:auto!important}}@media screen and (-ms-high-contrast:active),(-ms-high-contrast:none){.ps{overflow:auto!important}}.ps{position:relative}",map:void 0,media:void 0})}),W,undefined,false,undefined,!1,V,void 0,void 0)},data:function(){return{editor:null,engine:null,nodeComponents:[],dataframeComponents:[],selectedNode:null,messages:[""],leftPanel:0,nodeStartX:null,nodeStartY:null,validationSuccess:!1,isMounted:!1,validating:!1,running:!1,saving:!1,snackbarData:{show:!1,color:null,message:null}}},async mounted(){if(this.initReteEditor(),this.registerComponents(this.componentSchemas,X,this.nodeComponents),this.datasets.length>0&&this.initDatasets(),this.editor.addNode(await this.editor.components.get("RollingAggregation").createNode()),this.editor.clear(),this.initReteEditorEvents(),this.workflow){let e=JSON.parse(this.workflow);this.importGraph(e.rete,JSON.parse(JSON.stringify(e.rete))).then((()=>{this.autoArrangeGraph()}))}this.widget_.model.on("change:validating",this.validating_change,this.widget_),this.widget_.model.on("change:running",this.running_change,this.widget_),this.widget_.model.on("change:validation_log",this.validation_log_change,this.widget_),this.widget_.model.on("change:saving",this.save_change,this.widget_),this.widget_.model.on("change:workflow_definition",this.workflow_definition_change,this.widget_),this.isMounted=!0},methods:{setSnackbar:function(e){this.snackbarData=e},save_change:function(){this.saving=this.widget_.model.get("saving"),this.saving||this.setSnackbar({show:!0,color:"success",message:"Workflow saved"})},workflow_definition_change:function(){let e=JSON.parse(this.widget_.model.get("workflow_definition"));this.importGraph(e.rete,JSON.parse(JSON.stringify(e.rete))).then((()=>{this.autoArrangeGraph()}))},running_change:function(){this.running=this.widget_.model.get("running"),this.running||this.setSnackbar({show:!0,color:"success",message:"Run completed. Check results below node editor"})},validating_change:function(){this.validating=this.widget_.model.get("validating")},validation_log_change:function(){const e=[],t=e=>this.editor.nodes.find((t=>t.id===parseInt(e,10))),o=t=>{t&&e.push(t)},s=s=>{const n=(i="node_id",s.reduce(((e,t)=>((e[t[i]]=e[t[i]]||[]).push(t),e)),{}));var i;Object.keys(n).map((e=>{const s=n[e][n[e].length-1];null!==s.node_id&&(((e,t="pending",o="")=>{e.vueContext.status=t,e.vueContext.errorMessage=o||""})(t(s.node_id),s.status,s.error),o(s.error),40===s.severity&&this.setSnackbar({show:!0,color:"error",message:"Something went wrong"})),null===s.node_id&&50===s.severity&&(o(s.error),this.setSnackbar({show:!0,color:"error",message:"Something went wrong"}))})),0===e.length&&(this.validationSuccess=!0,this.setSnackbar({show:!0,color:"success",message:"Validation completed"})),this.widget_.model.set("validation_log",""),this.widget_.touch()};this.widget_.model.get("validation_log").length>0&&s(JSON.parse(this.widget_.model.get("validation_log")))},initDatasets:function(){this.registerComponents(this.datasets,O,this.dataframeComponents)},initReteEditor:function(){this.allocatePath;var c=document.querySelector("#rete");const u=document.createElement("div");u.classList="background",this.editor=new e.NodeEditor("demo@0.1.0",c),this.editor.use(o);let h=this.vuetify;this.editor.use(t,{component:L,options:{vuetify:h}}),this.editor.use(r),this.editor.use(n,{background:u}),this.editor.use(s),this.editor.use(i),this.editor.use(a),this.editor.use(l),this.editor.use(d,{margin:{x:50,y:50},depth:0}),this.engine=new e.Engine("demo@0.1.0"),this.engine},initReteEditorEvents:function(){this.editor.on(["process","nodecreated","noderemoved","connectioncreated","connectionremoved"],(async e=>{this.editor.silent||(await this.engine.abort(),await this.engine.process(this.editor.toJSON()))})),this.editor.on(["nodecreated","noderemoved"],(e=>{this.nodeClickHandlers()})),this.editor.on("noderemoved",(e=>{this.selectedNode&&e==this.selectedNode.node&&this.onClosePanel()})),this.editor.on("connectioncreated",(e=>{this.onConnectionCreated(e)})),this.editor.on("connectionremoved",(e=>{this.onConnectionRemoved(e)})),this.editor.on("zoom",(({source:e})=>"dblclick"!==e)),this.editor.view.resize(),n.zoomAt(this.editor),this.editor.trigger("process")},findComponentSchema:function(e){if(e.is_dataframe)return function(e){let t={name:e.name,doc:null,json_schema_form:{type:"object",properties:{X_columns:{title:"X columns",type:"array",items:{type:"string"},"x-props":{"small-chips":!0}},y_columns:{title:"Y columns",type:"array",items:{type:"string"},"x-props":{"small-chips":!0}},additional_columns:{title:"Additional columns",type:"array",items:{type:"string"},"x-props":{"small-chips":!0}}}}};if(e.schema_json){let o=e.schema_json.map((e=>e.name));Object.keys(t.json_schema_form.properties).forEach((e=>{t.json_schema_form.properties[e].items.enum=o}))}return t}(e);{let t=this.componentSchemas.find((t=>t.js_name===e.name));return t||null}},importGraph:function(e,t){return this.editor.fromJSON(e).then((()=>{Object.keys(t.nodes).forEach((e=>{var o=this.editor.nodes.find((o=>o.id===t.nodes[e].id));for(let s in t.nodes[e].data)o.data[s]=t.nodes[e].data[s];o.update()}))}))},exportGraph:function(e){const t={},o={};var s=this.editor.toJSON(),n=JSON.parse(JSON.stringify(s));Object.keys(n.nodes).map((e=>{const s=n.nodes[e];var i=this.editor.nodes.find((t=>t.id===n.nodes[e].id));if(o[e]={name:i.className,parameters:s.data,module:i.pyModule},t[e]=s,i.is_dataframe&&(o[e].schema_json={fields:i.schema_json},o[e].data_columns=o[e].parameters,o[e].parameters={},o[e].file_name=i.name),o[e].parameters.hasOwnProperty("X_columns")&&(o[e].data_columns={X_columns:o[e].parameters.X_columns},delete o[e].parameters.X_columns),"RollingAggregation"==o[e].name){let t=["timestamp","id"];o[e].data_mapping={},t.forEach((t=>{o[e].parameters.hasOwnProperty(t)&&(o[e].data_mapping[t]=o[e].parameters[t],delete o[e].parameters[t])}))}}));var i=[];return Object.keys(n.nodes).forEach((e=>{const o=n.nodes[e],s=t[e];Object.keys(o.outputs).forEach((e=>{o.outputs[e].connections.forEach((o=>{const n=o.node,a=(o.data,s.outputs[e]),r=t[n].inputs[o.input];a.connections.forEach((e=>{r.connections.forEach((t=>{i.push([t.node,t.output,e.node,e.input])}))}))}))}))})),{nodes:o,edges:i,rete:s}},clearGraph:function(){this.editor.clear()},fitGraphToScreen:function(){this.editor.view.resize(),n.zoomAt(this.editor)},autoArrangeGraph:function(){this.editor.trigger("arrange"),this.fitGraphToScreen()},resetStatuses:function(){this.editor.nodes.forEach((e=>{e.vueContext.status="pending",e.vueContext.errorMessage=""}))},startStatuses:function(){this.editor.nodes.forEach((e=>{e.vueContext.status="start",e.vueContext.errorMessage=""}))},clear:function(e){for(var t=document.getElementById("messages"),o=t.lastElementChild;o;)t.removeChild(o),o=t.lastElementChild;this.resetStatuses()},addComponentToTreeView:function(e,t,o=[],s=[]){let n=s;for(let e of o){let t=n.find((t=>t.name===e));t||(t={name:e,children:[]},n.push(t)),n=t.children||(t.children=[])}n.push({name:e,onClick:t})},registerComponents:function(e=[],t,o=[]){let s=this.allocatePath;e.forEach((e=>{let n="RollingAggregation"==e.name?new N(e):new t(e);this.editor.register(n),this.engine.register(n),this.addComponentToTreeView(n.name,(async()=>{this.editor.addNode(await n.createNode())}),t!=O?s(n):[],o)}))},onTreeViewComponentClicked:function(e){e.onClick&&e.onClick()},allocatePath:function(e){return void 0===e.humanModule?["Other"]:e.humanModule.split(".")},onConnectionCreated:function(e){if("DataFrame"==e.output.node.className){let t=this.editor.nodes.find((e=>"DataFrame"==e.className)).data.X_columns,o=e.input.node;o.controls.get("X_columns")||o.addControl(new f(this.editor,"X_columns",o.data.X_columns,t,!1))}let t=document.getElementsByClassName("connection");Array.from(t).forEach((e=>{e.parentElement.style.width="100%",e.parentElement.style.height="100%"}))},onConnectionRemoved:function(e){if("DataFrame"==e.output.node.className){let t=e.input.node;t.controls.get("X_columns")&&(t.removeControl(t.controls.get("X_columns")),delete t.data.X_columns)}},onNodeClicked:function(e){this.selectedNode=null;let t=["y_columns","time_column","X_columns","timestamp","id"],o=["time_column","timestamp","id"];var s=this.findComponentSchema(e);if(this.editor.selected.contains(e)&&s){let n=JSON.parse(JSON.stringify(s.json_schema_form)),i=this.editor.nodes.find((e=>"DataFrame"==e.className));this.selectedNode={},this.selectedNode.name=e.name,this.selectedNode.node=e,this.selectedNode.doc=s.doc?s.doc:null,"DataFrame"!=e.className&&t.forEach((t=>{if(e.controls.get(t)){let s=[];i&&(s=i.data[o.includes(t)?"additional_columns":t]),function(e,t,o,s=!0){e[t]={type:s?"array":"string",title:t,enum:o,items:{type:"string",enum:o}},s?delete e[t].enum:delete e[t].items}(n.properties,t,s,!o.includes(t)),"y_columns"!=t||e.data.y_columns||(e.data.y_columns=[]),"X_columns"==t&&(this.selectedNode.order=["X_columns","*"],n.properties.X_columns["x-slots"]={after:"<hr class='v-divider mb-2' />"},e.data.X_columns||(e.data.X_columns=s)),o.includes(t)?e.data[t]=s.includes(e.data[t])?e.data[t]:null:e.data[t]=e.data[t].filter((e=>s.includes(e)))}})),this.selectedNode.schema=n}},onClosePanel:function(){this.editor.selected.list=[],this.selectedNode=null},nodeMouseDownEvent:function(e){this.nodeStartX=e.pageX,this.nodeStartY=e.pageY},nodeMouseUpEvent:function(e){const t=Math.abs(e.pageX-this.nodeStartX),o=Math.abs(e.pageY-this.nodeStartY);let s=e.target.closest(".node");t<6&&o<6&&this.onNodeClicked(this.editor.nodes.find((e=>e.id==s.id)))},editorBackgroundClickEvent:function(e){this.selectedNode&&(this.editor.selected.list=[],this.selectedNode=null)},nodeClickHandlers:function(){let e=document.getElementsByClassName("node"),t=document.querySelector(".rete-background");t.removeEventListener("click",this.editorBackgroundClickEvent),Array.from(e).forEach((e=>{e.removeEventListener("mousedown",this.nodeMouseDownEvent),e.removeEventListener("mouseup",this.nodeMouseUpEvent)})),t.addEventListener("click",this.editorBackgroundClickEvent),Array.from(e).forEach((e=>{e.addEventListener("mousedown",this.nodeMouseDownEvent),e.addEventListener("mouseup",this.nodeMouseUpEvent)}))},atLeastComponent(e){return this.editor.nodes.filter(e).length>0},validateGraph(){let e=this.exportGraph();this.widget_.model.set("workflow_definition",JSON.stringify(e)),this.widget_.touch(),this.validating=!0,this.validationSuccess=!1,this.widget_.model.set("validating",!0),this.widget_.touch(),this.resetStatuses(),this.startStatuses()},runWorkflowClick(){let e=this.exportGraph();this.widget_.model.set("workflow_definition",JSON.stringify(e)),this.widget_.touch(),this.running=!0,this.widget_.model.set("running",!0),this.widget_.touch()},saveWorkflowClick(){let e=this.exportGraph();this.widget_.model.set("workflow_definition",JSON.stringify(e)),this.widget_.touch(),this.saving=!0,this.widget_.model.set("saving",!0),this.widget_.touch()}},computed:{componentsOnGraph(){const e=()=>!(!this.atLeastComponent((e=>["DataFrame"].includes(e.className)?e:null))||!this.atLeastComponent((e=>["DataFrame"].includes(e.className)?null:e)));return!!this.isMounted&&e()}}},undefined,false,undefined,!1,void 0,void 0,void 0),U=function(e){U.installed||(U.installed=!0,e.component("NodeEditor",B))};B.install=U;export default B;
