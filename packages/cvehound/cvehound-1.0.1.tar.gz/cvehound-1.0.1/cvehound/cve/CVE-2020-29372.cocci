/// Files: mm/madvise.c include/uapi/linux/io_uring.h include/linux/sched/mm.h
/// Fix: bc0c4d1e176eeb614dc8734fc3ace34292771f11
/// Fixes: c1ca757bd6f4632c510714631ddcc2d13030fe1e

virtual detect

@func@
@@

mmget_still_valid(struct mm_struct *mm)
{
	...
}

@ioring_op_madvise@
@@

enum {
	...,
	IORING_OP_MADVISE,
	...
};

@err depends on ioring_op_madvise && func exists@
identifier behavior;
position p;
statement S;
@@

do_madvise(..., int behavior)
{
	... when any
	write = madvise_need_mmap_write(behavior);
*	if (write@p) {
		if (down_write_killable(&current->mm->mmap_sem))
			return -EINTR;
	} else S
	... when any
}

@script:python depends on detect@
p << err.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2020-29372')
