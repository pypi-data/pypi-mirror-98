#!/bin/bash

# this will power cycle all of the active ports on the mouse cage lid
# first, it cycles ports 1,2,3 on the upstream hub (usb device 1-1.3)
# it's worth noting that port 4 of the upstream hub goes to the downstream hub
# then, it cycles ports 1,2,3,4 on the downstream hub (usb device 1-1.3.4)

# use the following to see the USB hub device tree
# lsusb -t -v

# this script assumes the Lid is plugged into port 1-1.3 on the Pi 3B+, which
# is the top right port when looking at the USB ports on the Pi 3B+


echo "turning off port 1 on upstream hub"
sudo uhubctl -l 1-1.3 -p 1 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.1/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 1 on upstream hub"
sudo uhubctl -l 1-1.3 -p 1 -a on 2> /dev/null
sleep 3 2> /dev/null

echo "turning off port 2 on upstream hub"
sudo uhubctl -l 1-1.3 -p 2 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.2/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 2 on upstream hub"
sudo uhubctl -l 1-1.3 -p 2 -a on 2> /dev/null
sleep 3 2> /dev/null

echo "turning off port 3 on upstream hub"
sudo uhubctl -l 1-1.3 -p 3 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.3/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 3 on upstream hub"
sudo uhubctl -l 1-1.3 -p 3 -a on 2> /dev/null
sleep 3 2> /dev/null


echo "turning off port 1 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 1 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.4.1/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 1 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 1 -a on 2> /dev/null
sleep 3 2> /dev/null

echo "turning off port 2 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 2 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.4.2/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 2 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 2 -a on 2> /dev/null
sleep 3 2> /dev/null

echo "turning off port 3 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 3 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.4.3/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 3 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 3 -a on 2> /dev/null
sleep 3 2> /dev/null

echo "turning off port 4 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 4 -a off 2> /dev/null
sudo udevadm trigger --action=remove /sys/bus/usb/devices/1-1.3.4.4/ 2> /dev/null
sleep 3 2> /dev/null
echo "turning on port 4 on downstream hub"
sudo uhubctl -l 1-1.3.4 -p 4 -a on 2> /dev/null
sleep 5 2> /dev/null


echo "cycle is done."
