(self.webpackChunkjupyterlab_requirements=self.webpackChunkjupyterlab_requirements||[]).push([[778],{778:(e,t,n)=>{"use strict";n.r(t),n.d(t,{commandIDs:()=>j,default:()=>B});var s=n(271),a=n.n(s),i=n(343),l=n(211),o=n(510),r=n(486),c=n.n(r);class h{constructor(e="pypi",t="https://pypi.org/simple",n=!0,s,a){this.name=e,this.url=t,this.verify_ssl=n,this.warehouse=s,this.warehouse_api_url=a}}function d(e){const t=e.content.model.metadata.get("language_info");console.log("language_info:",t);const n=c().get(t,"version");if(console.log("python version identified:",n),null==n)return console.log(`Python version '${n}' is null.`),null;const s=n.match(/\d.\d/);if(console.log("match identified:",s),null==s)throw new Error(`Python version '${n}' does not match required pattern.`);return s[0]}function p(e,t){return new Promise((async(n,s)=>{try{return e.model.metadata.delete(t),n("Removed correctly "+t+" from notebook metadata")}catch(e){s(e)}}))}function m(e,t){const n=e.model.metadata;if(0==n.has("requirements"))n.set("requirements",JSON.stringify(t)),console.log("Notebook requirements have been set successfully.");else{if(console.log("Notebook requirements already exist. Updating..."),1==c().isEmpty(t.packages))throw console.log("Notebook requirements packages is empty..."),new Error(`Packages in notebook requirements is empty: '${t}' `);n.set("requirements",JSON.stringify(t))}}function g(e,t){const n=e.model.metadata;0==n.has("requirements_lock")||console.debug("Notebook requirement_lock already exist. Updating."),n.set("requirements_lock",JSON.stringify(t)),console.log("Notebook requirements_lock have been set successfully.")}function u(e,t){const n=e.model.metadata;0==n.has("dependency_resolution_engine")||console.debug("Dependency resolution engine used for requirements already exist. Updating."),n.set("dependency_resolution_engine",t),console.log("Dependency resolution engine used for requirements have been set successfully.")}var k=n(802);const _=new k.LabIcon({name:"thoth:add-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 52 52" style="enable-background:new 0 0 52 52;" xml:space="preserve">\r\n<g>\r\n    <path d="M26,0C11.664,0,0,11.663,0,26s11.664,26,26,26s26-11.663,26-26S40.336,0,26,0z M26,50C12.767,50,2,39.233,2,26\r\n        S12.767,2,26,2s24,10.767,24,24S39.233,50,26,50z"/>\r\n    <path d="M38.5,25H27V14c0-0.553-0.448-1-1-1s-1,0.447-1,1v11H13.5c-0.552,0-1,0.447-1,1s0.448,1,1,1H25v12c0,0.553,0.448,1,1,1\r\n        s1-0.447,1-1V27h11.5c0.552,0,1-0.447,1-1S39.052,25,38.5,25z"/>\r\n</g>\r\n</svg>\r\n'}),v=new k.LabIcon({name:"thoth:edit-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 330 330" style="enable-background:new 0 0 330 330;" xml:space="preserve">\r\n<g id="XMLID_23_">\r\n    <path id="XMLID_24_" d="M75,180v60c0,8.284,6.716,15,15,15h60c3.978,0,7.793-1.581,10.606-4.394l164.999-165\r\n        c5.858-5.858,5.858-15.355,0-21.213l-60-60C262.794,1.581,258.978,0,255,0s-7.794,1.581-10.606,4.394l-165,165\r\n        C76.58,172.206,75,176.022,75,180z M105,186.213L255,36.213L293.787,75l-150,150H105V186.213z"/>\r\n    <path id="XMLID_27_" d="M315,150.001c-8.284,0-15,6.716-15,15V300H30V30H165c8.284,0,15-6.716,15-15s-6.716-15-15-15H15\r\n        C6.716,0,0,6.716,0,15v300c0,8.284,6.716,15,15,15h300c8.284,0,15-6.716,15-15V165.001C330,156.716,323.284,150.001,315,150.001z"\r\n        />\r\n</g>\r\n</svg>\r\n'}),w=new k.LabIcon({name:"thoth:delete-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 473 473" style="enable-background:new 0 0 473 473;" xml:space="preserve">\r\n<g>\r\n    <path d="M324.285,215.015V128h20V38h-98.384V0H132.669v38H34.285v90h20v305h161.523c23.578,24.635,56.766,40,93.477,40\r\n        c71.368,0,129.43-58.062,129.43-129.43C438.715,277.276,388.612,222.474,324.285,215.015z M294.285,215.015\r\n        c-18.052,2.093-34.982,7.911-50,16.669V128h50V215.015z M162.669,30h53.232v8h-53.232V30z M64.285,68h250v30h-250V68z M84.285,128\r\n        h50v275h-50V128z M164.285,403V128h50v127.768c-21.356,23.089-34.429,53.946-34.429,87.802c0,21.411,5.231,41.622,14.475,59.43\r\n        H164.285z M309.285,443c-54.826,0-99.429-44.604-99.429-99.43s44.604-99.429,99.429-99.429s99.43,44.604,99.43,99.429\r\n        S364.111,443,309.285,443z"/>\r\n    <polygon points="342.248,289.395 309.285,322.358 276.323,289.395 255.11,310.608 288.073,343.571 255.11,376.533 276.323,397.746\r\n        309.285,364.783 342.248,397.746 363.461,376.533 330.498,343.571 363.461,310.608     "/>\r\n</g>\r\n</svg>\r\n'}),y=new k.LabIcon({name:"thoth:installed-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">\r\n<rect style="fill:#32BEA6;" width="512" height="512"/>\r\n<polygon style="fill:#FFFFFF;" points="203.728,392.144 104.512,305.392 125.584,281.296 200.144,346.496 383.776,126.128\r\n    408.368,146.64 "/>\r\n<g>\r\n</g>\r\n</svg>\r\n'}),f=new k.LabIcon({name:"thoth:not-installed-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 511.996 511.996" style="enable-background:new 0 0 511.996 511.996;" xml:space="preserve">\r\n<rect x="0.02" y="0.008" style="fill:#E21B1B;" width="511.956" height="511.988"/>\r\n<g>\r\n\r\n        <rect x="247.999" y="98.14" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -106.0433 256.0008)" style="fill:#FFFFFF;" width="15.999" height="315.731"/>\r\n\r\n        <rect x="98.133" y="247.993" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -106.0334 255.9967)" style="fill:#FFFFFF;" width="315.731" height="15.999"/>\r\n</g>\r\n</svg>\r\n'}),E="thoth-row-button";class b extends s.Component{constructor(e){super(e),this.state={name:"",version:"*"},this.handleChange=this.handleChange.bind(this),this.handleItemDeleted=this.handleItemDeleted.bind(this),this.handleItemEdited=this.handleItemEdited.bind(this),this.showIfInstalled=this.showIfInstalled.bind(this)}handleChange(e){"package_name"==e.target.name&&this.setState({name:e.target.value}),"package_version"==e.target.name&&this.setState({version:e.target.value})}handleItemDeleted(e){this.props.deleteSavedRow(e)}handleItemEdited(e,t){this.props.editSavedRow(e,t)}showIfInstalled(e){return"Y"==e?s.createElement(y.react,{elementPosition:"center",width:"30px",height:"30px"}):s.createElement(f.react,{elementPosition:"center",width:"30px",height:"30px"})}render(){var e=this;return s.createElement("tr",null,s.createElement("td",null,s.createElement("input",{name:"package_name",type:"text",value:this.props.name,className:"thoth-package-name-input",disabled:!0})),s.createElement("td",null,s.createElement("input",{name:"package_version",type:"text",value:this.props.version,className:"thoth-constraint-input",disabled:!0})),s.createElement("td",null,e.showIfInstalled(this.props.installed)),s.createElement("td",null,s.createElement("td",null,s.createElement("button",{title:"Add package",className:"thoth-row-button-deactivated",type:"button",disabled:!0},s.createElement(_.react,{elementPosition:"center",width:"20px",height:"20px",display:"inline-block"}))),s.createElement("td",null,s.createElement("button",{title:"Edit saved package",className:E,type:"button",onClick:e.handleItemEdited.bind(e,this.props.name,this.props.version)},s.createElement(v.react,{elementPosition:"center",width:"20px",height:"20px",display:"inline-block"}))),s.createElement("td",null,s.createElement("button",{title:"Delete saved package",className:E,type:"button",onClick:e.handleItemDeleted.bind(e,this.props.name)},s.createElement(w.react,{elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})))))}}const x="thoth-row-button",q="thoth-row-button-deactivated";class S extends s.Component{constructor(e){super(e),this.state={isAdded:!1,isEditable:!1,name:"",version:"*"},this.handleItemAdded=this.handleItemAdded.bind(this),this.handleChange=this.handleChange.bind(this),this.handleItemDeleted=this.handleItemDeleted.bind(this),this.showIfInstalled=this.showIfInstalled.bind(this)}handleChange(e){"package_name"==e.target.name&&this.setState({name:e.target.value}),"package_version"==e.target.name&&this.setState({version:e.target.value})}handleItemAdded(){var e=this.state.name.toString(),t=this.state.version.toString();this.props.storeRow(e,t),this.setState({isAdded:!0,isEditable:!0})}handleItemDeleted(e){this.props.deleteRow(e)}showIfInstalled(e){return"Y"==e?s.createElement(y.react,{tag:"div",elementPosition:"center",width:"30px",height:"30px",display:"inline-block"}):s.createElement(f.react,{tag:"div",elementPosition:"center",width:"30px",height:"30px",display:"inline-block"})}handleItemEdited(e){this.props.editRow(e),this.setState({isAdded:!1,isEditable:!1})}render(){var e=this;let t,n;return t=this.state.isAdded?s.createElement("button",{title:"Include new package",className:q,type:"button",disabled:!0},s.createElement(_.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})):s.createElement("button",{title:"Include new package",className:x,type:"button",onClick:e.handleItemAdded.bind(e)},s.createElement(_.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})),n=this.state.isEditable?s.createElement("button",{title:"Edit package",className:x,type:"button",onClick:e.handleItemEdited.bind(e,this.state.name)},s.createElement(v.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})):s.createElement("button",{title:"Edit package",className:q,type:"button",disabled:!0},s.createElement(v.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})),s.createElement("tr",null,s.createElement("td",null,s.createElement("input",{name:"package_name",type:"text",value:this.state.name,className:"thoth-package-name-input",onChange:this.handleChange})),s.createElement("td",null,s.createElement("input",{name:"package_version",type:"text",value:this.state.version,className:"thoth-constraint-input",onChange:this.handleChange})),s.createElement("td",null,e.showIfInstalled(this.props.installed)),s.createElement("td",null,s.createElement("td",null,t),s.createElement("td",null,n),s.createElement("td",null,s.createElement("button",{title:"Delete new package",className:x,type:"button",onClick:e.handleItemDeleted.bind(e,this.state.name)},s.createElement(w.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})))))}}const I="thoth-table";class N extends s.Component{constructor(e){super(e),this.state={headers:["Package","Constraint","Installed","Actions"]}}renderTableHeader(){var e=[];const t=this.state.headers;return c().forEach(t,(function(t){e.push(s.createElement("th",{className:{THOTH_TABLE:I}},t.toUpperCase()))})),e}renderRows(){var e=this,t=this.props.packages,n=this.props.initial_packages,a=this.props.installed_packages,i=[];for(let[l,o]of Object.entries(n))c().has(a,l)?i.push(s.createElement(b,{name:l,version:o,installed:"Y",packages:t,editSavedRow:e.props.editSavedRow,deleteSavedRow:e.props.deleteSavedRow})):i.push(s.createElement(b,{name:l,version:o,installed:"N",packages:t,editSavedRow:e.props.editSavedRow,deleteSavedRow:e.props.deleteSavedRow}));for(let[n,a]of Object.entries(t))i.push(s.createElement(S,{name:n,installed:"N",packages:t,editRow:e.props.editRow,storeRow:e.props.storeRow,deleteRow:e.props.deleteRow}));return i}render(){return s.createElement("table",{id:I,className:I},s.createElement("thead",{className:{THOTH_TABLE:I}},s.createElement("tr",{id:I,className:I},this.renderTableHeader())),s.createElement("tbody",{className:{THOTH_TABLE:I}},this.renderRows()))}}class R extends s.Component{constructor(e){super(e)}render(){return s.createElement(N,{packages:this.props.packages,initial_packages:this.props.initial_packages,installed_packages:this.props.installed_packages,editRow:this.props.editRow,storeRow:this.props.storeRow,editSavedRow:this.props.editSavedRow,deleteRow:this.props.deleteRow,deleteSavedRow:this.props.deleteSavedRow})}}const C=new k.LabIcon({name:"thoth:save-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\r\n<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     width="356.725px" height="356.725px" viewBox="0 0 356.725 356.725" style="enable-background:new 0 0 356.725 356.725;"\r\n     xml:space="preserve">\r\n<g>\r\n    <g>\r\n        <path d="M307.463,0h-46.35H95.611H49.259C27.905,0,10.53,17.381,10.53,38.73v279.264c0,21.352,17.375,38.73,38.729,38.73H124.3\r\n            h108.125h75.037c21.357,0,38.732-17.379,38.732-38.73V38.73C346.196,17.381,328.821,0,307.463,0z M251.43,19.365v121.922H105.295\r\n            V19.365H251.43z M133.981,337.359v-93.593h88.761v93.593H133.981z M326.83,317.994c0,10.676-8.686,19.365-19.366,19.365h-65.355\r\n            V234.084c0-5.352-4.334-9.682-9.683-9.682H124.301c-5.348,0-9.684,4.33-9.684,9.682v103.275H49.26\r\n            c-10.681,0-19.366-8.689-19.366-19.365V38.73c0-10.674,8.686-19.365,19.366-19.365h36.669v131.604\r\n            c0,5.344,4.335,9.684,9.683,9.684h165.503c5.346,0,9.682-4.34,9.682-9.684V19.365h36.668c10.682,0,19.366,8.691,19.366,19.365\r\n            L326.83,317.994L326.83,317.994z"/>\r\n        <path d="M127.043,123.898h102.64c5.347,0,9.681-4.34,9.681-9.684c0-5.351-4.334-9.682-9.681-9.682h-102.64\r\n            c-5.348,0-9.684,4.331-9.684,9.682C117.359,119.558,121.695,123.898,127.043,123.898z"/>\r\n        <path d="M127.043,90.009h102.64c5.347,0,9.681-4.34,9.681-9.684c0-5.352-4.334-9.682-9.681-9.682h-102.64\r\n            c-5.348,0-9.684,4.33-9.684,9.682C117.359,85.67,121.695,90.009,127.043,90.009z"/>\r\n        <path d="M127.043,56.119h102.64c5.347,0,9.681-4.339,9.681-9.682c0-5.352-4.334-9.682-9.681-9.682h-102.64\r\n            c-5.348,0-9.684,4.33-9.684,9.682C117.359,51.78,121.695,56.119,127.043,56.119z"/>\r\n        <path d="M203.78,253.441c-5.35,0-9.684,4.34-9.684,9.682v27.439c0,5.344,4.334,9.684,9.684,9.684c5.347,0,9.683-4.34,9.683-9.684\r\n            v-27.439C213.462,257.781,209.126,253.441,203.78,253.441z"/>\r\n    </g>\r\n</g>\r\n</svg>\r\n'});class O extends s.Component{constructor(e){super(e)}saveRequirements(){this.props.onSave()}render(){return s.createElement("button",{title:"Save dependencies",className:"thoth-save-button",type:"button",onClick:this.saveRequirements.bind(this)},s.createElement(C.react,{tag:"div",elementPosition:"center",right:"7px",top:"5px",width:"20px",height:"20px"}))}}class P extends s.Component{constructor(e){super(e)}onInstall(){this.props.install()}render(){return s.createElement("button",{title:"Install dependencies",className:"thoth-install-button",onClick:this.onInstall.bind(this)},"Install")}}class T extends s.Component{constructor(e){super(e)}addNewEmptyRow(){this.props.addNewRow()}render(){return s.createElement("button",{title:"Add new line! Only one empty line is displayed.",className:"thoth-new-package-button",type:"button",onClick:this.addNewEmptyRow.bind(this)},s.createElement(_.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"}))}}var U=n(629),V=n(337);async function J(e="",t={}){const n=V.ServerConnection.makeSettings(),s=U.URLExt.join(n.baseUrl,"jupyterlab_requirements",e);let a;try{a=await V.ServerConnection.makeRequest(s,t,n)}catch(e){throw new V.ServerConnection.NetworkError(e)}const i=await a.json();if(!a.ok)throw new V.ServerConnection.ResponseError(a,i.message);return i}async function z(e,t,n={}){const s={runtime_environment:e,force:t};try{const e=await J("thoth/config",{body:JSON.stringify(s),method:"PUT"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on PUT /jupyterlab_requirements/thoth/config:",e)}}const M="thoth-ok-button",D="thoth-container-button",A="thoth-container-button-centre";class L extends s.Component{constructor(e){super(e),this.onStart=this.onStart.bind(this),this.changeUIstate=this.changeUIstate.bind(this),this.addNewRow=this.addNewRow.bind(this),this.editRow=this.editRow.bind(this),this.editSavedRow=this.editSavedRow.bind(this),this.storeRow=this.storeRow.bind(this),this.deleteRow=this.deleteRow.bind(this),this.deleteSavedRow=this.deleteSavedRow.bind(this),this.onSave=this.onSave.bind(this),this.checkInstalledPackages=this.checkInstalledPackages.bind(this),this.lock_using_thoth=this.lock_using_thoth.bind(this),this.lock_using_pipenv=this.lock_using_pipenv.bind(this),this.install=this.install.bind(this),this.setKernel=this.setKernel.bind(this),this.createConfig=this.createConfig.bind(this),this.setKernelName=this.setKernelName.bind(this),this.setRecommendationType=this.setRecommendationType.bind(this),this.state={kernel_name:"jupyterlab_requirements",recommendation_type:"latest",status:"loading",packages:{},initial_packages:{},installed_packages:{},deleted_packages:{},requirements:{packages:{},requires:{python_version:d(this.props.panel)},sources:[new h]},thoth_config:{host:"khemenu.thoth-station.ninja",tls_verify:!1,requirements_format:"pipenv",runtime_environments:[{name:"ubi:8",operating_system:{name:"ubi",version:"8"},python_version:"3.8",recommendation_type:"latest"}]},error_msg:void 0}}changeUIstate(e,t,n,s,a,i,l,o,r){var h=this.state;console.log("initial",h),c().set(h,"status",e),c().set(h,"packages",t),c().set(h,"initial_packages",n),c().set(h,"installed_packages",s),c().set(h,"deleted_packages",a),c().set(h,"requirements",i),c().set(h,"kernel_name",l),c().set(h,"thoth_config",o),c().set(h,"error_msg",r),console.log("new",h),this.setState(h)}setRecommendationType(e){this.setState({recommendation_type:e})}changeRecommendationType(e){const t=e.target.value;this.setRecommendationType(t)}setKernelName(e){const t=e.target.value;this.setState({kernel_name:t})}addNewRow(){const e=this.state.packages;c().set(e,"",""),console.log("added package",e),this.changeUIstate("editing",e,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}editRow(e){const t=this.state.packages;c().unset(t,e),c().set(t,"","*"),console.log("After editing (current)",t),this.changeUIstate("editing",t,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}editSavedRow(e,t){const n=this.state.initial_packages,s=this.state.packages;c().unset(n,e),c().set(s,e,t),console.log("After editing (initial)",n),console.log("After editing (current)",s),this.changeUIstate("editing",s,n,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}deleteRow(e){const t=this.state.packages,n={};c().unset(t,e),console.log("After deleting",t),c().set(n,e,"*"),console.log("Deleted",n),this.changeUIstate("editing",t,this.state.initial_packages,this.state.installed_packages,n,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}deleteSavedRow(e){const t=this.state.initial_packages;c().unset(t,e),console.log("After deleting saved",t);const n={};c().set(n,e,"*"),console.log("Deleted",n),this.changeUIstate("editing",this.state.packages,t,this.state.installed_packages,n,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}storeRow(e,t){let n=this.state.packages;c().set(n,e,t);const s={};c().forIn(n,(function(e,t){console.log(t+" goes "+e),""!=t&&c().set(s,t,e)})),console.log("new packages",s),this.changeUIstate("editing",s,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}onSave(){const e=this.state.deleted_packages,t=this.state.requirements,n=this.state.packages;console.log("added_packages",n);const s=this.state.initial_packages;console.log("initial_packages",s);const a={};c().forIn(s,(function(e,t){0==c().has(s,"")&&c().set(a,t,e)}));const i={};if(c().forIn(n,(function(e,t){0==c().has(n,"")&&(c().set(a,t,e),c().set(i,t,e))})),c().size(e)>0){if(c().size(a)>0)return void this.lock_using_thoth();p(this.props.panel,"requirements"),p(this.props.panel,"requirements_lock"),p(this.props.panel,"thoth_config"),this.props.panel.context.save();var l={packages:a,requires:t.requires,sources:[new h]};this.changeUIstate("initial",i,this.state.initial_packages,this.state.installed_packages,{},l,this.state.kernel_name,this.state.thoth_config)}if(c().size(a)>0){if(c().isEqual(a,this.state.installed_packages)){var o={packages:a,requires:t.requires,sources:t.sources};return m(this.props.panel,o),this.props.panel.context.save(),void this.changeUIstate("stable",{},this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}console.log("total packages",a);var r={packages:a,requires:t.requires,sources:t.sources};return console.log("Requirements before installing are: ",r),m(this.props.panel,r),this.props.panel.context.save(),void this.changeUIstate("saved",{},a,this.state.installed_packages,this.state.deleted_packages,r,this.state.kernel_name,this.state.thoth_config)}return l={packages:a,requires:t.requires,sources:[new h]},console.log("Requirements are: ",l),m(this.props.panel,l),void this.changeUIstate("failed_no_reqs",i,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}async install(){try{const e=await async function(e,t={}){const n={kernel_name:e},s="kernel/install";try{return await J(s,{body:JSON.stringify(n),method:"POST"})}catch(e){console.error("Error on POST /jupyterlab_requirements/"+s+":",e)}}(this.state.kernel_name);return console.log("Install message",e),void this.changeUIstate("setting_kernel",{},this.state.initial_packages,this.state.initial_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}catch(e){console.log("Error installing requirements",e),this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config,"Error install dependencies in the new virtual environment, please contact Thoth team.")}}async store_dependencies_on_disk(e,t,n,s){const a=await async function(e,t,n,s=".local/share/thoth/kernels",a=!0,i={}){const l={kernel_name:e,requirements:t,requirement_lock:n,path_to_store:s,using_home_path_base:a},o="file/dependencies";try{return await J(o,{body:JSON.stringify(l),method:"POST"})}catch(e){console.error("Error on POST /jupyterlab_requirements/"+o+":",e)}}(this.state.kernel_name,JSON.stringify(e),JSON.stringify(t),n,s);console.log("Store message",a)}async setKernel(){try{const e=await async function(e,t={}){const n={kernel_name:e},s="kernel/create";try{return await J(s,{body:JSON.stringify(n),method:"POST"})}catch(e){console.error("Error on POST /jupyterlab_requirements/"+s+":",e)}}(this.state.kernel_name);return console.log("Kernel message",e),void this.changeUIstate("ready",{},this.state.initial_packages,this.state.initial_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)}catch(e){return console.log("Error creating jupyter kernel",e),void this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config,"Error setting new environment in a jupyter kernel, please contact Thoth team.")}}async lock_using_thoth(){this.changeUIstate("locking_requirements",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config);const e=this.state.thoth_config;console.log("thoth config to be submitted",JSON.stringify(e));const t=this.state.requirements;console.log("Requirements to be submitted",JSON.stringify(t));try{const n=await async function(e,t,n,s={}){const a={kernel_name:e,thoth_config:t,requirements:n},i="thoth/resolution";try{const e=await J(i,{body:JSON.stringify(a),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/"+i+":",e)}}(this.state.kernel_name,JSON.stringify(e),JSON.stringify(t));if(console.log("Advise received",n),0==n.error){if(0==c().isEmpty(n.requirements.packages)){m(this.props.panel,n.requirements),g(this.props.panel,n.requirement_lock),function(e,t){const n=e.model.metadata;0==n.has("thoth_config")||console.debug("Notebook Thoth config already exist. Updating."),n.set("thoth_config",JSON.stringify(t)),console.log("Notebook Thoth config have been set successfully.")}(this.props.panel,e),u(this.props.panel,"thoth"),this.props.panel.context.save();try{await this.store_dependencies_on_disk(n.requirements,n.requirement_lock,"overlays",!1)}catch(e){console.log("Error storing dependencies in overlays",e)}try{await z(this.state.thoth_config.runtime_environments[0],!0)}catch(e){console.log("Error updating thoth config on disk",e)}return void this.changeUIstate("installing_requirements",{},this.state.initial_packages,this.state.installed_packages,{},n.requirements,this.state.kernel_name,this.state.thoth_config)}console.log("Advise requirements packages received is empty",n.requirements),this.lock_using_pipenv()}else this.lock_using_pipenv()}catch(e){console.log("Error locking requirements with Thoth",e),this.lock_using_pipenv()}}async lock_using_pipenv(){this.changeUIstate("locking_requirements_using_pipenv",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config);const e=this.state.requirements;console.log("Requirements for pipenv",JSON.stringify(e));try{const t=await async function(e,t,n={}){const s={kernel_name:e,requirements:t};try{const e=await J("pipenv",{body:JSON.stringify(s),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/pipenv:",e)}}(this.state.kernel_name,JSON.stringify(e));if(console.log("Result received",t),0==t.error){m(this.props.panel,e),g(this.props.panel,t.requirements_lock),u(this.props.panel,"pipenv"),this.props.panel.context.save();try{await this.store_dependencies_on_disk(e,t.requirements_lock,"overlays",!1)}catch(e){console.log("Error storing dependencies in overlays",e)}try{await z(this.state.thoth_config.runtime_environments[0],!0)}catch(e){console.log("Error updating thoth config on disk",e)}return void this.changeUIstate("installing_requirements",{},this.state.initial_packages,this.state.installed_packages,{},e,this.state.kernel_name,this.state.thoth_config)}return void this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config,"No resolution engine was able to install dependendices, please contact Thoth team.")}catch(e){return console.log("Error locking requirements with pipenv",e),void this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config,"No resolution engine was able to install dependendices, please contact Thoth team.")}}async onStart(){if(null==(e=this.props.initial_config_file)){console.log("No initial thoth config found, creating default one");var e=await this.createConfig()}c().isUndefined(e)&&(console.warn("Thoth config is undefined"),e=this.state.thoth_config);const t=e.runtime_environments,n=t[0];c().set(n,"name",this.state.kernel_name),c().set(n,"recommendation_type",this.state.recommendation_type),c().set(t,0,n),c().set(e,"runtime_environments",t),console.log("initial thoth config",e);var s=this.props.initial_requirements;console.log("initial requirements",s);var a=s.packages;if(0==c().size(a))return void this.changeUIstate(status="initial",this.state.packages,a,this.state.installed_packages,this.state.deleted_packages,s,this.state.kernel_name,e);const i=this.props.initial_requirements_lock;if(console.log("initial requirements lock",i),null==i)return void this.changeUIstate(status="only_install",this.state.packages,a,this.state.installed_packages,this.state.deleted_packages,s,this.state.kernel_name,e);const l={};c().forIn(i.default,(function(e,t){c().set(l,t,e.version.replace("==",""))})),console.log(l);const o=function(e){const t=e.content.model.metadata.get("kernelspec");console.log("kernel info:",t);const n=c().get(t,"name");return console.log("kernel_name identified:",n),n}(this.props.panel),r={};c().forIn(a,(function(e,t){c().has(l,t.toLowerCase())&&c().set(r,t,e)})),console.log("initial packages",a),console.log("packages in req and req lock",r);const h=await this.retrieveInstalledPackages(o,l),d={};if(c().forIn(a,(function(e,t){c().has(h,t.toLowerCase())&&c().set(d,t,e)})),console.log("initial installed packages",d),c().isEqual(c().size(a),c().size(r)))return 1==await this.checkInstalledPackages(h,l)?void this.changeUIstate("stable",this.state.packages,a,a,this.state.deleted_packages,s,o,e):void this.changeUIstate("only_install_kernel",this.state.packages,a,d,this.state.deleted_packages,s,o,e);this.changeUIstate("only_install_kernel",this.state.packages,a,d,this.state.deleted_packages,s,o,e)}async retrieveInstalledPackages(e,t){const n=await async function(e,t={}){const n={kernel_name:e},s="kernel/packages";try{const e=await J(s,{body:JSON.stringify(n),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/"+s+":",e)}}(e);console.log("packages installed (pip list)",n);const s={};return c().forIn(n,(function(e,n){c().has(t,n.toLowerCase())&&c().get(t,n.toLowerCase())==e&&c().set(s,n,e)})),console.log("Installed packages:",s),s}async checkInstalledPackages(e,t){return!!c().isEqual(c().size(t),c().size(e))}async createConfig(){const e=await async function(e,t={}){const n={kernel_name:e};try{const e=await J("thoth/config",{body:JSON.stringify(n),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/thoth/config:",e)}}(this.state.kernel_name);return console.log("Config file",e),e}render(){let e=s.createElement("div",null,s.createElement(R,{initial_packages:this.state.initial_packages,installed_packages:this.state.installed_packages,packages:this.state.packages,editRow:this.editRow,storeRow:this.storeRow,deleteRow:this.deleteRow,editSavedRow:this.editSavedRow,deleteSavedRow:this.deleteSavedRow})),t=s.createElement("div",null,s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement(T,{addNewRow:this.addNewRow}))),s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement(P,{changeUIstate:this.changeUIstate,install:this.lock_using_thoth})))),n=s.createElement("div",null,s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement(T,{addNewRow:this.addNewRow}))),s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement(O,{onSave:this.onSave,changeUIstate:this.changeUIstate})))),a=s.createElement("div",null,s.createElement("section",null,s.createElement("h2",null,"OPTIONS")),s.createElement("form",null,s.createElement("label",null,"Kernel name:",s.createElement("input",{title:"Kernel name",type:"text",name:"kernel_name",value:this.state.kernel_name,onChange:this.setKernelName})),s.createElement("br",null),s.createElement("label",null,"Recommendation type:",s.createElement("select",{onChange:()=>this.changeRecommendationType},'title="Recommendation Type" name="recommendation_type" value=',this.state.recommendation_type,s.createElement("option",{value:"latest"},"latest"),s.createElement("option",{value:"performance"},"performance"),s.createElement("option",{value:"security"},"security"),s.createElement("option",{value:"stable"},"stable")))));return"loading"==this.state.status?(this.onStart(),s.createElement("div",null,"Loading...")):"initial"==this.state.status?s.createElement("div",null,s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement(T,{addNewRow:this.addNewRow}))),s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null," No dependencies found! Click New to add package. ")))):"no_reqs_to_save"==this.state.status?s.createElement("div",null,e,n,s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null," Dependencies missing! Click New to add package. ")))):"only_install"==this.state.status?s.createElement("div",null,e,t,s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null,"Dependencies found in notebook metadata but lock file is missing. "))),a):"only_install_kernel"==this.state.status?s.createElement("div",null,e,t,s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null,"Pinned down software stack found in notebook metadata!",s.createElement("br",null),"The kernel selected does not match the dependencies found for the notebook. ",s.createElement("br",null),"Please install them."))),a):"editing"==this.state.status?s.createElement("div",null,e,n):"saved"==this.state.status?s.createElement("div",null,e,t,"OPTIONS",s.createElement("div",null," Kernel name",s.createElement("input",{title:"Kernel name",className:"thoth-kernel-name-input",type:"text",name:"kernel_name",value:this.state.kernel_name,onChange:this.setKernelName}))):"locking_requirements"==this.state.status?s.createElement("div",null,e,s.createElement("fieldset",null,s.createElement("p",null,"Contacting thoth for advise... please be patient!"))):"installing_requirements"==this.state.status?(this.install(),s.createElement("div",null,e,s.createElement("fieldset",null,s.createElement("p",null,"Requirements locked and saved!",s.createElement("br",null),"Installing new requirements...")))):"setting_kernel"==this.state.status?(this.setKernel(),s.createElement("div",null,e,s.createElement("fieldset",null,s.createElement("p",null,"Requirements locked and saved!",s.createElement("br",null),"Requirements installed!",s.createElement("br",null),"Setting new kernel for your notebook...")))):"failed_no_reqs"==this.state.status?s.createElement("div",null,s.createElement("div",null,s.createElement("button",{title:"Add requirements.",className:M,onClick:()=>this.changeUIstate("loading",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)},"Ok")),s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null,"No requirements have been added please click add after inserting package name!")))):"locking_requirements_using_pipenv"==this.state.status?s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null,"Thoth resolution engine failed... pipenv will be used to lock and install dependencies!"))):"failed"==this.state.status?s.createElement("div",null,e,s.createElement("div",null,s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement("button",{title:"Finish.",className:M,onClick:()=>this.changeUIstate("loading",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)},"Ok")))),s.createElement("div",null,s.createElement("p",null,this.state.error_msg))):"stable"==this.state.status?s.createElement("div",null,e,s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement(T,{addNewRow:this.addNewRow}))),s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null," Everything installed and ready to use!")))):("ready"==this.state.status&&this.props.panel.sessionContext.session.changeKernel({name:this.state.kernel_name}),s.createElement("div",null,e,s.createElement("div",null,s.createElement("div",{className:D},s.createElement("div",{className:A},s.createElement("button",{title:"Reload Page and assign kernel.",className:M,onClick:()=>this.changeUIstate("stable",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,this.state.thoth_config)},"Ok")))),s.createElement("div",null,s.createElement("fieldset",null,s.createElement("p",null,"Requirements locked and saved!",s.createElement("br",null),"Requirements installed!",s.createElement("br",null),"New kernel created!",s.createElement("br",null),"Click ok to start working on your notebook.",s.createElement("br",null))))))}}class H{constructor(){this.openWidget=async()=>{const e=this.panel.content.model.toString();console.log("metadata",e);const t=await(n=this.panel,new Promise((async(e,t)=>{try{if(0==n.model.metadata.has("requirements"))return console.log("requirements key is not in notebook metadata! Initialize requirements for user..."),e({packages:{},requires:{python_version:d(n)},sources:[new h]});const t=n.model.metadata.get("requirements");let s=JSON.parse(t.toString());return 0==c().size(s)?(console.log("requirements key is not in notebook metadata! Initialize requirements for user..."),e({packages:{},requires:{python_version:d(n)},sources:[new h]})):(console.log("requirements key is in notebook metadata!"),e(s))}catch(e){t(e)}})));var n;console.log("requirements",t);const s=await function(e){return new Promise((async(t,n)=>{const s=e.model.metadata;try{0==s.has("requirements_lock")&&(console.log("requirements_lock key is not in notebook metadata!"),t(null));const e=s.get("requirements_lock");var a=JSON.parse(e.toString());console.log("requirements_lock key is in notebook metadata!"),t(a)}catch(e){n(e)}}))}(this.panel);console.log("requirements_lock",s);const r=await function(e){return new Promise((async(t,n)=>{const s=e.model.metadata;try{0==s.has("thoth_config")&&(console.log("thoth_config key is not in notebook metadata!"),t(null));const e=s.get("thoth_config");var a=JSON.parse(e.toString());console.log("thoth_config key is in notebook metadata!"),t(a)}catch(e){n(e)}}))}(this.panel);console.log("Thoth config from notebook metadata",r);const p=i.ReactWidget.create(a().createElement(L,{panel:this.panel,initial_requirements:t,initial_requirements_lock:s,initial_config_file:r}));l.MessageLoop.sendMessage(p,o.Widget.Msg.UpdateRequest);const m={title:"Manage Dependencies",body:p,buttons:[i.Dialog.cancelButton()]};new i.Dialog(m).launch()}}createNew(e,t){this.panel=e;const n=new i.ToolbarButton({label:"Manage Dependencies ...",onClick:this.openWidget,tooltip:"Manage Dependencies ..."});return e.toolbar.insertItem(11,"dependencyManagement",n),n}}const j={dependencyManagement:"notebook:manage-dependencies"},B={id:"jupyterlab_requirements",autoStart:!0,activate:function(e){console.log("jupyterlab-requirements extension is activated!");const t=new H;e.docRegistry.addWidgetExtension("Notebook",t)}}}}]);