(self.webpackChunkjupyterlab_requirements=self.webpackChunkjupyterlab_requirements||[]).push([[778],{778:(e,t,s)=>{"use strict";s.r(t),s.d(t,{commandIDs:()=>L,default:()=>H});var n=s(271),a=s.n(n),i=s(520),l=s(211),r=s(510),o=s(486),c=s.n(o);class h{constructor(e="pypi",t="https://pypi.org/simple",s=!0,n,a){this.name=e,this.url=t,this.verify_ssl=s,this.warehouse=n,this.warehouse_api_url=a}}function d(e){const t=e.content.model.metadata.get("language_info");console.log("language_info:",t);const s=c().get(t,"version");if(console.log("python version identified:",s),null==s)return console.log(`Python version '${s}' is null.`),null;const n=s.match(/\d.\d/);if(console.log("match identified:",n),null==n)throw new Error(`Python version '${s}' does not match required pattern.`);return n[0]}function p(e,t){return new Promise((async(s,n)=>{try{return e.model.metadata.delete(t),s("Removed correctly "+t+" from notebook metadata")}catch(e){n(e)}}))}function m(e,t){const s=e.model.metadata;if(0==s.has("requirements"))s.set("requirements",JSON.stringify(t)),console.log("Notebook requirements have been set successfully.");else{if(console.log("Notebook requirements already exist. Updating..."),1==c().isEmpty(t.packages))throw console.log("Notebook requirements packages is empty..."),new Error(`Packages in notebook requirements is empty: '${t}' `);s.set("requirements",JSON.stringify(t))}}function g(e,t){const s=e.model.metadata;0==s.has("requirements_lock")||console.debug("Notebook requirement_lock already exist. Updating."),s.set("requirements_lock",JSON.stringify(t)),console.log("Notebook requirements_lock have been set successfully.")}var u=s(802);const k=new u.LabIcon({name:"thoth:add-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 52 52" style="enable-background:new 0 0 52 52;" xml:space="preserve">\r\n<g>\r\n    <path d="M26,0C11.664,0,0,11.663,0,26s11.664,26,26,26s26-11.663,26-26S40.336,0,26,0z M26,50C12.767,50,2,39.233,2,26\r\n        S12.767,2,26,2s24,10.767,24,24S39.233,50,26,50z"/>\r\n    <path d="M38.5,25H27V14c0-0.553-0.448-1-1-1s-1,0.447-1,1v11H13.5c-0.552,0-1,0.447-1,1s0.448,1,1,1H25v12c0,0.553,0.448,1,1,1\r\n        s1-0.447,1-1V27h11.5c0.552,0,1-0.447,1-1S39.052,25,38.5,25z"/>\r\n</g>\r\n</svg>\r\n'}),v=new u.LabIcon({name:"thoth:edit-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 330 330" style="enable-background:new 0 0 330 330;" xml:space="preserve">\r\n<g id="XMLID_23_">\r\n    <path id="XMLID_24_" d="M75,180v60c0,8.284,6.716,15,15,15h60c3.978,0,7.793-1.581,10.606-4.394l164.999-165\r\n        c5.858-5.858,5.858-15.355,0-21.213l-60-60C262.794,1.581,258.978,0,255,0s-7.794,1.581-10.606,4.394l-165,165\r\n        C76.58,172.206,75,176.022,75,180z M105,186.213L255,36.213L293.787,75l-150,150H105V186.213z"/>\r\n    <path id="XMLID_27_" d="M315,150.001c-8.284,0-15,6.716-15,15V300H30V30H165c8.284,0,15-6.716,15-15s-6.716-15-15-15H15\r\n        C6.716,0,0,6.716,0,15v300c0,8.284,6.716,15,15,15h300c8.284,0,15-6.716,15-15V165.001C330,156.716,323.284,150.001,315,150.001z"\r\n        />\r\n</g>\r\n</svg>\r\n'}),_=new u.LabIcon({name:"thoth:delete-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 473 473" style="enable-background:new 0 0 473 473;" xml:space="preserve">\r\n<g>\r\n    <path d="M324.285,215.015V128h20V38h-98.384V0H132.669v38H34.285v90h20v305h161.523c23.578,24.635,56.766,40,93.477,40\r\n        c71.368,0,129.43-58.062,129.43-129.43C438.715,277.276,388.612,222.474,324.285,215.015z M294.285,215.015\r\n        c-18.052,2.093-34.982,7.911-50,16.669V128h50V215.015z M162.669,30h53.232v8h-53.232V30z M64.285,68h250v30h-250V68z M84.285,128\r\n        h50v275h-50V128z M164.285,403V128h50v127.768c-21.356,23.089-34.429,53.946-34.429,87.802c0,21.411,5.231,41.622,14.475,59.43\r\n        H164.285z M309.285,443c-54.826,0-99.429-44.604-99.429-99.43s44.604-99.429,99.429-99.429s99.43,44.604,99.43,99.429\r\n        S364.111,443,309.285,443z"/>\r\n    <polygon points="342.248,289.395 309.285,322.358 276.323,289.395 255.11,310.608 288.073,343.571 255.11,376.533 276.323,397.746\r\n        309.285,364.783 342.248,397.746 363.461,376.533 330.498,343.571 363.461,310.608     "/>\r\n</g>\r\n</svg>\r\n'}),w=new u.LabIcon({name:"thoth:installed-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">\r\n<rect style="fill:#32BEA6;" width="512" height="512"/>\r\n<polygon style="fill:#FFFFFF;" points="203.728,392.144 104.512,305.392 125.584,281.296 200.144,346.496 383.776,126.128\r\n    408.368,146.64 "/>\r\n<g>\r\n</g>\r\n</svg>\r\n'}),E=new u.LabIcon({name:"thoth:not-installed-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     viewBox="0 0 511.996 511.996" style="enable-background:new 0 0 511.996 511.996;" xml:space="preserve">\r\n<rect x="0.02" y="0.008" style="fill:#E21B1B;" width="511.956" height="511.988"/>\r\n<g>\r\n\r\n        <rect x="247.999" y="98.14" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -106.0433 256.0008)" style="fill:#FFFFFF;" width="15.999" height="315.731"/>\r\n\r\n        <rect x="98.133" y="247.993" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -106.0334 255.9967)" style="fill:#FFFFFF;" width="315.731" height="15.999"/>\r\n</g>\r\n</svg>\r\n'}),b="thoth-row-button";class y extends n.Component{constructor(e){super(e),this.state={name:"",version:"*"},this.handleChange=this.handleChange.bind(this),this.handleItemDeleted=this.handleItemDeleted.bind(this),this.handleItemEdited=this.handleItemEdited.bind(this),this.showIfInstalled=this.showIfInstalled.bind(this)}handleChange(e){"package_name"==e.target.name&&this.setState({name:e.target.value}),"package_version"==e.target.name&&this.setState({version:e.target.value})}handleItemDeleted(e){this.props.deleteSavedRow(e)}handleItemEdited(e,t){this.props.editSavedRow(e,t)}showIfInstalled(e){return"Y"==e?n.createElement(w.react,{elementPosition:"center",width:"30px",height:"30px"}):n.createElement(E.react,{elementPosition:"center",width:"30px",height:"30px"})}render(){var e=this;return n.createElement("tr",null,n.createElement("td",null,n.createElement("input",{name:"package_name",type:"text",value:this.props.name,className:"thoth-package-name-input",disabled:!0})),n.createElement("td",null,n.createElement("input",{name:"package_version",type:"text",value:this.props.version,className:"thoth-constraint-input",disabled:!0})),n.createElement("td",null,e.showIfInstalled(this.props.installed)),n.createElement("td",null,n.createElement("td",null,n.createElement("button",{title:"Add package",className:"thoth-row-button-deactivated",type:"button",disabled:!0},n.createElement(k.react,{elementPosition:"center",width:"20px",height:"20px",display:"inline-block"}))),n.createElement("td",null,n.createElement("button",{title:"Edit saved package",className:b,type:"button",onClick:e.handleItemEdited.bind(e,this.props.name,this.props.version)},n.createElement(v.react,{elementPosition:"center",width:"20px",height:"20px",display:"inline-block"}))),n.createElement("td",null,n.createElement("button",{title:"Delete saved package",className:b,type:"button",onClick:e.handleItemDeleted.bind(e,this.props.name)},n.createElement(_.react,{elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})))))}}const f="thoth-row-button",x="thoth-row-button-deactivated";class q extends n.Component{constructor(e){super(e),this.state={isAdded:!1,isEditable:!1,name:"",version:"*"},this.handleItemAdded=this.handleItemAdded.bind(this),this.handleChange=this.handleChange.bind(this),this.handleItemDeleted=this.handleItemDeleted.bind(this),this.showIfInstalled=this.showIfInstalled.bind(this)}handleChange(e){"package_name"==e.target.name&&this.setState({name:e.target.value}),"package_version"==e.target.name&&this.setState({version:e.target.value})}handleItemAdded(){var e=this.state.name.toString(),t=this.state.version.toString();this.props.storeRow(e,t),this.setState({isAdded:!0,isEditable:!0})}handleItemDeleted(e){this.props.deleteRow(e)}showIfInstalled(e){return"Y"==e?n.createElement(w.react,{tag:"div",elementPosition:"center",width:"30px",height:"30px",display:"inline-block"}):n.createElement(E.react,{tag:"div",elementPosition:"center",width:"30px",height:"30px",display:"inline-block"})}handleItemEdited(e){this.props.editRow(e),this.setState({isAdded:!1,isEditable:!1})}render(){var e=this;let t,s;return t=this.state.isAdded?n.createElement("button",{title:"Include new package",className:x,type:"button",disabled:!0},n.createElement(k.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})):n.createElement("button",{title:"Include new package",className:f,type:"button",onClick:e.handleItemAdded.bind(e)},n.createElement(k.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})),s=this.state.isEditable?n.createElement("button",{title:"Edit package",className:f,type:"button",onClick:e.handleItemEdited.bind(e,this.state.name)},n.createElement(v.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})):n.createElement("button",{title:"Edit package",className:x,type:"button",disabled:!0},n.createElement(v.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})),n.createElement("tr",null,n.createElement("td",null,n.createElement("input",{name:"package_name",type:"text",value:this.state.name,className:"thoth-package-name-input",onChange:this.handleChange})),n.createElement("td",null,n.createElement("input",{name:"package_version",type:"text",value:this.state.version,className:"thoth-constraint-input",onChange:this.handleChange})),n.createElement("td",null,e.showIfInstalled(this.props.installed)),n.createElement("td",null,n.createElement("td",null,t),n.createElement("td",null,s),n.createElement("td",null,n.createElement("button",{title:"Delete new package",className:f,type:"button",onClick:e.handleItemDeleted.bind(e,this.state.name)},n.createElement(_.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"})))))}}const S="thoth-table";class I extends n.Component{constructor(e){super(e),this.state={headers:["Package","Constraint","Installed","Actions"]}}renderTableHeader(){var e=[];const t=this.state.headers;return c().forEach(t,(function(t){e.push(n.createElement("th",{className:{THOTH_TABLE:S}},t.toUpperCase()))})),e}renderRows(){var e=this,t=this.props.packages,s=this.props.initial_packages,a=this.props.installed_packages,i=[];for(let[l,r]of Object.entries(s))c().has(a,l)?i.push(n.createElement(y,{name:l,version:r,installed:"Y",packages:t,editSavedRow:e.props.editSavedRow,deleteSavedRow:e.props.deleteSavedRow})):i.push(n.createElement(y,{name:l,version:r,installed:"N",packages:t,editSavedRow:e.props.editSavedRow,deleteSavedRow:e.props.deleteSavedRow}));for(let[s,a]of Object.entries(t))i.push(n.createElement(q,{name:s,installed:"N",packages:t,editRow:e.props.editRow,storeRow:e.props.storeRow,deleteRow:e.props.deleteRow}));return i}render(){return n.createElement("table",{id:S,className:S},n.createElement("thead",{className:{THOTH_TABLE:S}},n.createElement("tr",{id:S,className:S},this.renderTableHeader())),n.createElement("tbody",{className:{THOTH_TABLE:S}},this.renderRows()))}}class N extends n.Component{constructor(e){super(e)}render(){return n.createElement(I,{packages:this.props.packages,initial_packages:this.props.initial_packages,installed_packages:this.props.installed_packages,editRow:this.props.editRow,storeRow:this.props.storeRow,editSavedRow:this.props.editSavedRow,deleteRow:this.props.deleteRow,deleteSavedRow:this.props.deleteSavedRow})}}const R=new u.LabIcon({name:"thoth:save-button-icon",svgstr:'<?xml version="1.0" encoding="iso-8859-1"?>\r\n\x3c!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\r\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\r\n<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\r\n     width="356.725px" height="356.725px" viewBox="0 0 356.725 356.725" style="enable-background:new 0 0 356.725 356.725;"\r\n     xml:space="preserve">\r\n<g>\r\n    <g>\r\n        <path d="M307.463,0h-46.35H95.611H49.259C27.905,0,10.53,17.381,10.53,38.73v279.264c0,21.352,17.375,38.73,38.729,38.73H124.3\r\n            h108.125h75.037c21.357,0,38.732-17.379,38.732-38.73V38.73C346.196,17.381,328.821,0,307.463,0z M251.43,19.365v121.922H105.295\r\n            V19.365H251.43z M133.981,337.359v-93.593h88.761v93.593H133.981z M326.83,317.994c0,10.676-8.686,19.365-19.366,19.365h-65.355\r\n            V234.084c0-5.352-4.334-9.682-9.683-9.682H124.301c-5.348,0-9.684,4.33-9.684,9.682v103.275H49.26\r\n            c-10.681,0-19.366-8.689-19.366-19.365V38.73c0-10.674,8.686-19.365,19.366-19.365h36.669v131.604\r\n            c0,5.344,4.335,9.684,9.683,9.684h165.503c5.346,0,9.682-4.34,9.682-9.684V19.365h36.668c10.682,0,19.366,8.691,19.366,19.365\r\n            L326.83,317.994L326.83,317.994z"/>\r\n        <path d="M127.043,123.898h102.64c5.347,0,9.681-4.34,9.681-9.684c0-5.351-4.334-9.682-9.681-9.682h-102.64\r\n            c-5.348,0-9.684,4.331-9.684,9.682C117.359,119.558,121.695,123.898,127.043,123.898z"/>\r\n        <path d="M127.043,90.009h102.64c5.347,0,9.681-4.34,9.681-9.684c0-5.352-4.334-9.682-9.681-9.682h-102.64\r\n            c-5.348,0-9.684,4.33-9.684,9.682C117.359,85.67,121.695,90.009,127.043,90.009z"/>\r\n        <path d="M127.043,56.119h102.64c5.347,0,9.681-4.339,9.681-9.682c0-5.352-4.334-9.682-9.681-9.682h-102.64\r\n            c-5.348,0-9.684,4.33-9.684,9.682C117.359,51.78,121.695,56.119,127.043,56.119z"/>\r\n        <path d="M203.78,253.441c-5.35,0-9.684,4.34-9.684,9.682v27.439c0,5.344,4.334,9.684,9.684,9.684c5.347,0,9.683-4.34,9.683-9.684\r\n            v-27.439C213.462,257.781,209.126,253.441,203.78,253.441z"/>\r\n    </g>\r\n</g>\r\n</svg>\r\n'});class C extends n.Component{constructor(e){super(e)}saveRequirements(){this.props.onSave()}render(){return n.createElement("button",{title:"Save dependencies",className:"thoth-save-button",type:"button",onClick:this.saveRequirements.bind(this)},n.createElement(R.react,{tag:"div",elementPosition:"center",right:"7px",top:"5px",width:"20px",height:"20px"}))}}class O extends n.Component{constructor(e){super(e)}onInstall(){this.props.install()}render(){return n.createElement("button",{title:"Install dependencies",className:"thoth-install-button",onClick:this.onInstall.bind(this)},"Install")}}class P extends n.Component{constructor(e){super(e)}addNewEmptyRow(){this.props.addNewRow()}render(){return n.createElement("button",{title:"Add new line! Only one empty line is displayed.",className:"thoth-new-package-button",type:"button",onClick:this.addNewEmptyRow.bind(this)},n.createElement(k.react,{tag:"div",elementPosition:"center",width:"20px",height:"20px",display:"inline-block"}))}}var T=s(629),U=s(683);async function V(e="",t={}){const s=U.ServerConnection.makeSettings(),n=T.URLExt.join(s.baseUrl,"jupyterlab_requirements",e);let a;try{a=await U.ServerConnection.makeRequest(n,t,s)}catch(e){throw new U.ServerConnection.NetworkError(e)}const i=await a.json();if(!a.ok)throw new U.ServerConnection.ResponseError(a,i.message);return i}const z="thoth-ok-button",M="thoth-container-button",J="thoth-container-button-centre";class A extends n.Component{constructor(e){super(e),this.onStart=this.onStart.bind(this),this.changeUIstate=this.changeUIstate.bind(this),this.addNewRow=this.addNewRow.bind(this),this.editRow=this.editRow.bind(this),this.editSavedRow=this.editSavedRow.bind(this),this.storeRow=this.storeRow.bind(this),this.deleteRow=this.deleteRow.bind(this),this.deleteSavedRow=this.deleteSavedRow.bind(this),this.onSave=this.onSave.bind(this),this.checkInstalledPackages=this.checkInstalledPackages.bind(this),this.lock_using_thoth=this.lock_using_thoth.bind(this),this.lock_using_pipenv=this.lock_using_pipenv.bind(this),this.install=this.install.bind(this),this.setKernel=this.setKernel.bind(this),this.createConfig=this.createConfig.bind(this),this.setKernelName=this.setKernelName.bind(this),this.setRecommendationType=this.setRecommendationType.bind(this),this.state={kernel_name:"jupyterlab_requirements",recommendation_type:"latest",status:"loading",packages:{},initial_packages:{},installed_packages:{},deleted_packages:{},requirements:{packages:{},requires:{python_version:d(this.props.panel)},sources:[new h]},error_msg:void 0}}changeUIstate(e,t,s,n,a,i,l,r){var o=this.state;console.log("initial",o),c().set(o,"status",e),c().set(o,"packages",t),c().set(o,"initial_packages",s),c().set(o,"installed_packages",n),c().set(o,"deleted_packages",a),c().set(o,"requirements",i),c().set(o,"kernel_name",l),c().set(o,"error_msg",r),console.log("new",o),this.setState(o)}setRecommendationType(e){this.setState({recommendation_type:e})}changeRecommendationType(e){const t=e.target.value;this.setRecommendationType(t)}setKernelName(e){const t=e.target.value;this.setState({kernel_name:t})}addNewRow(){const e=this.state.packages;c().set(e,"",""),console.log("added package",e),this.changeUIstate("editing",e,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}editRow(e){const t=this.state.packages;c().unset(t,e),c().set(t,"","*"),console.log("After editing (current)",t),this.changeUIstate("editing",t,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}editSavedRow(e,t){const s=this.state.initial_packages,n=this.state.packages;c().unset(s,e),c().set(n,e,t),console.log("After editing (initial)",s),console.log("After editing (current)",n),this.changeUIstate("editing",n,s,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}deleteRow(e){const t=this.state.packages,s={};c().unset(t,e),console.log("After deleting",t),c().set(s,e,"*"),console.log("Deleted",s),this.changeUIstate("editing",t,this.state.initial_packages,this.state.installed_packages,s,this.state.requirements,this.state.kernel_name)}deleteSavedRow(e){const t=this.state.initial_packages;c().unset(t,e),console.log("After deleting saved",t);const s={};c().set(s,e,"*"),console.log("Deleted",s),this.changeUIstate("editing",this.state.packages,t,this.state.installed_packages,s,this.state.requirements,this.state.kernel_name)}storeRow(e,t){let s=this.state.packages;c().set(s,e,t);const n={};c().forIn(s,(function(e,t){console.log(t+" goes "+e),""!=t&&c().set(n,t,e)})),console.log("new packages",n),this.changeUIstate("editing",n,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}onSave(){const e=this.state.deleted_packages,t=this.state.requirements,s=this.state.packages;console.log("added_packages",s);const n=this.state.initial_packages;console.log("initial_packages",n);const a={};c().forIn(n,(function(e,t){0==c().has(n,"")&&c().set(a,t,e)}));const i={};if(c().forIn(s,(function(e,t){0==c().has(s,"")&&(c().set(a,t,e),c().set(i,t,e))})),c().size(e)>0){if(c().size(a)>0)return void this.lock_using_thoth();p(this.props.panel,"requirements"),p(this.props.panel,"requirements_lock"),p(this.props.panel,"thoth_config"),this.props.panel.context.save();var l={packages:a,requires:t.requires,sources:[new h]};this.changeUIstate("initial",i,this.state.initial_packages,this.state.installed_packages,{},l,this.state.kernel_name)}if(c().size(a)>0){if(c().isEqual(a,this.state.installed_packages)){var r={packages:a,requires:t.requires,sources:t.sources};return m(this.props.panel,r),this.props.panel.context.save(),void this.changeUIstate("stable",{},this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}console.log("total packages",a);var o={packages:a,requires:t.requires,sources:t.sources};return console.log("Requirements before installing are: ",o),m(this.props.panel,o),this.props.panel.context.save(),void this.changeUIstate("saved",{},a,this.state.installed_packages,this.state.deleted_packages,o,this.state.kernel_name)}return l={packages:a,requires:t.requires,sources:[new h]},console.log("Requirements are: ",l),m(this.props.panel,l),void this.changeUIstate("failed_no_reqs",i,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}async install(){try{const e=await async function(e,t={}){const s={kernel_name:e},n="kernel/install";try{return await V(n,{body:JSON.stringify(s),method:"POST"})}catch(e){console.error("Error on POST /jupyterlab_requirements/"+n+":",e)}}(this.state.kernel_name);return console.log("Install message",e),void this.changeUIstate("setting_kernel",{},this.state.initial_packages,this.state.initial_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}catch(e){console.log("Error installing requirements",e),this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,"Error install dependencies in the new virtual environment, please contact Thoth team.")}}async store_dependencies_on_disk(e,t,s,n){const a=await async function(e,t,s,n=".local/share/thoth/kernels",a=!0,i={}){const l={kernel_name:e,requirements:t,requirement_lock:s,path_to_store:n,using_home_path_base:a},r="file/dependencies";try{return await V(r,{body:JSON.stringify(l),method:"POST"})}catch(e){console.error("Error on POST /jupyterlab_requirements/"+r+":",e)}}(this.state.kernel_name,JSON.stringify(e),JSON.stringify(t),s,n);console.log("Store message",a)}async setKernel(){try{const e=await async function(e,t={}){const s={kernel_name:e},n="kernel/create";try{return await V(n,{body:JSON.stringify(s),method:"POST"})}catch(e){console.error("Error on POST /jupyterlab_requirements/"+n+":",e)}}(this.state.kernel_name);return console.log("Kernel message",e),void this.changeUIstate("ready",{},this.state.initial_packages,this.state.initial_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)}catch(e){return console.log("Error creating jupyter kernel",e),void this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,"Error setting new environment in a jupyter kernel, please contact Thoth team.")}}async lock_using_thoth(){this.changeUIstate("locking_requirements",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name);const e=await this.createConfig();c().isUndefined(e)&&(console.log("Thoth config is undefined"),this.lock_using_pipenv());const t=e.runtime_environments,s=t[0];c().set(s,"recommendation_type",this.state.recommendation_type),c().set(t,0,s),c().set(e,"runtime_environments",t),console.log("thoth config submitted",JSON.stringify(e));const n=this.state.requirements;console.log("Requirements submitted",JSON.stringify(n));try{const t=await async function(e,t,s,n={}){const a={kernel_name:e,thoth_config:t,requirements:s},i="thoth/resolution";try{const e=await V(i,{body:JSON.stringify(a),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/"+i+":",e)}}(this.state.kernel_name,JSON.stringify(e),JSON.stringify(n));if(console.log("Advise received",t),0==t.error){if(0==c().isEmpty(t.requirements.packages))return m(this.props.panel,t.requirements),g(this.props.panel,t.requirement_lock),function(e,t){const s=e.model.metadata;0==s.has("thoth_config")||console.debug("Notebook Thoth config already exist. Updating."),s.set("thoth_config",JSON.stringify(t)),console.log("Notebook Thoth config have been set successfully.")}(this.props.panel,e),this.props.panel.context.save(),await this.store_dependencies_on_disk(t.requirements,t.requirement_lock,"overlays",!1),void this.changeUIstate("installing_requirements",{},this.state.initial_packages,this.state.installed_packages,{},t.requirements,this.state.kernel_name);console.log("Advise requirements packages received is empty",t.requirements),this.lock_using_pipenv()}else this.lock_using_pipenv()}catch(e){console.log("Error locking requirements with Thoth",e),this.lock_using_pipenv()}}async lock_using_pipenv(){this.changeUIstate("locking_requirements_using_pipenv",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name);const e=this.state.requirements;console.log("Requirements for pipenv",JSON.stringify(e));try{const t=await async function(e,t,s={}){const n={kernel_name:e,requirements:t};try{const e=await V("pipenv",{body:JSON.stringify(n),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/pipenv:",e)}}(this.state.kernel_name,JSON.stringify(e));return console.log("Result received",t),0==t.error?(g(this.props.panel,t.requirements_lock),this.props.panel.context.save(),await this.store_dependencies_on_disk(e,t.requirements_lock,"overlays",!1),void this.changeUIstate("installing_requirements",{},this.state.initial_packages,this.state.installed_packages,{},e,this.state.kernel_name)):void this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,"No resolution engine was able to install dependendices, please contact Thoth team.")}catch(e){return console.log("Error locking requirements with pipenv",e),void this.changeUIstate("failed",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name,"No resolution engine was able to install dependendices, please contact Thoth team.")}}async onStart(){var e=this.props.initial_requirements;console.log("initial requirements",e);var t=e.packages;if(0==c().size(t))return void this.changeUIstate(status="initial",this.state.packages,t,this.state.installed_packages,this.state.deleted_packages,e,this.state.kernel_name);const s=this.props.initial_requirements_lock;if(console.log("initial requirements lock",s),null==s)return void this.changeUIstate(status="only_install",this.state.packages,t,this.state.installed_packages,this.state.deleted_packages,e,this.state.kernel_name);const n={};c().forIn(s.default,(function(e,t){c().set(n,t,e.version.replace("==",""))})),console.log(n);const a=function(e){const t=e.content.model.metadata.get("kernelspec");console.log("kernel info:",t);const s=c().get(t,"name");return console.log("kernel_name identified:",s),s}(this.props.panel),i={};c().forIn(t,(function(e,t){c().has(n,t.toLowerCase())&&c().set(i,t,e)})),console.log("initial packages",t),console.log("packages in req and req lock",i);const l=await this.retrieveInstalledPackages(a,n),r={};if(c().forIn(t,(function(e,t){c().has(l,t.toLowerCase())&&c().set(r,t,e)})),console.log("initial installed packages",r),c().isEqual(c().size(t),c().size(i)))return 1==await this.checkInstalledPackages(l,n)?void this.changeUIstate("stable",this.state.packages,t,t,this.state.deleted_packages,e,a):void this.changeUIstate("only_install_kernel",this.state.packages,t,r,this.state.deleted_packages,e,a);this.changeUIstate("only_install_kernel",this.state.packages,t,r,this.state.deleted_packages,e,a)}async retrieveInstalledPackages(e,t){const s=await async function(e,t={}){const s={kernel_name:e},n="kernel/packages";try{const e=await V(n,{body:JSON.stringify(s),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/"+n+":",e)}}(e);console.log("packages installed (pip list)",s);const n={};return c().forIn(s,(function(e,s){c().has(t,s.toLowerCase())&&c().get(t,s.toLowerCase())==e&&c().set(n,s,e)})),console.log("Installed packages:",n),n}async checkInstalledPackages(e,t){return!!c().isEqual(c().size(t),c().size(e))}async createConfig(){const e=await async function(e,t={}){const s={kernel_name:e};try{const e=await V("thoth/config",{body:JSON.stringify(s),method:"POST"});return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error on POST /jupyterlab_requirements/thoth/config:",e)}}(this.state.kernel_name);return console.log("Config file",e),e}render(){let e=n.createElement("div",null,n.createElement(N,{initial_packages:this.state.initial_packages,installed_packages:this.state.installed_packages,packages:this.state.packages,editRow:this.editRow,storeRow:this.storeRow,deleteRow:this.deleteRow,editSavedRow:this.editSavedRow,deleteSavedRow:this.deleteSavedRow})),t=n.createElement("div",null,n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement(P,{addNewRow:this.addNewRow}))),n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement(O,{changeUIstate:this.changeUIstate,install:this.lock_using_thoth})))),s=n.createElement("div",null,n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement(P,{addNewRow:this.addNewRow}))),n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement(C,{onSave:this.onSave,changeUIstate:this.changeUIstate})))),a=n.createElement("div",null,n.createElement("section",null,n.createElement("h2",null,"OPTIONS")),n.createElement("form",null,n.createElement("label",null,"Kernel name:",n.createElement("input",{title:"Kernel name",type:"text",name:"kernel_name",value:this.state.kernel_name,onChange:this.setKernelName})),n.createElement("br",null),n.createElement("label",null,"Recommendation type:",n.createElement("select",{onChange:()=>this.changeRecommendationType},'title="Recommendation Type" name="recommendation_type" value=',this.state.recommendation_type,n.createElement("option",{value:"latest"},"latest"),n.createElement("option",{value:"performance"},"performance"),n.createElement("option",{value:"security"},"security"),n.createElement("option",{value:"stable"},"stable")))));return"loading"==this.state.status?(this.onStart(),n.createElement("div",null,"Loading...")):"initial"==this.state.status?n.createElement("div",null,n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement(P,{addNewRow:this.addNewRow}))),n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null," No dependencies found! Click New to add package. ")))):"no_reqs_to_save"==this.state.status?n.createElement("div",null,e,s,n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null," Dependencies missing! Click New to add package. ")))):"only_install"==this.state.status?n.createElement("div",null,e,t,n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null,"Dependencies found in notebook metadata but lock file is missing. "))),a):"only_install_kernel"==this.state.status?n.createElement("div",null,e,t,n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null,"Pinned down software stack found in notebook metadata!",n.createElement("br",null),"The kernel selected does not match the dependencies found for the notebook. ",n.createElement("br",null),"Please install them."))),a):"editing"==this.state.status?n.createElement("div",null,e,s):"saved"==this.state.status?n.createElement("div",null,e,t,"OPTIONS",n.createElement("div",null," Kernel name",n.createElement("input",{title:"Kernel name",className:"thoth-kernel-name-input",type:"text",name:"kernel_name",value:this.state.kernel_name,onChange:this.setKernelName}))):"locking_requirements"==this.state.status?n.createElement("div",null,e,n.createElement("fieldset",null,n.createElement("p",null,"Contacting thoth for advise... please be patient!"))):"installing_requirements"==this.state.status?(this.install(),n.createElement("div",null,e,n.createElement("fieldset",null,n.createElement("p",null,"Requirements locked and saved!",n.createElement("br",null),"Installing new requirements...")))):"setting_kernel"==this.state.status?(this.setKernel(),n.createElement("div",null,e,n.createElement("fieldset",null,n.createElement("p",null,"Requirements locked and saved!",n.createElement("br",null),"Requirements installed!",n.createElement("br",null),"Setting new kernel for your notebook...")))):"failed_no_reqs"==this.state.status?n.createElement("div",null,n.createElement("div",null,n.createElement("button",{title:"Add requirements.",className:z,onClick:()=>this.changeUIstate("loading",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)},"Ok")),n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null,"No requirements have been added please click add after inserting package name!")))):"locking_requirements_using_pipenv"==this.state.status?n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null,"Thoth resolution engine failed... pipenv will be used to lock and install dependencies!"))):"failed"==this.state.status?n.createElement("div",null,e,n.createElement("div",null,n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement("button",{title:"Finish.",className:z,onClick:()=>this.changeUIstate("loading",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)},"Ok")))),n.createElement("div",null,n.createElement("p",null,this.state.error_msg))):"stable"==this.state.status?n.createElement("div",null,e,n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement(P,{addNewRow:this.addNewRow}))),n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null," Everything installed and ready to use!")))):("ready"==this.state.status&&this.props.panel.sessionContext.session.changeKernel({name:this.state.kernel_name}),n.createElement("div",null,e,n.createElement("div",null,n.createElement("div",{className:M},n.createElement("div",{className:J},n.createElement("button",{title:"Reload Page and assign kernel.",className:z,onClick:()=>this.changeUIstate("stable",this.state.packages,this.state.initial_packages,this.state.installed_packages,this.state.deleted_packages,this.state.requirements,this.state.kernel_name)},"Ok")))),n.createElement("div",null,n.createElement("fieldset",null,n.createElement("p",null,"Requirements locked and saved!",n.createElement("br",null),"Requirements installed!",n.createElement("br",null),"New kernel created!",n.createElement("br",null),"Click ok to start working on your notebook.",n.createElement("br",null))))))}}class D{constructor(){this.openWidget=async()=>{const e=this.panel.content.model.toString();console.log("metadata",e);const t=await(s=this.panel,new Promise((async(e,t)=>{try{if(0==s.model.metadata.has("requirements"))return console.log("requirements key is not in notebook metadata! Initialize requirements for user..."),e({packages:{},requires:{python_version:d(s)},sources:[new h]});const t=s.model.metadata.get("requirements");let n=JSON.parse(t.toString());return 0==c().size(n)?(console.log("requirements key is not in notebook metadata! Initialize requirements for user..."),e({packages:{},requires:{python_version:d(s)},sources:[new h]})):(console.log("requirements key is in notebook metadata!"),e(n))}catch(e){t(e)}})));var s;console.log("requirements",t);const n=await function(e){return new Promise((async(t,s)=>{const n=e.model.metadata;try{0==n.has("requirements_lock")&&(console.log("requirements_lock key is not in notebook metadata!"),t(null));const e=n.get("requirements_lock");var a=JSON.parse(e.toString());console.log("requirements_lock key is in notebook metadata!"),t(a)}catch(e){s(e)}}))}(this.panel);console.log("requirements_lock",n);const o=function(e){let t=e.model.metadata.get("thoth_config");return null==t?(console.log("thoth_config key is not in notebook metadata!"),null):JSON.parse(JSON.stringify(t))}(this.panel);console.log("Thoth config from notebook metadata",o);const p=i.ReactWidget.create(a().createElement(A,{panel:this.panel,initial_requirements:t,initial_requirements_lock:n,initial_config_file:o}));l.MessageLoop.sendMessage(p,r.Widget.Msg.UpdateRequest);const m={title:"Manage Dependencies",body:p,buttons:[i.Dialog.cancelButton()]};new i.Dialog(m).launch()}}createNew(e,t){this.panel=e;const s=new i.ToolbarButton({label:"Manage Dependencies ...",onClick:this.openWidget,tooltip:"Manage Dependencies ..."});return e.toolbar.insertItem(10,"dependencyManagement",s),s}}const L={dependencyManagement:"notebook:manage-dependencies"},H={id:"jupyterlab_requirements",autoStart:!0,activate:function(e){const t=new D;e.docRegistry.addWidgetExtension("Notebook",t)}}}}]);