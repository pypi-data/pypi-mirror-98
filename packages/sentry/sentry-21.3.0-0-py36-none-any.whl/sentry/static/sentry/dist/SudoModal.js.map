{"version":3,"sources":["webpack:///./app/components/u2f/u2fContainer.tsx","webpack:///./app/components/modals/sudoModal.tsx"],"names":["U2fContainer","state","authenticators","this","getAuthenticators","api","props","requestPromise","setState","className","length","map","auth","id","challenge","key","challengeData","React","Component","withApi","SudoModal","error","busy","handleSuccess","closeModal","superuser","location","router","retryRequest","replace","pathname","forceUpdate","Date","then","handleError","handleU2fTap","data","a","method","user","ConfigStore","get","hasPasswordAuth","Fragment","StyledTextBlock","t","StyledAlert","type","icon","size","apiMethod","apiEndpoint","submitLabel","onSubmitSuccess","onSubmitError","hideFooter","resetOnError","StyledInputField","inline","label","name","autoFocus","flexibleControlStateSize","displayMode","onTap","priority","href","encodeURIComponent","Header","Body","closeButton","onHide","renderBodyContent","withRouter","TextBlock","space","InputField","Alert"],"mappings":"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","file":"SudoModal.js","sourcesContent":["import React from 'react';\n\nimport {Client} from 'app/api';\nimport {Authenticator} from 'app/types';\nimport withApi from 'app/utils/withApi';\n\nimport U2fSign from './u2fsign';\n\ntype Props = {\n  api: Client;\n  onTap: U2fSign['props']['onTap'];\n  displayMode?: U2fSign['props']['displayMode'];\n  className?: string;\n};\ntype State = {\n  authenticators: Array<Authenticator>;\n};\n\nclass U2fContainer extends React.Component<Props, State> {\n  state: State = {\n    authenticators: [],\n  };\n  componentDidMount() {\n    this.getAuthenticators();\n  }\n\n  async getAuthenticators() {\n    const {api} = this.props;\n\n    try {\n      const authenticators = await api.requestPromise('/authenticators/');\n      this.setState({authenticators: authenticators ?? []});\n    } catch {\n      // ignore errors\n    }\n  }\n\n  render() {\n    const {className} = this.props;\n    const {authenticators} = this.state;\n\n    if (!authenticators.length) {\n      return null;\n    }\n\n    return (\n      <div className={className}>\n        {authenticators.map(auth =>\n          auth.id === 'u2f' && auth.challenge ? (\n            <U2fSign key={auth.id} {...this.props} challengeData={auth.challenge} />\n          ) : null\n        )}\n      </div>\n    );\n  }\n}\n\nexport default withApi(U2fContainer);\n","import React from 'react';\nimport {withRouter} from 'react-router';\nimport {WithRouterProps} from 'react-router/lib/withRouter';\nimport styled from '@emotion/styled';\n\nimport {ModalRenderProps} from 'app/actionCreators/modal';\nimport {Client} from 'app/api';\nimport Alert from 'app/components/alert';\nimport Button from 'app/components/button';\nimport U2fContainer from 'app/components/u2f/u2fContainer';\nimport {IconFlag} from 'app/icons';\nimport {t} from 'app/locale';\nimport ConfigStore from 'app/stores/configStore';\nimport space from 'app/styles/space';\nimport withApi from 'app/utils/withApi';\nimport Form from 'app/views/settings/components/forms/form';\nimport InputField from 'app/views/settings/components/forms/inputField';\nimport TextBlock from 'app/views/settings/components/text/textBlock';\n\ntype OnTapProps = NonNullable<React.ComponentProps<typeof U2fContainer>['onTap']>;\n\ntype Props = WithRouterProps &\n  Pick<ModalRenderProps, 'Body' | 'Header'> & {\n    api: Client;\n    closeModal: () => void;\n    /**\n     * User is a superuser without an active su session\n     */\n    superuser?: boolean;\n    /**\n     * expects a function that returns a Promise\n     */\n    retryRequest?: () => Promise<any>;\n  };\n\ntype State = {\n  error: boolean;\n  busy: boolean;\n};\n\nclass SudoModal extends React.Component<Props, State> {\n  state: State = {\n    error: false,\n    busy: false,\n  };\n\n  handleSuccess = () => {\n    const {closeModal, superuser, location, router, retryRequest} = this.props;\n\n    if (!retryRequest) {\n      closeModal();\n      return;\n    }\n\n    if (superuser) {\n      router.replace({pathname: location.pathname, state: {forceUpdate: new Date()}});\n      return;\n    }\n\n    this.setState({busy: true}, () => {\n      retryRequest().then(() => {\n        this.setState({busy: false}, closeModal);\n      });\n    });\n  };\n\n  handleError = () => {\n    this.setState({busy: false, error: true});\n  };\n\n  handleU2fTap = async (data: Parameters<OnTapProps>[0]) => {\n    this.setState({busy: true});\n\n    const {api} = this.props;\n\n    try {\n      await api.requestPromise('/auth/', {method: 'PUT', data});\n      this.handleSuccess();\n    } catch (err) {\n      this.setState({busy: false});\n      // u2fInterface relies on this\n      throw err;\n    }\n  };\n\n  renderBodyContent() {\n    const {superuser} = this.props;\n    const {error} = this.state;\n    const user = ConfigStore.get('user');\n\n    if (!user.hasPasswordAuth) {\n      return (\n        <React.Fragment>\n          <TextBlock>{t('You will need to reauthenticate to continue.')}</TextBlock>\n          <Button\n            priority=\"primary\"\n            href={`/auth/login/?next=${encodeURIComponent(location.pathname)}`}\n          >\n            {t('Continue')}\n          </Button>\n        </React.Fragment>\n      );\n    }\n\n    return (\n      <React.Fragment>\n        <StyledTextBlock>\n          {superuser\n            ? t(\n                'You are attempting to access a resource that requires superuser access, please re-authenticate as a superuser.'\n              )\n            : t('Help us keep your account safe by confirming your identity.')}\n        </StyledTextBlock>\n\n        {error && (\n          <StyledAlert type=\"error\" icon={<IconFlag size=\"md\" />}>\n            {t('Incorrect password')}\n          </StyledAlert>\n        )}\n\n        <Form\n          apiMethod=\"PUT\"\n          apiEndpoint=\"/auth/\"\n          submitLabel={t('Confirm Password')}\n          onSubmitSuccess={this.handleSuccess}\n          onSubmitError={this.handleError}\n          hideFooter={!user.hasPasswordAuth}\n          resetOnError\n        >\n          <StyledInputField\n            type=\"password\"\n            inline={false}\n            label={t('Password')}\n            name=\"password\"\n            autoFocus\n            flexibleControlStateSize\n          />\n          <U2fContainer displayMode=\"sudo\" onTap={this.handleU2fTap} />\n        </Form>\n      </React.Fragment>\n    );\n  }\n\n  render() {\n    const {closeModal, Header, Body} = this.props;\n\n    return (\n      <React.Fragment>\n        <Header closeButton onHide={closeModal}>\n          {t('Confirm Password to Continue')}\n        </Header>\n        <Body>{this.renderBodyContent()}</Body>\n      </React.Fragment>\n    );\n  }\n}\n\nexport default withRouter(withApi(SudoModal));\nexport {SudoModal};\n\nconst StyledTextBlock = styled(TextBlock)`\n  margin-bottom: ${space(1)};\n`;\n\nconst StyledInputField = styled(InputField)`\n  padding-left: 0;\n`;\n\nconst StyledAlert = styled(Alert)`\n  margin-bottom: 0;\n`;\n"],"sourceRoot":""}