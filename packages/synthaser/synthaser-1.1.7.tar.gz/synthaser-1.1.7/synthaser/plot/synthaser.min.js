!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).SynthasePlot={})}(this,(function(t){"use strict";function e(t){let e=document.createElement("textarea");document.body.appendChild(e),e.value=t,e.select(),document.execCommand("copy"),document.body.removeChild(e)}t.SynthasePlot=function(){let t=20,n=20,a=.3,l=10,s=600,r=30,o=12,i=16,d=250,c=14,p=10,g=.4,h=12,y={x:d3.scaleLinear(),y:d3.scaleBand(),scheme:d3.scaleSequential(d3.interpolateRainbow),colour:d3.scaleOrdinal(),legend:d3.scaleBand(),order:d3.scaleOrdinal()};const u={};let m,f,x;function b(t,e){t.attr("transform",(t=>`translate(0, ${y.y(t)})`)),t.selectAll("rect.seq-bg").attr("width",(t=>y.x(e.synthases[t].sequence.length))).attr("height",y.y.bandwidth()),t.selectAll("rect.domain").attr("x",(t=>y.x(t.start))).attr("fill",(t=>y.colour(t.type))).attr("width",(t=>y.x(t.end-t.start))).attr("height",y.y.bandwidth()),t.selectAll("polygon").attr("points",(t=>u[t]))}function $(t,e){return Object.fromEntries(Object.keys(t).filter((t=>!e.includes(t))).map((e=>[e,t[e]])))}function v(t,e){let n,a;t.each(((l,s,r)=>{0===s&&(a=0,n=[]);let o=e.types[l.classification];if(0==o.length)return;n&&l.depth===a&&n.pop();let i=d3.max(o.map((t=>y.x(e.synthases[t].sequence.length))))+10+d3.sum(n),d=i+10,c=o.map((t=>y.y(t))),p=d3.min(c),g=d3.max(c)+y.y.bandwidth(),h=g+(p-g)/2;t.selectAll("polyline").filter((t=>t===l)).attr("points",`\n          ${i},${p}\n          ${d},${p}\n          ${d},${g}\n          ${i},${g}\n        `),t.selectAll("text").filter((t=>t===l)).style("font-size","12px").attr("x",d+10).attr("y",h);let u=d3.select(r[s]).node().getBBox().width+6;n.push(u),a=l.depth;let f=d+u;f>m&&(m=f)}))}function w(t){return t.attr("transform",(t=>`translate(0, ${y.legend(t)})`)),t.selectAll("rect").attr("fill",(t=>y.colour(t))).attr("width",r).attr("height",y.legend.bandwidth()),t.selectAll("text").attr("x",r).attr("y",y.legend.bandwidth()/2).style("font-size",`${o}px`),t}function A(t,e){let n=d3.select("input#picker");n.on("change",(()=>{d3.selectAll(`.${e}`).attr("fill",n.node().value)})),n.node().click()}function k(r){r.each((function(r){x=d3.select(this),f=d3.transition().duration(d),m=0;let o=function(t,e="type"){return[...t.order.map((n=>{let a=t.synthases[n].domains.map((t=>t[e]));return new Set(a)})).reduce(((t,e)=>new Set([...t,...e])))]}(r);y.colour.domain(o).range(o.map(((t,e)=>y.scheme(e/o.length)))),y.order.domain(o).range(o.map(((t,e)=>e/o.length)));let P=d3.max(r.order.map((t=>r.synthases[t].sequence.length)));y.x.domain([0,P]).range([0,s]),y.y.padding(g).domain(r.order).range([0,r.order.length*t]),r.order.forEach((t=>{u[t]=function(t){let e=y.x(t.sequence.length),n=e-l,a=y.y.bandwidth();return`\n\t\t\t0,0\n\t\t\t${n},0\n\t\t\t${e},${a/2}\n\t\t\t${n},${a}\n\t\t\t0,${a}\n\t\t`}(r.synthases[t]),r.synthases[t].domains.forEach((e=>{e.parent=t,e.pLength=r.synthases[t].sequence.length}))}));const j=(t,n)=>{let a=d3.select("div.tooltip"),l=function(t){let e="https://www.ncbi.nlm.nih.gov/Structure/cdd/cddsrv.cgi?uid=";return`\n    <p class="tooltip-summary">\n      <span><b>${t.parent}: ${t.type}</b></span>\n    </p>\n    <table class="tooltip-hits">\n    <tbody>\n      <tr>\n        <td><b>Family</b></td>\n        <td><a href="${e}${t.accession}">${t.domain}</a></td>\n      </tr>\n      <tr>\n        <td><b>Superfamily</b></td>\n        <td><a href="${e}${t.superfamily}">${t.superfamily}</a></td>\n      </tr>\n      <tr>\n        <td><b>Class</b></td>\n        <td>${t.type}</td>\n      </tr>\n      <tr>\n        <td><b>Position</b></td>\n        <td>${t.start}-${t.end}</td>\n      </tr>\n      <tr>\n        <td><b>E-value</b></td>\n        <td>${t.evalue}</td>\n      </tr>\n      <tr>\n        <td><b>Bitscore</b></td>\n        <td>${t.bitscore}</td>\n      </tr>\n      <tr>\n      <td colspan=2>\n        <b>Copy sequence:</b>\n        <br>\n        <button id="dl-domain" style="margin-bottom: 2px"></button>\n        <br>\n        <button id="dl-parent"></button>\n      </td>\n      </tr>\n    </tbody>\n    </table>\n    `}(n),s=r.synthases[n.parent].sequence,o=s.slice(n.start,n.end);a.html(l),a.select("#dl-domain").on("click",(()=>e(o))).text(`Domain (${o.length}aa)`),a.select("#dl-parent").on("click",(()=>e(s))).text(`Protein (${s.length}aa)`);let i=t.target.getBoundingClientRect(),d=a.node().getBoundingClientRect(),c=i.width/2-d.width/2,p=1.2*i.height;a.style("left",i.x+c+"px").style("top",i.y+p+"px"),a.transition().duration(100).style("opacity",1).style("pointer-events","all")},S=()=>{d3.select("div.tooltip").transition().duration(0).style("opacity",1).style("pointer-events","all")},q=()=>{d3.select("div.tooltip").transition().delay(400).style("opacity",0).style("pointer-events","none")};let z=x.selectAll("svg.synthaserPlot").data([r]).join((t=>{t.append("input").attr("id","picker").attr("type","color").style("position","absolute").style("opacity",0),t.append("div").attr("class","tooltip").style("opacity",0).style("pointer-events","none").style("position","absolute").style("padding","5px").on("mouseenter",S).on("mouseleave",q);let e=t.append("svg").attr("id","root_svg").classed("wrapper-svg",!0).attr("width","100%").attr("height","100%").attr("class","synthaserPlot").attr("cursor","grab").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xhtml","http://www.w3.org/1999/xhtml");e.append("defs");let n=e.append("g").attr("class","synthaserPlotG");n.append("text").attr("class","title").attr("text-anchor","middle").style("font-weight","bold"),n.append("text").attr("class","xLabel").text("Sequence length (amino acids)"),n.append("g").attr("class","legend"),n.append("g").attr("class","synthases"),n.append("g").attr("class","xAxis"),n.append("g").attr("class","yAxis"),n.append("g").attr("class","annotations");let a=d3.zoom().scaleExtent([0,8]).on("zoom",(t=>n.attr("transform",t.transform))).on("start",(()=>e.attr("cursor","grabbing"))).on("end",(()=>e.attr("cursor","grab")));return e.call(a)}));z.selectAll("defs").selectAll("clipPath").data(r.order,(t=>`${t}-clip-group`)).join((t=>t.append("clipPath").attr("id",(t=>`${t}-clip`)).append("polygon").attr("points",(t=>u[t]))),(t=>t.call((t=>t.selectAll("polygon").transition(f).attr("points",(t=>u[t]))))));let E=z.selectAll("g.synthaserPlotG");E.selectAll("g.synthases").selectAll("g.synthaseG").data(r.order,(t=>t)).join((t=>{let e=(t=t.append("g").attr("class","synthaseG")).append("g").attr("clip-path",(t=>`url(#${t}-clip)`));return e.append("rect").attr("class","seq-bg").attr("fill","white"),e.append("g").attr("class","domains").selectAll("rect.domain").data((t=>r.synthases[t].domains)).join("rect").attr("class",(t=>`${t.type} domain`)).on("mouseenter",j).on("mouseleave",q),t.append("polygon").attr("fill","none").attr("stroke","black").attr("stroke-width","thin"),t.call(b,r)}),(t=>t.call((t=>t.transition(f).call(b,r))))),E.selectAll("g.annotations").selectAll("g.groups").data(r.groups,(t=>t.map((t=>t.classification)).join())).join("g").attr("class","groups").selectAll("g.group").data((t=>t),(t=>t.classification)).join((t=>((t=t.append("g").attr("class","group").attr("id",(t=>t.classification))).append("polyline").attr("fill","none").attr("stroke","black").attr("stroke-width","thin"),t.append("text").text((t=>t.classification)).attr("text-anchor","start").attr("dy","0.3em"),t.call(v,r))),(t=>t.call((t=>t.transition(f).call(v,r))))),y.legend.domain(o.sort(((t,e)=>y.order(t)>y.order(e)))).range([0,n*o.length]).paddingInner(a),E.selectAll("g.legend").selectAll("g.legendElement").data(o,(t=>t)).join((t=>((t=t.append("g").attr("class","legendElement")).append("rect").attr("class",(t=>t)).attr("cursor","pointer").on("click",A),t.append("text").text((t=>t)).attr("dx",".4em").attr("text-anchor","start").style("dominant-baseline","middle"),t.call(w))),(t=>t.call((t=>t.transition(f).call(w))))),E.selectAll("g.xAxis").transition(f).attr("transform",`translate(0, ${t*r.order.length})`).call(d3.axisBottom(y.x).ticks(6));let B=E.selectAll("g.yAxis");B.transition(f).call(d3.axisLeft(y.y).tickSize(0).tickPadding(p)),B.selectAll("text").on("click",((t,e)=>{(t=>{t?x.data([t]).call(k):x.call(k)})(function(t,e){let n=e.synthases[t],a={...e,order:e.order.filter((e=>e!=t)),types:{...$(e.types,n.classification),...Object.fromEntries(n.classification.map((n=>[n,e.types[n].filter((e=>e!=t))])).filter((t=>t[1].length>0)))},synthases:{...$(e.synthases,[t])},groups:e.groups.map((t=>t.map((t=>t))))};for(let[t,e]of a.groups.entries())for(let[l,s]of e.entries())n.classification.includes(s.classification)&&(a.types.hasOwnProperty(s.classification)||a.groups[t].splice(l,1),0==a.groups[t].length&&a.groups.splice(t,1));return a}(e,r))})).style("font-size",(()=>`${h}px`)).style("text-anchor","end"),B.selectAll("path").remove(),z.select("text.title").transition(f).text(`Domain architecture of ${r.order.length} sequences`).attr("x",y.x(P)/2).style("font-size",`${i}px`),z.select("text.xLabel").transition(f).attr("text-anchor","middle").attr("x",y.x(P)/2).attr("y",t*r.order.length+40).style("font-size",`${c}px`);let C=y.y(r.order[r.order.length-1])/2-y.legend.range()[1]/2;z.select("g.legend").transition(f).attr("transform",`translate(${m}, ${C})`)}))}return k.barHeight=e=>void 0!==e?(t=e,k):t,k.cellHeight=t=>void 0!==t?(n=t,k):n,k.cellPadding=t=>void 0!==t?(a=t,k):a,k.cellWidth=t=>void 0!==t?(r=t,k):r,k.headWidth=t=>void 0!==t?(l=t,k):l,k.legendFontSize=t=>void 0!==t?(o=t,k):o,k.plotWidth=t=>void 0!==t?(s=t,k):s,k.titleFontSize=t=>void 0!==t?(i=t,k):i,k.transitionDuration=t=>void 0!==t?(d=t,k):d,k.xLabelFontSize=t=>void 0!==t?(c=t,k):c,k.yLabelFontSize=t=>void 0!==t?(h=t,k):h,k.yAxisGap=t=>void 0!==t?(p=t,k):p,k.yAxisPadding=t=>void 0!==t?(g=t,k):g,k},Object.defineProperty(t,"__esModule",{value:!0})}));
