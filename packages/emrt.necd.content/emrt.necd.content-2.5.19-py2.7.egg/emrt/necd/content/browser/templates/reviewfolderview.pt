<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="emrt.necd.content">
  <tal:block metal:fill-slot="javascript_head_slot">
    <script type="text/javascript" src="++resource++orderedselect_input.js"></script>
    <script type="text/javascript">
      (function($){

        /* enable reloading of the table for a given selector and set of overrides
         * with optional default event prevention */

        $.fn.enableTableReload = function(selector, overrides, prevent) {
            var $target = this;
            if(arguments.count < 3)
                prevent = false;

            $target.delegate(selector, "click", function(event) {

                sort_on = $('#observations-table').attr('data-sort_on');
                sort_order = $('#observations-table').attr('data-sort_order');

                if (sort_on == overrides.sort_on){
                  if (sort_order == 'ascending')
                    overrides.sort_order = 'reverse';
                  if (sort_order == 'reverse')
                    overrides.sort_order = 'ascending';
                }

                if(prevent)
                    event.preventDefault();
                replaceFolderContentsTable(overrides);
            });
            return $target;
        };

        function encodeArrForRequest(param_name, arr){
          function append_param_name(item) {
            return param_name + '[]=' + encodeURIComponent(item);
          }
          return arr ? arr.map(append_param_name).join('&') : "";
        };

        function querystringConvert(){
          var url_params = location.search.slice(1).split('&');
          var pairs = url_params
            .map(function(p) { return p.split('='); })
            .map(function(kv) {
              var k = kv[0]; var v = kv[1];
              var decoded_v = decodeURIComponent(v);
              return [k, decoded_v];
            });

          var params = pairs.reduce(function(acc, kv) {
            var k = kv[0]; var v = kv[1];
            acc[k] ? acc[k].push(v) : acc[k] = [v];
            return acc;
          }, {});

          var normalized = Object.keys(params).reduce(
            function(acc, key){
              var val = params[key];
              val.length > 1 ? acc[key] = val : acc[key] = val[0];
              return acc;
            }, {});

          return normalized;
        }

        function replaceFolderContentsTable(overrides) {
            var defaults = querystringConvert();
            defaults.sort_order = $('#observations-table').attr('data-sort_order');
            defaults.sort_on = $('#observations-table').attr('data-sort_on');
            $.get('get_table', $.extend(defaults, overrides), function(data) {
                $("#observations").replaceWith(data);
                // fix up links generated by batching
                var orig_template = 'view';
                $("div.listingBar a").each(function(){
                    $(this).attr("href", $(this).attr("href").replace(/get_table/, orig_template));
                });
                $(initializeDnDReorder('#observations-table'));
                $('html,body').animate({scrollTop: $("#tabs").offset().top}, 0);
            });
        }

        $(document).ready(function(){
            /* folder contents table loading actions */
            var ccore = $("#content-core");
            ccore.enableTableReload("#reviewfolder-title", { "sort_on": "getId", "sort_order": "ascending" });
            ccore.enableTableReload("#reviewfolder-nfr", { "sort_on": "nfr_code", "sort_order": "ascending" });
            ccore.enableTableReload("#reviewfolder-year", { "sort_on": "review_year", "sort_order": "ascending" });
            ccore.enableTableReload("#reviewfolder-status", { "sort_on": "observation_status", "sort_order": "ascending" });
            ccore.enableTableReload("#reviewfolder-workflow", { "sort_on": "observation_finalisation_reason", "sort_order": "ascending" });
            ccore.enableTableReload("#reviewfolder-date", { "sort_on": "modified", "sort_order": "ascending" });
            ccore.delegate("div.listingBar a", "click", function(event) {
                event.preventDefault();
                var link = $(this).attr("href");
                var page = decodeURI((RegExp("pagenumber\:int" + '=' + '(.+?)(&|$)').exec(link)||[,null])[1]);
                replaceFolderContentsTable({ "pagenumber": page });
            });

            $(".chosen-select").chosen({width: "100%", allow_single_deselect: true});
            $("#btnFilter").click(function(){
              var filter = "";
                if ($('#countryFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "country=" + $('#countryFilter').val();
                }
                if ($('#statusFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "status=" + $('#statusFilter').val();
                }
                if ($('#reviewYearFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "reviewYear=" + $('#reviewYearFilter').val();
                }
                if ($('#inventoryYearFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "inventoryYear=" + escape($('#inventoryYearFilter').val());
                }
                if ($('#freeTextFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "freeText=" + $('#freeTextFilter').val();
                }
                if ($("input:checked").length > 0){
                  var len = $("input:checked").length;
                  var highlights = "";
                  for(var i=0; i < len; i++){
                    highlights += $("input:checked")[i].value + ",";
                  }
                  highlights = highlights.substring(0, highlights.length - 1);
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "highlights=" + highlights;
                }
                if ($('#wfStatusFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += "wfStatus=" + $('#wfStatusFilter').val();
                }
                if ($('#nfrFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += encodeArrForRequest("nfrCode", $('#nfrFilter').val());
                }
                if ($('#sectorFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += encodeArrForRequest("sectorId", $('#sectorFilter').val());
                }
                if ($('#pollutantsFilter').val() != ""){
                  if (filter == ""){
                    filter += "?";
                  }else{
                    filter += "&";
                  }
                  filter += encodeArrForRequest("pollutants", $('#pollutantsFilter').val());
                }
                window.location.href = window.location.pathname + filter;
            });

        });
      })(jQuery);
    </script>
  </tal:block>
<body>
  <metal:main fill-slot="content-core">
    <metal:content-core define-macro="content-core">
      <div class="observationActions reviewfolder">
        <ul class="observationActionsMenu visualNoMarker">
          <li class="configurationButton">
            <a href=""
              tal:attributes="href string:${here/absolute_url}/subscription-configuration"
              class="standardButton">
                <span class="eea-icon"><!-- --></span>
                  Configure notifications
            </a>
          </li>
          <li tal:condition="view/can_export_observations">
            <a class="standardButton export_as_xls" href=""
               tal:define="query request/QUERY_STRING;
                           querystring python:query and '?' + query or ''"
               tal:attributes="href string:${context/absolute_url}/export_as_xls/$querystring">
               <i class="eea-icon eea-icon-download">&nbsp;</i> Exports the results in XLS
            </a>
          </li>
          <li tal:condition="view/can_import_observation">
            <a class="standardButton import_obs" href=""
               tal:attributes="href string:${context/absolute_url}/observation_import_form" >
               Bulk import from XLS
            </a>
          </li>
          <li tal:condition="view/can_import_observation">
            <a class="standardButton import_obs" href=""
               tal:attributes="href string:${context/absolute_url}/carryover-form" >
              Carry-over
            </a>
          </li>
          <li class="deleteButton" tal:condition="view/can_add_observation">
            <a href="./++add++Observation"
               tal:attributes="href string:${here/absolute_url}/++add++Observation"
               class="standardButton defaultWFButton">
                 New observation
            </a>
          </li>
        </ul>
      </div>
      <div class="visualClear"><!-- --></div>
      <div id="tabs">
        <div class="tabs">
          <div class="active">
            <a class="eea-icon overview" tal:attributes="href string:${here/absolute_url}/view">Overview list</a>
          </div>
          <div>
            <a class="eea-icon inbox" tal:attributes="href string:${here/absolute_url}/inboxview">My view</a>
          </div>
          <div tal:condition="python:view.can_view_tableau_dashboard()">
            <a class="eea-icon overview" tal:attributes="href string:${here/absolute_url}/tableau_dashboard">Statistics</a>
          </div>
          <div>
            <a class="eea-icon inbox" tal:attributes="href string:${here/absolute_url}/finalisedfolderview">Finalised observations</a>
          </div>
        </div>
      </div>
      <div id="filters" tal:define="is_lr view/is_lr;
                                    is_projection python:context.type=='projection';
                                    year_range python: '(e.g. 2050, 2020, 2025, 2030)' if is_projection else '(e.g. 2012, 2009-2012)'">
        <div class="row" style="padding-top:25px">
          <div class="cell position-1 width-3 esdLabel">Country</div>
          <div class="cell position-4 width-3 esdLabel tooltipIconBlue" title="Review year is the year in which the emissions inventory was submitted and the review was carried out.">Review year</div>
          <div class="cell position-7 width-3 esdLabel tooltipIconBlue" title="${python: context.type.title()} year is the year or a range of years ${year_range} in which the emissions occured and an issue was observed in the review.">${python: context.type.title()} year</div>
          <div class="cell position-11 width-3 esdLabel tooltipIconBlue" title="Key flags highlight important information that is closely related to the item.">Description flags</div>
        </div>
        <div class="row">
          <div class="cell position-1 width-3">
            <select id="countryFilter" class="chosen-select" data-placeholder="Select country">
              <option></option>
              <tal:block tal:repeat="item view/get_countries">
                <option
                  tal:define="country python:'';
                              country request/country | country"
                  tal:attributes="value python:item[0];
                                  selected python:item[0]==country"
                  tal:content="python:item[1]"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-4 width-3">
            <select id="reviewYearFilter" class="chosen-select" data-placeholder="Select review year">
              <option></option>
              <tal:block tal:repeat="item view/get_review_years">
                <option
                  tal:define="reviewYear python:'';
                              reviewYear request/reviewYear | reviewYear"
                  tal:attributes="value python:item;
                                  selected python:item==reviewYear"
                  tal:content="python:item"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-7 width-3">
            <select id="inventoryYearFilter" class="chosen-select" data-placeholder="Select ${context/type} year">
              <option></option>
              <tal:block tal:repeat="item view/get_inventory_years">
                <option
                  tal:define="inventoryYear python:'';
                              inventoryYear request/inventoryYear | inventoryYear"
                  tal:attributes="value item;
                                  selected python:item==inventoryYear"
                  tal:content="item"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-11 width-5" style="position:absolute;z-index:2">
            <tal:block tal:repeat="item view/get_highlights">
              <tal:block tal:define="highlights python:'';
                                     highlights request/highlights | highlights">
                <input type="checkbox"
                  tal:attributes="value python:item[0];
                                  checked python:highlights.find(item[0]) >= 0;
                                  id python:item[0]"/>
                <label tal:attributes="for python:item[0];"
                  tal:content="python:item[1]"></label><br/>
                  <br tal:condition="python:item[0] in ['unece','acc']"/>
                <div tal:condition="python:item[0] in ['unece','acc']" class="esdLabel">Draft/final conclusion flags</div>

              </tal:block>
            </tal:block>
          </div>
        </div>
        <div class="row" style="padding-top:30px">
            <div class="cell position-1 width-5 esdLabel">NFR category code</div>
            <div class="cell position-6 width-2 esdLabel" tal:condition="is_lr">Sector name</div>
            <div class="cell position-8 width-2 esdLabel" tal:condition="is_lr">Pollutants</div>
        </div>
        <div class="row" tal:define="width python:'width-5' if is_lr else 'width-9'">
          <div tal:attributes="class string:cell position-1 ${width} esdLabel">
            <select id="nfrFilter" multiple="multiple" class="chosen-select" data-placeholder="Select NFR category code">
              <option></option>
              <tal:block tal:repeat="item view/get_nfr_categories">
                <option
                  tal:define="category python:request.get('nfrCode[]', [])"
                  tal:attributes="value python:item[0];
                                  selected python:item[0] in category"
                  tal:content="python:item[1]"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-6 width-2 esdLabel" tal:condition="is_lr">
            <select id="sectorFilter" multiple="multiple" class="chosen-select" data-placeholder="Select sector name">
              <option></option>
              <tal:block tal:repeat="item view/get_sector_names">
                <option
                  tal:define="sectors python:request.get('sectorId[]', [])"
                  tal:attributes="value python:item[0];
                                  selected python:item[0] in sectors"
                  tal:content="python:item[1]"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-8 width-2 esdLabel" tal:condition="is_lr">
            <select id="pollutantsFilter" multiple="multiple" class="chosen-select" data-placeholder="Select pollutants">
              <option></option>
              <tal:block tal:repeat="item view/get_pollutants">
                <option
                  tal:define="pollutants python:request.get('pollutants[]', [])"
                  tal:attributes="value python:item[0];
                                  selected python:item[0] in pollutants"
                  tal:content="python:item[1]"></option>
              </tal:block>
            </select>
          </div>
        </div>
        <div class="row" style="padding-top:30px">
          <div class="cell position-1 width-3 esdLabel">Status of observation</div>
          <div class="cell position-4 width-6 esdLabel">Free text</div>
        </div>
        <div class="row">
          <div class="cell position-1 width-3">
            <select id="statusFilter" class="chosen-select" data-placeholder="Select status">
              <option></option>
              <tal:block tal:repeat="item view/get_finalisation_reasons">
                <option
                  tal:define="status python:'';
                              status request/status | status"
                  tal:attributes="value python:item[0];
                                  selected python:item[0]==status"
                  tal:content="python:item[1]"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-4 width-6 esdLabel">
            <input type="text" id="freeTextFilter" style="width:100%;border-radius:5px;height:21px"
                tal:define="freeText python:'';
                            freeText request/freeText | freeText"
                tal:attributes="value python:freeText"/>
          </div>
        </div>
        <div class="row" style="padding-top:20px">
          <div class="cell position-1 width-6 esdLabel">Workflow</div>
        </div>
        <div class="row">
          <div class="cell position-1 width-6">
            <select id="wfStatusFilter"  class="chosen-select" data-placeholder="Select status"
                tal:define="wfStatus python:'';
                            wfStatus request/wfStatus | wfStatus">
              <option></option>
              <option tal:attributes="selected python:'LR'==wfStatus"
                value="LR">Lead Reviewer</option>
              <option tal:attributes="selected python:'SE'==wfStatus"
                value="SE">Sector Expert</option>
              <option tal:attributes="selected python:'MSC'==wfStatus"
                value="MSC">MS Coordinator</option>
              <option tal:attributes="selected python:'answered'==wfStatus"
                value="answered">Answered</option>
              <option tal:attributes="selected python:'conclusions'==wfStatus"
                value="conclusions">Conclusions</option>
              <option tal:attributes="selected python:'conclusions-lr-denied'==wfStatus"
                value="conclusions-lr-denied">Conclusions - LR denied</option>
              <option tal:attributes="selected python:'close-requested'==wfStatus"
                value="close-requested">Close requested</option>
              <option tal:attributes="selected python:'finalised'==wfStatus"
                value="finalised">Finalised</option>
            </select>
          </div>
        </div>
        <div class="row" style="padding-top:30px">
          <div class="cell position-1 width-1">
            <a class="standardButton" id="btnFilter">Search</a>
          </div>
        </div>
      </div>

      <tal:questions>

        <div id="observations-list" tal:content="structure view/contents_table"></div>

        <div class="observationActions reviewfolder">
          <ul class="observationActionsMenu visualNoMarker"
              tal:condition="python:view.can_add_observation() or view.can_export_observations">
            <li tal:condition="view/can_export_observations">
              <a class="standardButton export_as_xls" href=""
                 tal:define="query request/QUERY_STRING;
                             querystring python:query and '?' + query or ''"
                 tal:attributes="href string:${context/absolute_url}/export_as_xls/$querystring">
                 <i class="eea-icon eea-icon-download">&nbsp;</i> Exports the results in XLS
              </a>
            </li>
            <li class="deleteButton" tal:condition="view/can_add_observation">
              <a href="./++add++Observation"
                 tal:attributes="href string:${here/absolute_url}/++add++Observation"
                 class="standardButton defaultWFButton">
                   New observation
              </a>
            </li>
          </ul>
        </div>
        <div id="workflowhelp">
          WORKFLOW
        </div>
      </tal:questions>
    </metal:content-core>
  </metal:main>

</body>
</html>
