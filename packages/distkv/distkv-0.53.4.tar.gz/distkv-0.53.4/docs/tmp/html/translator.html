

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Verifying and Translating Entries &mdash; DistKV 0.52.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Fixing DistKV network problems" href="debugging.html" />
    <link rel="prev" title="Data Model" href="model.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> DistKV
          

          
          </a>

          
            
            
              <div class="version">
                0.52.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Principles of operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">The DistKV tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="startup.html">Starting DistKV</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_line.html">The DistKV command</a></li>
<li class="toctree-l1"><a class="reference internal" href="client_protocol.html">DistKV’s client protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="server_protocol.html">DistKV’s server protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth.html">DistKV and authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="acls.html">Access control</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html">Code in DistKV</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html#runner-types">Runner types</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html#runner-configuration">Runner configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html#calladmin">CallAdmin</a></li>
<li class="toctree-l1"><a class="reference internal" href="model.html">Data Model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Verifying and Translating Entries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#verification">Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#types">Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#matches">Matches</a></li>
<li class="toctree-l3"><a class="reference internal" href="#putting-it-all-together">Putting it all together</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#translation">Translation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#codecs">Codecs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#converters">Converters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Putting it all together</a></li>
<li class="toctree-l3"><a class="reference internal" href="#paths">Paths</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Fixing DistKV network problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="extend.html">Extending DistKV</a></li>
<li class="toctree-l1"><a class="reference internal" href="related.html">Plugins and related software</a></li>
<li class="toctree-l1"><a class="reference internal" href="TODO.html">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DistKV</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Verifying and Translating Entries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/translator.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="verifying-and-translating-entries">
<h1>Verifying and Translating Entries<a class="headerlink" href="#verifying-and-translating-entries" title="Permalink to this headline">¶</a></h1>
<div class="section" id="verification">
<h2>Verification<a class="headerlink" href="#verification" title="Permalink to this headline">¶</a></h2>
<p>Your application may require consistency guarantees. Instead of committing
fraud when a transaction in your bookkeeping system doesn’t add up to zero,
you might want to add a verification step to make sure that that doesn’t
happen in the first place. More prosaically, the statement “The door is
locked” is either True or False. (However, you always should be prepared
for an answer of “No idea”, aka <code class="docutils literal notranslate"><span class="pre">None</span></code>. That’s not avoidable.)</p>
<div class="section" id="types">
<h3>Types<a class="headerlink" href="#types" title="Permalink to this headline">¶</a></h3>
<p>Type entries may contain a <code class="docutils literal notranslate"><span class="pre">schema</span></code> attribute with a JSON Schema that
verifies the data. They also may contain a <code class="docutils literal notranslate"><span class="pre">code</span></code> attribute which forms
the body of a validation procedure. The variable <code class="docutils literal notranslate"><span class="pre">value</span></code> contains the
value in question.</p>
<p>Type entries are hierarchic: An (“int”,”percent”) type is first validated
against (None,”type”,”int”), then against (None,”type”,”int”,”percent”).</p>
<p>Type checkers cannot modify data.</p>
<p>Type check entries <em>must</em> be accompanied by “good” and “bad” values, which
must be non-empty arrays of values which pass or fail this type check. For
subordinate types, both kinds must pass the supertype check: if you
add a type “float percentage”, the <code class="docutils literal notranslate"><span class="pre">bad</span></code> list may contain values like <code class="docutils literal notranslate"><span class="pre">-1.2</span></code> or
<code class="docutils literal notranslate"><span class="pre">123.45</span></code>, but not <code class="docutils literal notranslate"><span class="pre">&quot;hello&quot;</span></code>.</p>
<p>Beware that restricting an existing type is dangerous. The DistKV server
does not verify that all existing entries verify correctly.
In pedantic mode, your network may no longer load its data or converge.</p>
</div>
<div class="section" id="matches">
<h3>Matches<a class="headerlink" href="#matches" title="Permalink to this headline">¶</a></h3>
<p>The (None,”match”) hierarchy mirrors the actual object tree, except that
wildcards are allowed:</p>
<ul>
<li><p>“#”</p>
<p>matches any number of levels</p>
</li>
<li><p>“+”</p>
<p>matches exactly one level</p>
</li>
</ul>
<p>This matches MQTT’s behavior.</p>
<p>Unlike MQTT, there may be more than one “#” wildcard.</p>
<p>Be aware that adding or modifying matches to existing entries is dangerous.
The DistKV server does not verify that all existing entries verify correctly.
In pedantic mode, your network may no longer load its data or converge.</p>
</div>
<div class="section" id="putting-it-all-together">
<h3>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h3>
<p>Given the following structure, values stored at (“foo”, anything, “bar”)
must be integers:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">match</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span>
    <span class="o">+</span><span class="p">:</span>
      <span class="n">bar</span><span class="p">:</span>
        <span class="n">_</span><span class="p">:</span>
          <span class="nb">type</span><span class="p">:</span>
          <span class="o">-</span> <span class="nb">int</span>
          <span class="o">-</span> <span class="n">percent</span>
<span class="nb">type</span><span class="p">:</span>
  <span class="nb">int</span><span class="p">:</span>
    <span class="n">_</span><span class="p">:</span>
      <span class="n">bad</span><span class="p">:</span> <span class="p">[</span><span class="n">none</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">]</span>
      <span class="n">code</span><span class="p">:</span> <span class="s1">&#39;if not isinstance(value,int): raise ValueError(&#39;&#39;not an int&#39;&#39;)&#39;</span>
      <span class="n">good</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">percent</span><span class="p">:</span>
      <span class="n">_</span><span class="p">:</span>
        <span class="n">bad</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">555</span><span class="p">]</span>
        <span class="n">code</span><span class="p">:</span> <span class="s1">&#39;if not 0&lt;=value&lt;=100: raise ValueError(&#39;&#39;not a percentage&#39;&#39;)&#39;</span>
        <span class="n">good</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>
<span class="o">---</span>
<span class="n">_</span><span class="p">:</span> <span class="mi">123</span>
<span class="n">foo</span><span class="p">:</span>
  <span class="n">dud</span><span class="p">:</span>
    <span class="n">bar</span><span class="p">:</span>
      <span class="n">_</span><span class="p">:</span> <span class="mi">55</span>
</pre></div>
</div>
<p>The above is the server content at the end of the testcase
<code class="docutils literal notranslate"><span class="pre">tests/test_feature_typecheck.py::test_72_cmd</span></code>, when
dumped with the commands <code class="docutils literal notranslate"><span class="pre">distkv</span> <span class="pre">client</span> <span class="pre">internal</span> <span class="pre">dump</span></code> and
<code class="docutils literal notranslate"><span class="pre">distkv</span> <span class="pre">client</span> <span class="pre">get</span> <span class="pre">-rd_</span></code>.</p>
<p>On the command line, you can do the same thing thus:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span>$ echo &quot;if not isinstance(value,int): raise ValueError(&#39;not an int&#39;)&quot; | \
  distkv client type set -b None -b  &#39;&quot;foo&quot;&#39; -g 0 -g 2 -s - int
$ echo &quot;if not 0&lt;=value&lt;=100: raise ValueError(&#39;not a percentage&#39;)&quot; | \
  distkv client type set -b -1 -b  555 -g 0 -g 100 -g 50 -s - int percent
$ distkv client type match -t int -t percent foo + bar
</pre></div>
</div>
</div>
</div>
<div class="section" id="translation">
<h2>Translation<a class="headerlink" href="#translation" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, clients need special treatment. For instance, an IoT-MQTT message
that reports turning on a light might send “ON” to topic
<code class="docutils literal notranslate"><span class="pre">/home/state/bath/light</span></code>, while what you’d really like to do is to change
the Boolean <code class="docutils literal notranslate"><span class="pre">state</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">home.bath.light</span></code>. Or maybe the value
is a percentage and you’d like to ensure that the stored value is 0.5
instead of “50%”, and that no rogue client can set it to -20 or “gotcha”.</p>
<p>To ensure this, DistKV uses two typing mechanisms. One has been described,
above, and ensures that the values are correct:</p>
<ul class="simple">
<li><p>“type” entries describe the type of entry (“this is an integer between 0
and 42”).</p></li>
<li><p>“match” entries describe the path position to which that type applies</p></li>
</ul>
<p>Another, similar mechanism may then be used to convert clients’ values to
DistKV entries and back:</p>
<ul class="simple">
<li><p>“codec” entries describe distinct converters (“50%” =&gt; 0.5; “ON” =&gt; ‘set
the entry’s “state” property to <code class="docutils literal notranslate"><span class="pre">True</span></code>’)</p></li>
<li><p>“map” entries are activated per client (via command, or controlled by its
login) and describe the path position to which a codec applies</p></li>
</ul>
<div class="section" id="codecs">
<h3>Codecs<a class="headerlink" href="#codecs" title="Permalink to this headline">¶</a></h3>
<p>Codec entries contain <code class="docutils literal notranslate"><span class="pre">decode</span></code> and <code class="docutils literal notranslate"><span class="pre">encode</span></code> attributes which form the
bodies of procedures that rewrite external data to DistKV values and vice
versa, respectively, using the <code class="docutils literal notranslate"><span class="pre">value</span></code> parameter as input. The <code class="docutils literal notranslate"><span class="pre">decode</span></code>
procedure gets an additional <code class="docutils literal notranslate"><span class="pre">prev</span></code> variable which contains the old
value. That value <strong>must not</strong> be modified; create a copy or (preferably)
use <code class="xref py py-func docutils literal notranslate"><span class="pre">distkv.util.combine_dict()</span></code> to assemble the result.</p>
<p>Codecs may be named hierarchically for convenience; if you want to
call the “parent” codec, put the common code in a module and import that.</p>
<p>Codecs also require “in” and “out” attributes, each of which must contain a list
of 2-tuples with that conversion’s source value and its result. “in”
corresponds to decoding, “out” to encoding – much like Python’s binary
codecs.</p>
</div>
<div class="section" id="converters">
<h3>Converters<a class="headerlink" href="#converters" title="Permalink to this headline">¶</a></h3>
<p>While the <code class="docutils literal notranslate"><span class="pre">(None,&quot;map&quot;)</span></code> subtree contains a single mapping, <code class="docutils literal notranslate"><span class="pre">(None,&quot;conv&quot;)</span></code>
uses an additional single level of codec group names. A mapping must be
applied to a user (by adding a “conv=GROUPNAME” to the user’s aux data
field) before it is used. This change is instantaneous, i.e. an existing
user does not need to reconnect.</p>
<p>Below that, converter naming works like that for mappings. Of course, the
pointing attribute is named <code class="docutils literal notranslate"><span class="pre">codec</span></code> instead of <code class="docutils literal notranslate"><span class="pre">type</span></code>.</p>
</div>
<div class="section" id="id1">
<h3>Putting it all together<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Given the following data structure, the user “conv” will only be able to
write stringified integers under keys below the “inty” key, which will be
stored as integers:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="p">:</span>
  <span class="n">_</span><span class="p">:</span>
    <span class="n">current</span><span class="p">:</span> <span class="n">_test</span>
  <span class="n">_test</span><span class="p">:</span>
    <span class="n">user</span><span class="p">:</span>
      <span class="n">con</span><span class="p">:</span>
        <span class="n">_</span><span class="p">:</span>
          <span class="n">_aux</span><span class="p">:</span>
            <span class="n">conv</span><span class="p">:</span> <span class="n">foo</span>
      <span class="n">std</span><span class="p">:</span>
        <span class="n">_</span><span class="p">:</span>
          <span class="n">_aux</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">codec</span><span class="p">:</span>
  <span class="nb">int</span><span class="p">:</span>
    <span class="n">_</span><span class="p">:</span>
      <span class="n">decode</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">str</span><span class="p">);</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">encode</span><span class="p">:</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="ow">in</span><span class="p">:</span>
      <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span>
      <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">]</span>
      <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
      <span class="n">out</span><span class="p">:</span>
      <span class="o">-</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="p">]</span>
      <span class="o">-</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span> <span class="p">]</span>
      <span class="o">-</span> <span class="p">[</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;-3&#39;</span> <span class="p">]</span>
<span class="n">conv</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span>
    <span class="n">inty</span><span class="p">:</span>
      <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="n">_</span><span class="p">:</span>
          <span class="n">codec</span><span class="p">:</span>
          <span class="o">-</span> <span class="nb">int</span>
<span class="o">---</span>
<span class="n">inty</span><span class="p">:</span>
  <span class="n">_</span><span class="p">:</span> <span class="n">hello</span>
  <span class="n">ten</span><span class="p">:</span>
    <span class="n">_</span><span class="p">:</span> <span class="mi">10</span>
  <span class="n">yep</span><span class="p">:</span>
    <span class="n">yepyepyep</span><span class="p">:</span>
      <span class="n">_</span><span class="p">:</span> <span class="mi">13</span>
      <span class="n">yep</span><span class="p">:</span>
        <span class="n">_</span><span class="p">:</span> <span class="mi">99</span>
</pre></div>
</div>
<p>The above is the server content at the end of the testcase
<code class="docutils literal notranslate"><span class="pre">tests/test_feature_convert.py::test_71_basic</span></code>, when
dumped with the commands <code class="docutils literal notranslate"><span class="pre">distkv</span> <span class="pre">client</span> <span class="pre">internal</span> <span class="pre">dump</span></code> and
<code class="docutils literal notranslate"><span class="pre">distkv</span> <span class="pre">client</span> <span class="pre">get</span> <span class="pre">-rd_</span></code>.</p>
</div>
<div class="section" id="paths">
<h3>Paths<a class="headerlink" href="#paths" title="Permalink to this headline">¶</a></h3>
<p>Currently, DistKV does not offer automatic path translation. If you need
that, the best way is to code two active object hierarchies, and
let their <code class="docutils literal notranslate"><span class="pre">set_value</span></code> methods shuffle data to the “other” side.</p>
<p>There are some caveats:</p>
<ul class="simple">
<li><p>All such data are stored twice.</p></li>
<li><p>Don’t change a value that didn’t in fact change; if you do, you’ll
generate an endless loop.</p></li>
<li><p>You need to verify that the two trees match when you start up, and decide
which is more correct. (The <code class="docutils literal notranslate"><span class="pre">tock</span></code> stamp will help you here.) Don’t
accidentally overwrite changes that arrive while you do that.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="debugging.html" class="btn btn-neutral float-right" title="Fixing DistKV network problems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="model.html" class="btn btn-neutral float-left" title="Data Model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The DistKV authors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>