- slug: workflow-macs-rose
  name: "MACS2 - ROSE2"
  data_name: "{{ case|sample_name|default('?') }}"
  requirements:
    expression-engine: jinja
  version: 1.3.2
  type: data:workflow:chipseq:macs2rose2
  category: Pipeline
  input:
    - name: case
      label: Case (treatment)
      type: data:alignment:bam
    - name: control
      label: Control (background)
      type: data:alignment:bam
      required: false
    - name: promoter
      label: Promoter regions BED file
      type: data:bed
      required: false
      description: |
        BED file containing promoter regions (TSS+-1000 bp for example). Needed to get the number
        of peaks and reads mapped to promoter regions.
    - name: tagalign
      label: Use tagAlign files
      type: basic:boolean
      default: false
      description: |
         Use filtered tagAlign files as case (treatment) and control
         (background) samples. If extsize parameter is not set, run MACS
         using input's estimated fragment length.
    - name: prepeakqc_settings
      label: Pre-peak QC settings
      group:
        - name: q_threshold
          label: Quality filtering threshold
          type: basic:integer
          default: 30
        - name: n_sub
          label: Number of reads to subsample
          type: basic:integer
          default: 15000000
        - name: tn5
          label: Tn5 shifting
          type: basic:boolean
          default: false
          description: |
            Tn5 transposon shifting. Shift reads on "+" strand by 4 bp
            and reads on "-" strand by 5 bp.
        - name: shift
          label: User-defined cross-correlation peak strandshift
          type: basic:integer
          required: false
          description: |
            If defined, SPP tool will not try to estimate fragment length but will use the given value
            as fragment length.
    - name: settings
      label: MACS2 settings
      group:
        - name: duplicates
          label: Number of duplicates
          type: basic:string
          required: false
          hidden: "tagalign"
          choices:
            - label: "1"
              value: "1"
            - label: "auto"
              value: "auto"
            - label: "all"
              value: "all"
          description: |
            It controls the MACS behavior towards duplicate tags at the exact same location -- the
            same coordination and the same strand. The 'auto' option makes MACS calculate the
            maximum tags at the exact same location based on binomal distribution using 1e-5 as
            pvalue cutoff and the 'all' option keeps all the tags. If an integer is given, at most
            this number of tags will be kept at the same location. The default is to keep one tag
            at the same location.
        - name: duplicates_prepeak
          label: Number of duplicates
          type: basic:string
          hidden: "!tagalign"
          required: false
          default: all
          choices:
            - label: "1"
              value: "1"
            - label: "auto"
              value: "auto"
            - label: "all"
              value: "all"
          description: |
            It controls the MACS behavior towards duplicate tags at the exact same location -- the
            same coordination and the same strand. The 'auto' option makes MACS calculate the
            maximum tags at the exact same location based on binomal distribution using 1e-5 as
            pvalue cutoff and the 'all' option keeps all the tags. If an integer is given, at most
            this number of tags will be kept at the same location. The default is to keep one tag
            at the same location.
        - name: qvalue
          label: Q-value cutoff
          type: basic:decimal
          required: false
          disabled: "settings.pvalue && settings.pvalue_prepeak"
          description: |
            The q-value (minimum FDR) cutoff to call significant regions. Q-values
            are calculated from p-values using Benjamini-Hochberg procedure.
        - name: pvalue
          label: P-value cutoff
          type: basic:decimal
          required: false
          disabled: "settings.qvalue"
          hidden: "tagalign"
          description: |
            The p-value cutoff. If specified, MACS2 will use p-value instead of q-value cutoff.
        - name: pvalue_prepeak
          label: P-value cutoff
          type: basic:decimal
          disabled: "settings.qvalue"
          hidden: "!tagalign || settings.qvalue"
          default: 0.00001
          description: |
            The p-value cutoff. If specified, MACS2 will use p-value instead of q-value cutoff.
        - name: cap_num
          label: Cap number of peaks by taking top N peaks
          type: basic:integer
          default: 500000
          disabled: "settings.broad"
          description: |
            To keep all peaks set value to 0.
        - name: mfold_lower
          label: MFOLD range (lower limit)
          type: basic:integer
          required: false
          description: |
            This parameter is used to select the regions within MFOLD range of high-confidence
            enrichment ratio against background to build model. The regions must be lower than
            upper limit, and higher than the lower limit of fold enrichment. DEFAULT:10,30 means
            using all regions not too low (>10) and not too high (<30) to build paired-peaks
            model. If MACS can not find more than 100 regions to build model, it will use the
            --extsize parameter to continue the peak detection ONLY if --fix-bimodal is set.
        - name: mfold_upper
          label: MFOLD range (upper limit)
          type: basic:integer
          required: false
          description: |
            This parameter is used to select the regions within MFOLD range of high-confidence
            enrichment ratio against background to build model. The regions must be lower than
            upper limit, and higher than the lower limit of fold enrichment. DEFAULT:10,30 means
            using all regions not too low (>10) and not too high (<30) to build paired-peaks
            model. If MACS can not find more than 100 regions to build model, it will use the
            --extsize parameter to continue the peak detection ONLY if --fix-bimodal is set.
        - name: slocal
          label: Small local region
          type: basic:integer
          required: false
          description: |
            Slocal and llocal parameters control which two levels of regions will be checked
            around the peak regions to calculate the maximum lambda as local lambda. By default,
            MACS considers 1000 bp for small local region (--slocal), and 10000 bp for large local
            region (--llocal) which captures the bias from a long range effect like an open
            chromatin domain. You can tweak these according to your project. Remember that if the
            region is set too small, a sharp spike in the input data may kill the significant
            peak.
        - name: llocal
          label: Large local region
          type: basic:integer
          required: false
          description: |
            Slocal and llocal parameters control which two levels of regions will be checked
            around the peak regions to calculate the maximum lambda as local lambda. By default,
            MACS considers 1000 bp for small local region (--slocal), and 10000 bp for large local
            region (--llocal) which captures the bias from a long range effect like an open
            chromatin domain. You can tweak these according to your project. Remember that if the
            region is set too small, a sharp spike in the input data may kill the significant
            peak.
        - name: extsize
          label: extsize
          type: basic:integer
          required: false
          description: |
            While '--nomodel' is set, MACS uses this parameter to extend reads in 5'->3' direction
            to fix-sized fragments. For example, if the size of binding region for your
            transcription factor is 200 bp, and you want to bypass the model building by MACS,
            this parameter can be set as 200. This option is only valid when --nomodel is set or
            when MACS fails to build model and --fix-bimodal is on.
        - name: shift
          label: Shift
          type: basic:integer
          required: false
          description: |
            Note, this is NOT the legacy --shiftsize option which is replaced by --extsize! You
            can set an arbitrary shift in bp here. Please Use discretion while setting it other
            than default value (0). When --nomodel is set, MACS will use this value to move
            cutting ends (5') then apply --extsize from 5' to 3' direction to extend them to
            fragments. When this value is negative, ends will be moved toward 3'->5' direction,
            otherwise 5'->3' direction. Recommended to keep it as default 0 for ChIP-Seq datasets,
            or -1 * half of EXTSIZE together with --extsize option for detecting enriched cutting
            loci such as certain DNAseI-Seq datasets. Note, you can't set values other than 0 if
            format is BAMPE for paired-end data. Default is 0.
        - name: band_width
          label: Band width
          type: basic:integer
          required: false
          description: |
            The band width which is used to scan the genome ONLY for model building. You can set
            this parameter as the sonication fragment size expected from wet experiment. The
            previous side effect on the peak detection process has been removed. So this parameter
            only affects the model building.
        - name: nolambda
          label: Use backgroud lambda as local lambda
          type: basic:boolean
          default: false
          description: |
            With this flag on, MACS will use the background lambda as local lambda. This means
            MACS will not consider the local bias at peak candidate regions.
        - name: fix_bimodal
          label: Turn on the auto paired-peak model process
          type: basic:boolean
          default: false
          description: |
            Turn on the auto paired-peak model process. If it's set, when MACS failed
            to build paired model, it will use the nomodel settings, the '--extsize' parameter
            to extend each tag. If set, MACS will be terminated if paired-peak model has failed.
        - name: nomodel
          label: Bypass building the shifting model
          type: basic:boolean
          hidden: "tagalign"
          default: false
          description: |
            While on, MACS will bypass building the shifting model.
        - name: nomodel_prepeak
          label: Bypass building the shifting model
          type: basic:boolean
          default: true
          hidden: "!tagalign"
          description: |
            While on, MACS will bypass building the shifting model.
        - name: down_sample
          label: Down-sample
          type: basic:boolean
          default: false
          description: |
            When set to true, random sampling method will scale down the bigger sample. By default, MACS
            uses linear scaling. This option will make the results unstable and irreproducible
            since each time, random reads would be selected, especially the numbers (pileup,
            pvalue, qvalue) would change.
        - name: bedgraph
          label: Save fragment pileup and control lambda
          type: basic:boolean
          default: true
          description: |
            If this flag is on, MACS will store the fragment pileup, control lambda, -log10pvalue
            and -log10qvalue scores in bedGraph files. The bedGraph files will be stored in
            current directory named NAME+'_treat_pileup.bdg' for treatment data,
            NAME+'_control_lambda.bdg' for local lambda values from control,
            NAME+'_treat_pvalue.bdg' for Poisson pvalue scores (in -log10(pvalue) form), and
            NAME+'_treat_qvalue.bdg' for q-value scores from Benjamini-Hochberg-Yekutieli
            procedure.
        - name: spmr
          label: Save signal per million reads for fragment pileup profiles
          type: basic:boolean
          default: true
          disabled: "settings.bedgraph === false"
        - name: call_summits
          label: Call summits
          type: basic:boolean
          default: false
          description: |
            MACS will now reanalyze the shape of signal profile (p or q-score depending on cutoff
            setting) to deconvolve subpeaks within each peak called from general procedure. It's
            highly recommended to detect adjacent binding events. While used, the output subpeaks
            of a big peak region will have the same peak boundaries, and different scores and peak
            summit positions.
        - name: broad
          label: Composite broad regions
          type: basic:boolean
          default: false
          disabled: "settings.call_summits === true"
          description: |
            When this flag is on, MACS will try to composite broad regions in BED12 (a
            gene-model-like format) by putting nearby highly enriched regions into a broad region
            with loose cutoff. The broad region is controlled by another cutoff through
            --broad-cutoff. The maximum length of broad region length is 4 times of d from MACS.
        - name: broad_cutoff
          label: Broad cutoff
          type: basic:decimal
          required: false
          disabled: "settings.call_summits === true || settings.broad !== true"
          description: |
            Cutoff for broad region. This option is not available unless --broad is set. If -p is
            set, this is a p-value cutoff, otherwise, it's a q-value cutoff. DEFAULT = 0.1
    - name: rose_settings
      label: ROSE2 settings
      group:
        - name: use_filtered_bam
          label: Use Filtered BAM File
          type: basic:boolean
          default: false
          description: |
            Use filtered BAM file from a MACS2 object to rank enhancers by.
        - name: tss
          label: TSS exclusion
          type: basic:integer
          default: 0
          description: |
            Enter a distance from TSS to exclude. 0 = no TSS exclusion
        - name: stitch
          label: Stitch
          type: basic:integer
          required: false
          description: |
            Enter a max linking distance for stitching. If not given, optimal stitching parameter will be determined automatically.
        - name: mask
          label: Masking BED file
          type: data:bed
          required: false
          description: |
            Mask a set of regions from analysis. Provide a BED of masking regions.
    - name: chipqc_settings
      label: ChipQC settings
      group:
        - name: blacklist
          label: Blacklist regions
          type: data:bed
          required: false
          description: |
            BED file containing genomic regions that should be excluded from the analysis.
        - name: calculate_enrichment
          label: Calculate enrichment
          type: basic:boolean
          default: false
          description: |
            Calculate enrichment of signal in known genomic
            annotation. By default annotation is provided from
            the TranscriptDB package specified by genome build
            which should match one of the supported annotations
            (hg19, hg38, hg18, mm10, mm9, rn4, ce6, dm3). If
            annotation is not supported the analysis is skipped.
        - name: profile_window
          label: Window size
          type: basic:integer
          default: 400
          description: |
            An integer indicating the width of the window
            used for peak profiles. Peaks will be centered
            on their summits and include half of the window
            size upstream and half downstream of this point.
        - name: shift_size
          label: Shift size
          type: basic:string
          default: "1:300"
          description: |
            Vector of values to try when computing optimal
            shift sizes. It should be specified as
            consecutive numbers vector with start:end
  run:
    language: workflow
    program:
      - id: macs2
        run: macs2-callpeak
        input:
          case: '{{ input.case }}'
          control: '{{ input.control }}'
          promoter: '{{ input.promoter }}'
          tagalign: '{{ input.tagalign }}'
          prepeakqc_settings:
            q_threshold: '{{ input.prepeakqc_settings.q_threshold }}'
            n_sub: '{{ input.prepeakqc_settings.n_sub }}'
            tn5: '{{ input.prepeakqc_settings.tn5 }}'
            shift: '{{ input.prepeakqc_settings.shift }}'
          settings:
            duplicates: '{{ input.settings.duplicates }}'
            duplicates_prepeak: '{{ input.settings.duplicates_prepeak }}'
            qvalue: '{{ input.settings.qvalue }}'
            pvalue: '{{ input.settings.pvalue }}'
            pvalue_prepeak: '{{ input.settings.pvalue_prepeak }}'
            cap_num: '{{ input.settings.cap_num }}'
            mfold_lower: '{{ input.settings.mfold_lower }}'
            mfold_upper: '{{ input.settings.mfold_upper }}'
            slocal: '{{ input.settings.slocal }}'
            llocal: '{{ input.settings.llocal }}'
            extsize: '{{ input.settings.extsize }}'
            shift: '{{ input.settings.shift }}'
            nolambda: '{{ input.settings.nolambda }}'
            fix_bimodal: '{{ input.settings.fix_bimodal }}'
            nomodel: '{{ input.settings.nomodel }}'
            nomodel_prepeak: '{{ input.settings.nomodel_prepeak }}'
            down_sample: '{{ input.settings.down_sample }}'
            bedgraph: '{{ input.settings.bedgraph }}'
            spmr: '{{ input.settings.spmr }}'
            call_summits: '{{ input.settings.call_summits }}'
            broad: '{{ input.settings.broad }}'
            broad_cutoff: '{{ input.settings.broad_cutoff }}'
      - id: rose2
        run: rose2
        input:
          input_macs: '{{ steps.macs2 }}'
          use_filtered_bam: '{{ input.rose_settings.use_filtered_bam }}'
          rankby: '{{ input.case }}'
          control: '{{ input.control }}'
          tss: '{{ input.rose_settings.tss }}'
          stitch: '{{ input.rose_settings.stitch }}'
          mask: '{{ input.rose_settings.mask }}'
      - id: chipqc
        run: chipqc
        input:
          alignment: '{{ input.case }}'
          peaks: '{{ steps.macs2 }}'
          blacklist: '{{ input.chipqc_settings.blacklist }}'
          calculate_enrichment: '{{ input.chipqc_settings.calculate_enrichment }}'
          advanced:
            quality_threshold: '{{ input.prepeakqc_settings.q_threshold }}'
            profile_window: '{{ input.chipqc_settings.profile_window }}'
            shift_size: '{{ input.chipqc_settings.shift_size }}'
      - id: multiqc
        run: multiqc
        input:
          data: '{{ [input.case, steps.macs2, steps.chipqc] }}'

- slug: workflow-macs2
  name: "MACS2"
  data_name: "{{ case|sample_name|default('?') }}"
  requirements:
    expression-engine: jinja
  version: 1.1.2
  type: data:workflow:chipseq:macs2rose2
  category: Pipeline
  input:
    - name: case
      label: Case (treatment)
      type: data:alignment:bam
    - name: control
      label: Control (background)
      type: data:alignment:bam
      required: false
    - name: promoter
      label: Promoter regions BED file
      type: data:bed
      required: false
      description: |
        BED file containing promoter regions (TSS+-1000 bp for example). Needed to get the number
        of peaks and reads mapped to promoter regions.
    - name: tagalign
      label: Use tagAlign files
      type: basic:boolean
      default: false
      description: |
          Use filtered tagAlign files as case (treatment) and control
          (background) samples. If extsize parameter is not set, run MACS
          using input's estimated fragment length.
    - name: prepeakqc_settings
      label: Pre-peak QC settings
      group:
        - name: q_threshold
          label: Quality filtering threshold
          type: basic:integer
          default: 30
        - name: n_sub
          label: Number of reads to subsample
          type: basic:integer
          default: 15000000
        - name: tn5
          label: Tn5 shifting
          type: basic:boolean
          default: false
          description: |
            Tn5 transposon shifting. Shift reads on "+" strand by 4 bp
            and reads on "-" strand by 5 bp.
        - name: shift
          label: User-defined cross-correlation peak strandshift
          type: basic:integer
          required: false
          description: |
            If defined, SPP tool will not try to estimate fragment length but will use the given value
            as fragment length.
    - name: settings
      label: MACS2 settings
      group:
        - name: duplicates
          label: Number of duplicates
          type: basic:string
          required: false
          hidden: "tagalign"
          choices:
            - label: "1"
              value: "1"
            - label: "auto"
              value: "auto"
            - label: "all"
              value: "all"
          description: |
            It controls the MACS behavior towards duplicate tags at the exact same location -- the
            same coordination and the same strand. The 'auto' option makes MACS calculate the
            maximum tags at the exact same location based on binomal distribution using 1e-5 as
            pvalue cutoff and the 'all' option keeps all the tags. If an integer is given, at most
            this number of tags will be kept at the same location. The default is to keep one tag
            at the same location.
        - name: duplicates_prepeak
          label: Number of duplicates
          type: basic:string
          hidden: "!tagalign"
          required: false
          default: all
          choices:
            - label: "1"
              value: "1"
            - label: "auto"
              value: "auto"
            - label: "all"
              value: "all"
          description: |
            It controls the MACS behavior towards duplicate tags at the exact same location -- the
            same coordination and the same strand. The 'auto' option makes MACS calculate the
            maximum tags at the exact same location based on binomal distribution using 1e-5 as
            pvalue cutoff and the 'all' option keeps all the tags. If an integer is given, at most
            this number of tags will be kept at the same location. The default is to keep one tag
            at the same location.
        - name: qvalue
          label: Q-value cutoff
          type: basic:decimal
          required: false
          disabled: "settings.pvalue && settings.pvalue_prepeak"
          description: |
            The q-value (minimum FDR) cutoff to call significant regions. Q-values
            are calculated from p-values using Benjamini-Hochberg procedure.
        - name: pvalue
          label: P-value cutoff
          type: basic:decimal
          required: false
          disabled: "settings.qvalue"
          hidden: "tagalign"
          description: |
            The p-value cutoff. If specified, MACS2 will use p-value instead of q-value cutoff.
        - name: pvalue_prepeak
          label: P-value cutoff
          type: basic:decimal
          disabled: "settings.qvalue"
          hidden: "!tagalign || settings.qvalue"
          default: 0.00001
          description: |
            The p-value cutoff. If specified, MACS2 will use p-value instead of q-value cutoff.
        - name: cap_num
          label: Cap number of peaks by taking top N peaks
          type: basic:integer
          default: 500000
          disabled: "settings.broad"
          description: |
            To keep all peaks set value to 0.
        - name: mfold_lower
          label: MFOLD range (lower limit)
          type: basic:integer
          required: false
          description: |
            This parameter is used to select the regions within MFOLD range of high-confidence
            enrichment ratio against background to build model. The regions must be lower than
            upper limit, and higher than the lower limit of fold enrichment. DEFAULT:10,30 means
            using all regions not too low (>10) and not too high (<30) to build paired-peaks
            model. If MACS can not find more than 100 regions to build model, it will use the
            --extsize parameter to continue the peak detection ONLY if --fix-bimodal is set.
        - name: mfold_upper
          label: MFOLD range (upper limit)
          type: basic:integer
          required: false
          description: |
            This parameter is used to select the regions within MFOLD range of high-confidence
            enrichment ratio against background to build model. The regions must be lower than
            upper limit, and higher than the lower limit of fold enrichment. DEFAULT:10,30 means
            using all regions not too low (>10) and not too high (<30) to build paired-peaks
            model. If MACS can not find more than 100 regions to build model, it will use the
            --extsize parameter to continue the peak detection ONLY if --fix-bimodal is set.
        - name: slocal
          label: Small local region
          type: basic:integer
          required: false
          description: |
            Slocal and llocal parameters control which two levels of regions will be checked
            around the peak regions to calculate the maximum lambda as local lambda. By default,
            MACS considers 1000 bp for small local region (--slocal), and 10000 bp for large local
            region (--llocal) which captures the bias from a long range effect like an open
            chromatin domain. You can tweak these according to your project. Remember that if the
            region is set too small, a sharp spike in the input data may kill the significant
            peak.
        - name: llocal
          label: Large local region
          type: basic:integer
          required: false
          description: |
            Slocal and llocal parameters control which two levels of regions will be checked
            around the peak regions to calculate the maximum lambda as local lambda. By default,
            MACS considers 1000 bp for small local region (--slocal), and 10000 bp for large local
            region (--llocal) which captures the bias from a long range effect like an open
            chromatin domain. You can tweak these according to your project. Remember that if the
            region is set too small, a sharp spike in the input data may kill the significant
            peak.
        - name: extsize
          label: extsize
          type: basic:integer
          required: false
          description: |
            While '--nomodel' is set, MACS uses this parameter to extend reads in 5'->3' direction
            to fix-sized fragments. For example, if the size of binding region for your
            transcription factor is 200 bp, and you want to bypass the model building by MACS,
            this parameter can be set as 200. This option is only valid when --nomodel is set or
            when MACS fails to build model and --fix-bimodal is on.
        - name: shift
          label: Shift
          type: basic:integer
          required: false
          description: |
            Note, this is NOT the legacy --shiftsize option which is replaced by --extsize! You
            can set an arbitrary shift in bp here. Please Use discretion while setting it other
            than default value (0). When --nomodel is set, MACS will use this value to move
            cutting ends (5') then apply --extsize from 5' to 3' direction to extend them to
            fragments. When this value is negative, ends will be moved toward 3'->5' direction,
            otherwise 5'->3' direction. Recommended to keep it as default 0 for ChIP-Seq datasets,
            or -1 * half of EXTSIZE together with --extsize option for detecting enriched cutting
            loci such as certain DNAseI-Seq datasets. Note, you can't set values other than 0 if
            format is BAMPE for paired-end data. Default is 0.
        - name: band_width
          label: Band width
          type: basic:integer
          required: false
          description: |
            The band width which is used to scan the genome ONLY for model building. You can set
            this parameter as the sonication fragment size expected from wet experiment. The
            previous side effect on the peak detection process has been removed. So this parameter
            only affects the model building.
        - name: nolambda
          label: Use backgroud lambda as local lambda
          type: basic:boolean
          default: false
          description: |
            With this flag on, MACS will use the background lambda as local lambda. This means
            MACS will not consider the local bias at peak candidate regions.
        - name: fix_bimodal
          label: Turn on the auto paired-peak model process
          type: basic:boolean
          default: false
          description: |
            Turn on the auto paired-peak model process. If it's set, when MACS failed
            to build paired model, it will use the nomodel settings, the '--extsize' parameter
            to extend each tag. If set, MACS will be terminated if paired-peak model is failed.
        - name: nomodel
          label: Bypass building the shifting model
          type: basic:boolean
          hidden: "tagalign"
          default: false
          description: |
            While on, MACS will bypass building the shifting model.
        - name: nomodel_prepeak
          label: Bypass building the shifting model
          type: basic:boolean
          default: true
          hidden: "!tagalign"
          description: |
            While on, MACS will bypass building the shifting model.
        - name: down_sample
          label: Down-sample
          type: basic:boolean
          default: false
          description: |
            When set to true, random sampling method will scale down the bigger sample. By default, MACS
            uses linear scaling. This option will make the results unstable and irreproducible
            since each time, random reads would be selected, especially the numbers (pileup,
            pvalue, qvalue) would change.
        - name: bedgraph
          label: Save fragment pileup and control lambda
          type: basic:boolean
          default: true
          description: |
            If this flag is on, MACS will store the fragment pileup, control lambda, -log10pvalue
            and -log10qvalue scores in bedGraph files. The bedGraph files will be stored in
            current directory named NAME+'_treat_pileup.bdg' for treatment data,
            NAME+'_control_lambda.bdg' for local lambda values from control,
            NAME+'_treat_pvalue.bdg' for Poisson pvalue scores (in -log10(pvalue) form), and
            NAME+'_treat_qvalue.bdg' for q-value scores from Benjamini-Hochberg-Yekutieli
            procedure.
        - name: spmr
          label: Save signal per million reads for fragment pileup profiles
          type: basic:boolean
          default: true
          disabled: "settings.bedgraph === false"
        - name: call_summits
          label: Call summits
          type: basic:boolean
          default: false
          description: |
            MACS will now reanalyze the shape of signal profile (p or q-score depending on cutoff
            setting) to deconvolve subpeaks within each peak called from general procedure. It's
            highly recommended to detect adjacent binding events. While used, the output subpeaks
            of a big peak region will have the same peak boundaries, and different scores and peak
            summit positions.
        - name: broad
          label: Composite broad regions
          type: basic:boolean
          default: false
          disabled: "settings.call_summits === true"
          description: |
            When this flag is on, MACS will try to composite broad regions in BED12 (a
            gene-model-like format) by putting nearby highly enriched regions into a broad region
            with loose cutoff. The broad region is controlled by another cutoff through
            --broad-cutoff. The maximum length of broad region length is 4 times of d from MACS.
        - name: broad_cutoff
          label: Broad cutoff
          type: basic:decimal
          required: false
          disabled: "settings.call_summits === true || settings.broad !== true"
          description: |
            Cutoff for broad region. This option is not available unless --broad is set. If -p is
            set, this is a p-value cutoff, otherwise, it's a q-value cutoff. DEFAULT = 0.1
    - name: chipqc_settings
      label: ChipQC settings
      group:
        - name: blacklist
          label: Blacklist regions
          type: data:bed
          required: false
          description: |
            BED file containing genomic regions that should be excluded from the analysis.
        - name: calculate_enrichment
          label: Calculate enrichment
          type: basic:boolean
          default: false
          description: |
            Calculate enrichment of signal in known genomic
            annotation. By default annotation is provided from
            the TranscriptDB package specified by genome build
            which should match one of the supported annotations
            (hg19, hg38, hg18, mm10, mm9, rn4, ce6, dm3). If
            annotation is not supported the analysis is skipped.
        - name: profile_window
          label: Window size
          type: basic:integer
          default: 400
          description: |
            An integer indicating the width of the window
            used for peak profiles. Peaks will be centered
            on their summits and include half of the window
            size upstream and half downstream of this point.
        - name: shift_size
          label: Shift size
          type: basic:string
          default: "1:300"
          description: |
            Vector of values to try when computing optimal
            shift sizes. It should be specified as
            consecutive numbers vector with start:end
  run:
    language: workflow
    program:
      - id: macs2
        run: macs2-callpeak
        input:
          case: '{{ input.case }}'
          control: '{{ input.control }}'
          promoter: '{{ input.promoter }}'
          tagalign: '{{ input.tagalign }}'
          prepeakqc_settings:
            q_threshold: '{{ input.prepeakqc_settings.q_threshold }}'
            n_sub: '{{ input.prepeakqc_settings.n_sub }}'
            tn5: '{{ input.prepeakqc_settings.tn5 }}'
            shift: '{{ input.prepeakqc_settings.shift }}'
          settings:
            duplicates: '{{ input.settings.duplicates }}'
            duplicates_prepeak: '{{ input.settings.duplicates_prepeak }}'
            qvalue: '{{ input.settings.qvalue }}'
            pvalue: '{{ input.settings.pvalue }}'
            pvalue_prepeak: '{{ input.settings.pvalue_prepeak }}'
            cap_num: '{{ input.settings.cap_num }}'
            mfold_lower: '{{ input.settings.mfold_lower }}'
            mfold_upper: '{{ input.settings.mfold_upper }}'
            slocal: '{{ input.settings.slocal }}'
            llocal: '{{ input.settings.llocal }}'
            extsize: '{{ input.settings.extsize }}'
            shift: '{{ input.settings.shift }}'
            nolambda: '{{ input.settings.nolambda }}'
            fix_bimodal: '{{ input.settings.fix_bimodal }}'
            nomodel: '{{ input.settings.nomodel }}'
            nomodel_prepeak: '{{ input.settings.nomodel_prepeak }}'
            down_sample: '{{ input.settings.down_sample }}'
            bedgraph: '{{ input.settings.bedgraph }}'
            spmr: '{{ input.settings.spmr }}'
            call_summits: '{{ input.settings.call_summits }}'
            broad: '{{ input.settings.broad }}'
            broad_cutoff: '{{ input.settings.broad_cutoff }}'
      - id: chipqc
        run: chipqc
        input:
          alignment: '{{ input.case }}'
          peaks: '{{ steps.macs2 }}'
          blacklist: '{{ input.chipqc_settings.blacklist }}'
          calculate_enrichment: '{{ input.chipqc_settings.calculate_enrichment }}'
          advanced:
            quality_threshold: '{{ input.prepeakqc_settings.q_threshold }}'
            profile_window: '{{ input.chipqc_settings.profile_window }}'
            shift_size: '{{ input.chipqc_settings.shift_size }}'
      - id: multiqc
        run: multiqc
        input:
          data: '{{ [input.case, steps.macs2, steps.chipqc] }}'

- slug: workflow-subsample-bwa-aln-single
  name: "Subsample FASTQ and BWA Aln (single-end)"
  data_name: "{{ reads|sample_name|default('?') }}"
  requirements:
    expression-engine: jinja
  version: 1.0.1
  type: data:workflow:chipseq:seqtkbwaaln
  category: Pipeline
  input:
    - name: reads
      label: Reads
      type: data:reads:fastq:single
    - name: genome
      label: Reference genome
      type: data:index:bwa
    - name: downsampling
      label: Downsampling
      group:
        - name: n_reads
          label: Number of reads
          type: basic:integer
          default: 10000000
        - name: advanced
          label: Advanced options
          group:
            - name: seed
              label: Seed
              type: basic:integer
              default: 11
            - name: fraction
              label: Fraction
              type: basic:decimal
              required: false
              range: [0, 1.0]
              description: |
                Use the fraction of reads [0 - 1.0] from the original input file instead
                of the absolute number of reads. If set, this will override the
                "Number of reads" input parameter.
            - name: two_pass
              label: 2-pass mode
              type: basic:boolean
              default: true
              description: |
                Enable two-pass mode when down-sampling. Two-pass mode is twice
                as slow but with much reduced memory.
    - name: alignment
      label: alignment
      group:
        - name: q
          label: Quality threshold
          type: basic:integer
          default: 5
          range: [0, 60]
          description: |
            Parameter for dynamic read trimming.
        - name: use_edit
          label: Use maximum edit distance (excludes fraction of missing alignments)
          type: basic:boolean
          default: false
        - name: edit_value
          label: Maximum edit distance
          type: basic:integer
          default: 5
          hidden: "!use_edit"
        - name: fraction
          label: Fraction of missing alignments
          type: basic:decimal
          default: 0.04
          hidden: "use_edit"
          description: |
            The fraction of missing alignments given 2% uniform base error
            rate. The maximum edit distance is automatically chosen for
            different read lengths.
        - name: seeds
          label: Use seeds
          type: basic:boolean
          default: true
        - name: seed_length
          label: Seed length
          type: basic:integer
          default: 32
          hidden: "!seeds"
          description: |
            Take the first X subsequence as seed. If X is larger than the
            query sequence, seeding will be disabled. For long reads,
            this option is typically ranged from 25 to 35 for value 2 in
            seed maximum edit distance.
        - name: seed_dist
          label: Seed maximum edit distance
          type: basic:integer
          default: 2
          hidden: "!seeds"
  run:
    language: workflow
    program:
      - id: downsampling
        run: seqtk-sample-single
        input:
          reads: '{{ input.reads }}'
          n_reads: '{{ input.downsampling.n_reads }}'
          advanced:
            seed: '{{ input.downsampling.advanced.seed }}'
            fraction: '{{ input.downsampling.advanced.fraction }}'
            two_pass: '{{ input.downsampling.advanced.two_pass }}'
      - id: alignment
        run: alignment-bwa-aln
        input:
          reads: '{{ steps.downsampling }}'
          genome: '{{ input.genome }}'
          q: '{{ input.alignment.q }}'
          use_edit: '{{ input.alignment.use_edit }}'
          edit_value: '{{ input.alignment.edit_value }}'
          fraction: '{{ input.alignment.fraction }}'
          seeds: '{{ input.alignment.seeds }}'
          seed_length: '{{ input.alignment.seed_length }}'
          seed_dist: '{{ input.alignment.seed_dist }}'

- slug: workflow-subsample-bwa-aln-paired
  name: "Subsample FASTQ and BWA Aln (paired-end)"
  data_name: "{{ reads|sample_name|default('?') }}"
  requirements:
    expression-engine: jinja
  version: 1.0.1
  type: data:workflow:chipseq:seqtkbwaaln
  category: Pipeline
  input:
    - name: reads
      label: Reads
      type: data:reads:fastq:paired
    - name: genome
      label: Reference genome
      type: data:index:bwa
    - name: downsampling
      label: Downsampling
      group:
        - name: n_reads
          label: Number of reads
          type: basic:integer
          default: 10000000
        - name: advanced
          label: Advanced options
          group:
            - name: seed
              label: Seed
              type: basic:integer
              default: 11
            - name: fraction
              label: Fraction
              type: basic:decimal
              required: false
              range: [0, 1.0]
              description: |
                Use the fraction of reads [0 - 1.0] from the original input file instead
                of the absolute number of reads. If set, this will override the
                "Number of reads" input parameter.
            - name: two_pass
              label: 2-pass mode
              type: basic:boolean
              default: true
              description: |
                Enable two-pass mode when down-sampling. Two-pass mode is twice
                as slow but with much reduced memory.
    - name: alignment
      label: alignment
      group:
        - name: q
          label: Quality threshold
          type: basic:integer
          default: 5
          range: [0, 60]
          description: |
            Parameter for dynamic read trimming.
        - name: use_edit
          label: Use maximum edit distance (excludes fraction of missing alignments)
          type: basic:boolean
          default: false
        - name: edit_value
          label: Maximum edit distance
          type: basic:integer
          default: 5
          hidden: "!use_edit"
        - name: fraction
          label: Fraction of missing alignments
          type: basic:decimal
          default: 0.04
          hidden: "use_edit"
          description: |
            The fraction of missing alignments given 2% uniform base error
            rate. The maximum edit distance is automatically chosen for
            different read lengths.
        - name: seeds
          label: Use seeds
          type: basic:boolean
          default: true
        - name: seed_length
          label: Seed length
          type: basic:integer
          default: 32
          hidden: "!seeds"
          description: |
            Take the first X subsequence as seed. If X is larger than the
            query sequence, seeding will be disabled. For long reads,
            this option is typically ranged from 25 to 35 for value 2 in
            seed maximum edit distance.
        - name: seed_dist
          label: Seed maximum edit distance
          type: basic:integer
          default: 2
          hidden: "!seeds"
  run:
    language: workflow
    program:
      - id: downsampling
        run: seqtk-sample-paired
        input:
          reads: '{{ input.reads }}'
          n_reads: '{{ input.downsampling.n_reads }}'
          advanced:
            seed: '{{ input.downsampling.advanced.seed }}'
            fraction: '{{ input.downsampling.advanced.fraction }}'
            two_pass: '{{ input.downsampling.advanced.two_pass }}'
      - id: alignment
        run: alignment-bwa-aln
        input:
          reads: '{{ steps.downsampling }}'
          genome: '{{ input.genome }}'
          q: '{{ input.alignment.q }}'
          use_edit: '{{ input.alignment.use_edit }}'
          edit_value: '{{ input.alignment.edit_value }}'
          fraction: '{{ input.alignment.fraction }}'
          seeds: '{{ input.alignment.seeds }}'
          seed_length: '{{ input.alignment.seed_length }}'
          seed_dist: '{{ input.alignment.seed_dist }}'
