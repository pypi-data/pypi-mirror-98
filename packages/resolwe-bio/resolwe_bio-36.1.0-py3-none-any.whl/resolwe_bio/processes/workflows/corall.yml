- slug: workflow-corall-single
  name: "Cutadapt - STAR - StringTie (Corall, single-end)"
  data_name: "{{ reads|sample_name|default('?') }}"
  requirements:
    expression-engine: jinja
  version: 3.0.1
  type: data:workflow:rnaseq:corall
  category: Pipeline
  description: |
    RNA-seq pipeline optimized for the Lexogen Corall Total RNA-Seq
    Library Prep Kit.

    UMI-sequences are extracted from the raw reads before the reads are
    trimmed and quality filtered using Cutadapt. Preprocessed reads are
    aligned by the STAR aligner and de-duplicated using UMI-tools.
    Gene abundance estimates are reported by the featureCounts tool.

    QC operates on downsampled reads and includes alignment of input
    reads to the rRNA/globin reference sequences. The reported alignment
    rate is used to asses the rRNA/globin sequence depletion rate.

    The analysis results and QC reports are summarized by the MultiQC.
  input:
    - name: reads
      label: Select sample(s)
      type: data:reads:fastq:single
    - name: star_index
      label: Genome
      type: data:index:star
      description: |
        Genome index prepared by STAR aligner indexing tool.
    - name: annotation
      label: Annotation
      type: data:annotation
      description: |
        Genome annotation file (GTF).
    - name: rrna_reference
      label: Indexed rRNA reference sequence
      type: data:index:star
      description: |
        Reference sequence index prepared by STAR aligner indexing tool.
    - name: globin_reference
      label: Indexed Globin reference sequence
      type: data:index:star
      description: |
        Reference sequence index prepared by STAR aligner indexing tool.
    - name: show_advanced
      label: Show advanced parameters
      type: basic:boolean
      default: false
    - name: cutadapt
      label: Cutadapt filtering
      hidden: '!show_advanced'
      group:
        - name: quality_cutoff
          label: Reads quality cutoff
          type: basic:integer
          required: false
          description: |
            Trim low-quality bases from 3' end of each read before
            adapter removal. Use this option when processing the data
            generated by older Illumina machines. The use of this option
            will override the NextSeq/NovaSeq-specific trimming procedure
            which is enabled by default and is recommended for Illumina
            machines that utilize 2-color chemistry to encode the four
            bases.
    - name: downsampling
      label: Downsampling (Seqtk)
      hidden: '!show_advanced'
      group:
        - name: n_reads
          label: Number of reads
          type: basic:integer
          default: 1000000
        - name: seed
          label: Seed
          type: basic:integer
          default: 11
        - name: fraction
          label: Fraction
          type: basic:decimal
          required: false
          range: [0, 1.0]
          description: |
            Use the fraction of reads in range [0.0, 1.0] from the orignal input file instead
            of the absolute number of reads. If set, this will override the
            "Number of reads" input parameter.
        - name: two_pass
          label: 2-pass mode
          type: basic:boolean
          default: false
          description: |
            Enable two-pass mode when down-sampling. Two-pass mode is twice
            as slow but with much reduced memory.
    - name: quantification
      label: Quantification (featureCounts)
      hidden: '!show_advanced'
      group:
        - name: feature_class
          label: Feature class
          type: basic:string
          default: exon
          description: |
            Feature class (3rd column in GTF/GFF3 file) to be used. All other
            features will be ignored.
        - name: id_attribute
          label: ID attribute
          type: basic:string
          default: gene_id
          allow_custom_choice: true
          choices:
            - label: gene_id
              value: gene_id
            - label: transcript_id
              value: transcript_id
            - label: ID
              value: ID
            - label: geneid
              value: geneid
          description: |
            GTF/GFF3 attribute to be used as feature ID. Several GTF/GFF3 lines
            with the same feature ID will be considered as parts of the same
            feature. The feature ID is used to identify the counts in the
            output table. In GTF files this is usually 'gene_id', in GFF3 files
            this is often 'ID', and 'transcript_id' is frequently a valid
            choice for both annotation formats.
  run:
    language: workflow
    program:
      - id: cutadapt
        run: cutadapt-corall-single
        input:
          reads: '{{ input.reads }}'
          options:
            quality_cutoff: '{{ input.cutadapt.quality_cutoff }}'
      - id: star
        run: alignment-star
        input:
          genome: '{{ input.star_index }}'
          reads: '{{ steps.cutadapt }}'
          filtering:
            outFilterType: BySJout
            outFilterMultimapNmax: 20
            outFilterMismatchNmax: 999
            outFilterMismatchNoverLmax: 0.6
          alignment:
            alignSJoverhangMin: 8
            alignSJDBoverhangMin: 1
            alignIntronMin: 20
            alignIntronMax: 1000000
            alignMatesGapMax: 1000000
          output_sam_bam:
            outSAMattributes: 'NH HI NM MD'
      - id: deduplication
        run: umi-tools-dedup
        input:
          alignment: '{{ steps.star }}'
      - id: quantification
        run: feature_counts
        input:
          alignment:
            aligned_reads: '{{ steps.deduplication }}'
            assay_type: 'forward'
          annotation:
            annotation: '{{ input.annotation }}'
            feature_class: '{{ input.quantification.feature_class }}'
            id_attribute: '{{ input.quantification.id_attribute }}'
      - id: downsampling
        run: seqtk-sample-single
        input:
          reads: '{{ steps.cutadapt }}'
          n_reads: '{{ input.downsampling.n_reads }}'
          advanced:
            seed: '{{ input.downsampling.seed }}'
            fraction: '{{ input.downsampling.fraction }}'
            two_pass: '{{ input.downsampling.two_pass }}'
      - id: alignment_qc_rrna
        run: alignment-star
        input:
          reads: '{{ steps.downsampling }}'
          genome: '{{ input.rrna_reference }}'
      - id: alignment_qc_globin
        run: alignment-star
        input:
          reads: '{{ steps.downsampling }}'
          genome: '{{ input.globin_reference }}'
      - id: idxstats
        run: samtools-idxstats
        input:
          alignment: '{{ steps.star }}'
      - id: multiqc
        run: multiqc
        input:
          data: '{{ [
            input.reads,
            steps.cutadapt,
            steps.star,
            steps.downsampling,
            steps.alignment_qc_rrna,
            steps.alignment_qc_globin,
            steps.idxstats,
            steps.quantification
            ] }}'


- slug: workflow-corall-paired
  name: "Cutadapt - STAR - StringTie (Corall, paired-end)"
  data_name: "{{ reads|sample_name|default('?') }}"
  requirements:
    expression-engine: jinja
  version: 3.0.1
  type: data:workflow:rnaseq:corall
  category: Pipeline
  description: |
    RNA-seq pipeline optimized for the Lexogen Corall Total RNA-Seq
    Library Prep Kit.

    UMI-sequences are extracted from the raw reads before the reads are
    trimmed and quality filtered using Cutadapt. Preprocessed reads are
    aligned by the STAR aligner and de-duplicated using UMI-tools.
    Gene abundance estimates are reported by the featureCounts tool.

    QC operates on downsampled reads and includes alignment of input
    reads to the rRNA/globin reference sequences. The reported alignment
    rate is used to asses the rRNA/globin sequence depletion rate.

    The analysis results and QC reports are summarized by the MultiQC.
  input:
    - name: reads
      label: Select sample(s)
      type: data:reads:fastq:paired
    - name: star_index
      label: Genome
      type: data:index:star
      description: |
        Genome index prepared by STAR aligner indexing tool.
    - name: annotation
      label: Annotation
      type: data:annotation
      description: |
        Genome annotation file (GTF).
    - name: rrna_reference
      label: Indexed rRNA reference sequence
      type: data:index:star
      description: |
        Reference sequence index prepared by STAR aligner indexing tool.
    - name: globin_reference
      label: Indexed Globin reference sequence
      type: data:index:star
      description: |
        Reference sequence index prepared by STAR aligner indexing tool.
    - name: show_advanced
      label: Show advanced parameters
      type: basic:boolean
      default: false
    - name: cutadapt
      label: Cutadapt filtering
      hidden: '!show_advanced'
      group:
        - name: quality_cutoff
          label: Reads quality cutoff
          type: basic:integer
          required: false
          description: |
            Trim low-quality bases from 3' end of each read before
            adapter removal. Use this option when processing the data
            generated by older Illumina machines. The use of this option
            will override the NextSeq/NovaSeq-specific trimming procedure
            which is enabled by default and is recommended for Illumina
            machines that utilize 2-color chemistry to encode the four
            bases.
    - name: downsampling
      label: Downsampling (Seqtk)
      hidden: '!show_advanced'
      group:
        - name: n_reads
          label: Number of reads
          type: basic:integer
          default: 1000000
        - name: seed
          label: Seed
          type: basic:integer
          default: 11
        - name: fraction
          label: Fraction
          type: basic:decimal
          required: false
          range: [0, 1.0]
          description: |
            Use the fraction of reads in range [0.0, 1.0] from the orignal input file instead
            of the absolute number of reads. If set, this will override the
            "Number of reads" input parameter.
        - name: two_pass
          label: 2-pass mode
          type: basic:boolean
          default: false
          description: |
            Enable two-pass mode when down-sampling. Two-pass mode is twice
            as slow but with much reduced memory.
    - name: quantification
      label: Quantification (featureCounts)
      hidden: '!show_advanced'
      group:
        - name: feature_class
          label: Feature class
          type: basic:string
          default: exon
          description: |
            Feature class (3rd column in GTF/GFF3 file) to be used. All other
            features will be ignored.
        - name: id_attribute
          label: ID attribute
          type: basic:string
          default: gene_id
          allow_custom_choice: true
          choices:
            - label: gene_id
              value: gene_id
            - label: transcript_id
              value: transcript_id
            - label: ID
              value: ID
            - label: geneid
              value: geneid
          description: |
            GTF/GFF3 attribute to be used as feature ID. Several GTF/GFF3 lines
            with the same feature ID will be considered as parts of the same
            feature. The feature ID is used to identify the counts in the
            output table. In GTF files this is usually 'gene_id', in GFF3 files
            this is often 'ID', and 'transcript_id' is frequently a valid
            choice for both annotation formats.
  run:
    language: workflow
    program:
      - id: cutadapt
        run: cutadapt-corall-paired
        input:
          reads: '{{ input.reads }}'
          options:
            quality_cutoff: '{{ input.cutadapt.quality_cutoff }}'
      - id: star
        run: alignment-star
        input:
          genome: '{{ input.star_index }}'
          reads: '{{ steps.cutadapt }}'
          filtering:
            outFilterType: BySJout
            outFilterMultimapNmax: 20
            outFilterMismatchNmax: 999
            outFilterMismatchNoverLmax: 0.6
          alignment:
            alignSJoverhangMin: 8
            alignSJDBoverhangMin: 1
            alignIntronMin: 20
            alignIntronMax: 1000000
            alignMatesGapMax: 1000000
          output_sam_bam:
            outSAMattributes: 'NH HI NM MD'
      - id: deduplication
        run: umi-tools-dedup
        input:
          alignment: '{{ steps.star }}'
      - id: quantification
        run: feature_counts
        input:
          alignment:
            aligned_reads: '{{ steps.deduplication }}'
            assay_type: 'forward'
          annotation:
            annotation: '{{ input.annotation }}'
            feature_class: '{{ input.quantification.feature_class }}'
            id_attribute: '{{ input.quantification.id_attribute }}'
      - id: downsampling
        run: seqtk-sample-paired
        input:
          reads: '{{ steps.cutadapt }}'
          n_reads: '{{ input.downsampling.n_reads }}'
          advanced:
            seed: '{{ input.downsampling.seed }}'
            fraction: '{{ input.downsampling.fraction }}'
            two_pass: '{{ input.downsampling.two_pass }}'
      - id: alignment_qc_rrna
        run: alignment-star
        input:
          reads: '{{ steps.downsampling }}'
          genome: '{{ input.rrna_reference }}'
      - id: alignment_qc_globin
        run: alignment-star
        input:
          reads: '{{ steps.downsampling }}'
          genome: '{{ input.globin_reference }}'
      - id: idxstats
        run: samtools-idxstats
        input:
          alignment: '{{ steps.star }}'
      - id: multiqc
        run: multiqc
        input:
          data: '{{ [
            input.reads,
            steps.cutadapt,
            steps.star,
            steps.downsampling,
            steps.alignment_qc_rrna,
            steps.alignment_qc_globin,
            steps.idxstats,
            steps.quantification
            ] }}'
