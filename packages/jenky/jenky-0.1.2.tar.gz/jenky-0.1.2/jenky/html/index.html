<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jenky</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, td, th {
            border: 1px solid black;
        }

        td, th {
            padding: 1ex;
        }

        tbody tr:hover {
          background-color: #ffff99;
        }

        fieldset {
            margin-top: 1em;
        }

        .grid-container {
            margin-top: 1ex;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0 1em;
        }

    </style>
</head>
<body>
<div>
    <h1 id="appName" style="display: inline-block"></h1><a href="/docs">OpenAPI Spec</a>
</div>
<table>
    <thead>
    <tr>
        <th>Repo Name</th>
        <th>Git Actions</th>
        <th>Process Name</th>
        <th>Start Time</th>
        <th>Action</th>
        <th>Logs</th>
    </tr>
    </thead>
    <tbody id="repos"></tbody>
</table>

<template id="processRow">
    <tr>
        <td>Repo Name</td>
        <td><label><input type="radio" name="process"></label></td>
        <td>Process Name</td>
        <td>Start Time</td>
        <td>
            <label style="display: inline-block"><input type="radio" name="status" value="start">Start</label>
            <label style="display: inline-block"><input type="radio" name="status" value="transition" disabled>Provisioning</label>
            <label style="display: inline-block"><input type="radio" name="status" value="stop">Stop</label>
        </td>
        <td>
            <a href="" target="">stdout</a>
            <!-- <a href="" target="">stderr</a> -->
        </td>
    </tr>
</template>

<fieldset>
    <legend>Git Actions</legend>
    <form>
        <div>
            <!--<button id="fetch" type="button">Fetch â­¯</button>-->
            <button id="checkout" type="button">checkout</button>
            <code id="repoName"></code> current tag is <code id="gitRef"></code>
        </div>
        <div class="grid-container">
            <div>
                <label for="gitRefs"></label>
                <select id="gitRefs" size=40></select>
            </div>
            <pre id="gitMessage" style="margin-top:0; background-color: azure;"></pre>
        </div>
    </form>
</fieldset>

</body>
<script type="module">
    /** @type{jenky.Repo[]} */
    let repos;
    /** @type{Object.<string, jenky.Repo>} */
    let reposByName ={};
    const gitMessageElem = document.getElementById('gitMessage');

    class ConcernedFaceIterator {
        constructor() {
            this.faces = [];
            for (const face of "ðŸ˜•ðŸ˜ŸðŸ˜¯ðŸ˜²ðŸ˜³ðŸ¥ºðŸ˜¦ðŸ˜§ðŸ˜¨ðŸ˜°ðŸ˜¥ðŸ˜¢ðŸ˜­ðŸ˜±ðŸ˜–ðŸ˜£ðŸ˜žðŸ˜¤ðŸ˜¡â˜ ") this.faces.push(face);
        }

        next() {
            const face = this.faces.shift();
            this.faces.push(face);
            return face;
        }
    }

    const concernedFaceIterator = new ConcernedFaceIterator();

    /**
     */
    function renderRepos() {
        const tbody = document.getElementById('repos');
        tbody.textContent = '';
        const template = document.getElementById('processRow');
        for (const repo of repos) {
            const name = repo.repoName;
            for (const [index, proc] of repo.processes.entries()) {
                let tr = template.content.firstElementChild.cloneNode(true);
                let td = tr.firstElementChild;
                if (repo.remoteUrl) {
                    td.textContent = '';
                    const a = document.createElement('a');
                    a.href = repo.remoteUrl;
                    a.textContent = repo.repoName;
                    td.appendChild(a);
                } else {
                    td.textContent = repo.repoName;
                }

                td = td.nextElementSibling;
                if ( index === 0) {
                    td.firstElementChild.value = repo.repoName;
                    td.firstElementChild.addEventListener('change', () => {
                        fetchRepo(name)
                            .then(repo => {
                                reposByName[name] = repo;
                                renderRepo(name);
                            })
                    });
                } else {
                    // Have only ONE radio button per repo!
                    td.textContent = '';
                }

                td = td.nextElementSibling;
                if (proc.serviceUrl) {
                    td.textContent = '';
                    const a = document.createElement('a');
                    a.href = proc.serviceUrl;
                    a.textContent = proc.name;
                    td.appendChild(a);
                } else {
                    td.textContent = proc.name;
                }

                td = td.nextElementSibling;
                td.textContent = proc.createTime ? new Date(proc.createTime * 1000).toISOString() : '';

                td = td.nextElementSibling;   // Status
                let transition;
                for (const input of td.querySelectorAll('input')) {
                    input.name = proc.name + '_status';
                    if (input.value === 'start') input.checked = proc.running;
                    else if (input.value === 'stop') input.checked = !proc.running;
                    else transition = input;
                    input.addEventListener('change', (evt) => {
                        const targetValue = evt.target.value;
                        transition.checked = true;
                        if (targetValue === 'stop') {
                            kill(evt, repo, proc);
                        } else if (targetValue === 'start') {
                            restart(evt, repo, proc);
                        } else {
                            console.assert(false)
                        }
                    });
                }

                td = td.nextElementSibling;
                let a = td.firstElementChild;
                while (a) {
                    const std = a.textContent;
                    a.href = `/repos/${name}/processes/${proc.name}/${std}`;
                    a.target = `${proc.name}_${std}`;
                    a = a.nextElementSibling;
                }

                tbody.appendChild(tr);
            }
        }
    }

    /**
     * @param {string} repoName
     */
    function renderRepo(repoName) {
        /** @type{HTMLSelectElement} */
        const select = /** @type{HTMLSelectElement} */ document.getElementById('gitRefs');
        /** @type{jenky.Repo} */
        const repo = reposByName[repoName];
        select.oninput = evt => console.log(evt);
        //document.getElementById('fetch').onclick = () => fetchRepo(repoName);
        document.getElementById('checkout').onclick = () => {
            if (!select.value) {
                gitMessageElem.textContent = concernedFaceIterator.next() + 'Please select tag or branch';
            } else {
                gitCheckout(repo, select.value);
            }
        };

        document.getElementById('repoName').textContent = repoName;
        document.getElementById('gitRef').textContent = repo.gitRef;
        gitMessageElem.textContent = repo.gitMessage;

        select.textContent = '';
        for (const ref of repo.gitRefs) {
            const option = document.createElement('option');
            option.textContent = ref.creatorDate + ' ' + ref.refName;
            option.value = ref.refName;
            select.appendChild(option);
        }
    }

    /**
     * @param {jenky.Repo[]} data
     */
    function setRepos(data) {
        repos = data;
        reposByName = {};
        for (const repo of repos) {
            reposByName[repo.repoName] = repo;
        }
    }

    /**
     * @param {Event} evt
     * @param {jenky.Repo} repo
     * @param {jenky.Process} proc
     */
    function kill(evt, repo, proc) {
        evt.target.disabled = true;
        changeProcessState(repo, proc, 'kill');
    }

    /**
     * @param {Event} evt
     * @param {jenky.Repo} repo
     * @param {jenky.Process} proc
     */
    function restart(evt, repo, proc) {
        evt.target.disabled = true;
        changeProcessState(repo, proc, 'restart');
    }

    /**
     * @param {jenky.Repo} repo
     * @param {string} gitRef
     */
    function gitCheckout(repo, gitRef) {
        const payload = {action: 'checkout', gitRef: gitRef};

        gitMessageElem.textContent = 'Loading...';
        fetch(`/repos/${repo.repoName}`, {method: 'post', body: JSON.stringify(payload)})
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    gitMessageElem.textContent = concernedFaceIterator.next() + response.statusText + ' ' + response.url;
                }
            })
            .then(data => {
                gitMessageElem.textContent = data['message'];
                repo.gitRef = gitRef;
            })
    }

    function fetchRepo(repoName) {
        return fetch(`/repos/${repoName}`)
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    gitMessageElem.textContent = concernedFaceIterator.next() + response.statusText;
                }
            })
    }

    /**
     * @param {jenky.Repo} repo
     * @param {jenky.Process} proc
     * @param {string} action
     */
    function changeProcessState(repo, proc, action) {
        const payload = {action: action};
        fetch(`/repos/${repo.repoName}/processes/${proc.name}`, {method: 'post', body: JSON.stringify(payload)})
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    console.log(response.statusText + ' ' + response.url);
                    response.text().then(text => alert(text))
                }
            })
            .then(data => console.log(data))
            .then(fetchRepos)
    }


    function fetchRepos() {
        fetch('/repos')
            .then(response => response.json())
            .then(data => {
                document.getElementById('appName').textContent = data['appName'];
                setRepos(data['repos']);
                renderRepos();
            })
    }

    fetchRepos()
</script>
</html>
